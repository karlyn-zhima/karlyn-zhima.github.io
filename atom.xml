<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>zhima ã® blog</title>
  
  
  <link href="https://www.karlyn.xyz/atom.xml" rel="self"/>
  
  <link href="https://www.karlyn.xyz/"/>
  <updated>2025-03-31T16:14:11.278Z</updated>
  <id>https://www.karlyn.xyz/</id>
  
  <author>
    <name>karlyn</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>é€šè¿‡Canalè®¢é˜…binlogè‡ªåŠ¨æ›´æ–°Redis</title>
    <link href="https://www.karlyn.xyz/posts/canal_binlog.html"/>
    <id>https://www.karlyn.xyz/posts/canal_binlog.html</id>
    <published>2025-03-31T16:08:49.000Z</published>
    <updated>2025-03-31T16:14:11.278Z</updated>
    
    <content type="html"><![CDATA[<h1>å†™åœ¨å‰é¢</h1><p>è¿™æ˜¯æˆ‘æ‰©å……æˆ‘çš„é¡¹ç›®çš„ä¸€ä¸ªç‚¹ï¼Œæœ‰ç‚¹æ‘¸ç€çŸ³å¤´è¿‡æ²³çš„æ„æ€ï¼Œå¯èƒ½å¾ˆå¤šæ€è·¯ä¹Ÿä¸å¤Ÿä¼ä¸šåŒ–ï¼Œç„¶åæŠ€æœ¯é€‰å‹ä»€ä¹ˆçš„ä¹Ÿä¸å¤Ÿæ­£ç¡®ã€‚</p><h1>MySQLå¼€å¯binlogå¹¶ä¸”è®¾å®šä¸ºRAWæ¨¡å¼</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like&#x27;%log_bin%&#x27;;</span><br><span class="line">+---------------------------------+-----------------------------+</span><br><span class="line">| Variable_name                   | Value                       |</span><br><span class="line">+---------------------------------+-----------------------------+</span><br><span class="line">| log_bin                         | ON                          |</span><br><span class="line">| log_bin_basename                | /var/lib/mysql/binlog       |</span><br><span class="line">| log_bin_index                   | /var/lib/mysql/binlog.index |</span><br><span class="line">| log_bin_trust_function_creators | OFF                         |</span><br><span class="line">| log_bin_use_v1_row_events       | OFF                         |</span><br><span class="line">| sql_log_bin                     | ON                          |</span><br><span class="line">+---------------------------------+-----------------------------+</span><br><span class="line">6 rows in set (0.03 sec)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ç®€å•çœ‹äº†ä¸€ä¸‹æˆ‘çš„åº“ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆæ˜¯è‡ªå·±å¼€å¯çš„ï¼Œä½†æ˜¯è¿˜æ˜¯å‡†å¤‡å»é…ç½®æ–‡ä»¶çœ‹ä¸€çœ¼æ˜¯ä¸æ˜¯é…ç½®äº†server_id</p><p>è¿™é‡Œè¿›å»</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/etc/my</span>sql<span class="comment"># vi my.cnf</span></span><br></pre></td></tr></table></figure><p>åŠ ä¸€ä¸‹é…ç½®å¼€å¯binlogå°±è¡Œäº†<br>ä»¤äººçƒ¦èºæ—¶çš„æˆ‘50å—çš„äº¬ä¸œäº‘æœåŠ¡å™¨çš„2Gå†…å­˜å¿«è¦é¡¶ä¸ä½å‹åŠ›äº†ï¼šï¼‰</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># å¼€å¯ binlog</span></span><br><span class="line"><span class="attr">log-bin</span> = /var/log/mysql/mysql-bin.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½® server-idï¼ˆæ¯ä¸ª MySQL å®ä¾‹å¿…é¡»å”¯ä¸€ï¼‰</span></span><br><span class="line"><span class="attr">server-id</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯é€‰ï¼šè®¾ç½® binlog æ ¼å¼ï¼ˆROW æ˜¯æ¨èçš„æ ¼å¼ï¼‰</span></span><br><span class="line"><span class="attr">binlog_format</span> = ROW</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯é€‰ï¼šè®¾ç½® binlog è¿‡æœŸæ—¶é—´ï¼ˆå•ä½ä¸ºå¤©ï¼‰</span></span><br><span class="line"><span class="attr">expire_logs_days</span> = <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯é€‰ï¼šé™åˆ¶ binlog æ–‡ä»¶å¤§å°ï¼ˆå•ä½ä¸ºå­—èŠ‚ï¼Œé»˜è®¤å€¼ä¸º 1GBï¼‰</span></span><br><span class="line"><span class="attr">max_binlog_size</span> = <span class="number">100</span>M</span><br></pre></td></tr></table></figure><h1>Canalä¸‹è½½å¹¶é…ç½®</h1><p>ç„¶åæ˜¯ä¸‹è½½Canalï¼ŒæŠ€æœ¯é€‰å‹æ–¹é¢ï¼Œå…¶å®æˆ‘èƒ½é€‰æ‹©çš„ä¸å¤ªå¤šï¼Œä¸»è¦å°±æ˜¯Canal å’Œ Debeziumã€‚</p><p>æˆ‘é€‰æ‹©Canalçš„åŸå› å¤§æŠµå¦‚ä¸‹ï¼š</p><p>è½»é‡çº§ï¼šCanalä¸“æ³¨äº MySQL æ•°æ®åº“çš„ CDCï¼Œæ¶æ„ç›¸å¯¹ç®€å•ï¼Œæ›´åŠ è½»é‡åŒ–ã€‚</p><p>ç‹¬ç«‹äº Kafkaï¼šä¸åƒ Debeziumä¸€æ ·ï¼Œæœ€åˆä¸“ä¸ºKafkaè®¾è®¡ã€‚</p><p>æ˜“äºéƒ¨ç½²ï¼šCanal çš„éƒ¨ç½²ç›¸å¯¹ç®€å•ï¼Œå°¤å…¶æ˜¯å¯¹å•ä¸€æ•°æ®åº“çš„ç›‘å¬ã€</p><p>ä¸‹è½½ç„¶åä¸€é”®tar-zxfä¹‹åè¿›è¡Œä¸€ä¸‹ç®€å•çš„é…ç½®ï¼Œåœ¨æä¾›çš„æ ·ä¾‹é‡Œä¿®æ”¹ã€‚</p><h2 id="ä¿®æ”¹conf-example-instance-properties">ä¿®æ”¹conf/example/instance.properties</h2><h2 id="mysql-serverId">mysql serverId</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">canal.instance.mysql.slaveId</span> = <span class="number">100</span></span><br><span class="line"><span class="comment">## è¿™ä¸ªè¦å’Œæ•°æ®åº“çš„server-idä¸ç›¸åŒ</span></span><br><span class="line"><span class="attr">canal.instance.master.address</span> = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">3306</span> </span><br><span class="line"><span class="attr">canal.instance.dbUsername</span> = zhima  </span><br><span class="line"><span class="attr">canal.instance.dbPassword</span> = ********</span><br></pre></td></tr></table></figure><p>é…ç½®å®Œä¹‹åå¯ä»¥è‡ªå·±å…ˆå¯åŠ¨ä¸€ä¸‹ï¼Œå°±å¾ˆç®€å•ï¼Œbash /bin/startup.sh</p><p>ç„¶åç¨å¾®ä¿®æ”¹ä¸€ä¸‹æ•°æ®åº“ä¸­çš„ä¸€è¡Œï¼Œä¹‹åçœ‹ä¸€ä¸‹exampleè¾“å‡ºçš„æ—¥å¿—</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2025-03-31 22:00:50.725 [destination = example , address = /127.0.0.1:3306 , EventParser] ERROR com.alibaba.otter.canal.common.alarm.LogAlarmHandler - destination:example[com.alibaba.otter.canal.parse.exception.CanalParseException: java.io.IOException: connect /127.0.0.1:3306 failure</span><br><span class="line">Caused by: java.io.IOException: connect /127.0.0.1:3306 failure</span><br><span class="line">    at com.alibaba.otter.canal.parse.driver.mysql.MysqlConnector.connect(MysqlConnector.java:85)</span><br><span class="line">    at com.alibaba.otter.canal.parse.inbound.mysql.MysqlConnection.connect(MysqlConnection.java:104)</span><br><span class="line">    at com.alibaba.otter.canal.parse.inbound.mysql.MysqlEventParser.preDump(MysqlEventParser.java:89)</span><br><span class="line">    at com.alibaba.otter.canal.parse.inbound.AbstractEventParser$1.run(AbstractEventParser.java:171)</span><br><span class="line">    at java.lang.Thread.run(Thread.java:750)</span><br><span class="line">Caused by: java.io.IOException: Error When doing Client Authentication:ErrorPacket [errorNumber=1698, fieldCount=-1, message=Access denied for user &#x27;root&#x27;@&#x27;localhost&#x27;, sqlState=28000, sqlStateMarker=#]</span><br><span class="line">    at com.alibaba.otter.canal.parse.driver.mysql.MysqlConnector.negotiate(MysqlConnector.java:325)</span><br><span class="line">    at com.alibaba.otter.canal.parse.driver.mysql.MysqlConnector.connect(MysqlConnector.java:81)</span><br><span class="line">    ... 4 more</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>å¦‚æœåƒè¿™æ ·ä¸€èˆ¬æ˜¯é…ç½®æœ‰é—®é¢˜æ²¡è¿ä¸Šï¼Œä¿®æ”¹ä¸€ä¸‹å°±è¡Œï¼Œä¹‹åæˆåŠŸè¿ä¸Šä¹‹åå°±å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªå®¢æˆ·ç«¯æ¥è¿›è¡Œè°ƒç”¨å•¦ï¼Œä¸‹é¢è¿™æ®µä»£ç ç”¨æ¥æµ‹è¯•å°±å¾ˆåˆé€‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.karlyn.dogie;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnector;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnectors;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.*;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.Message;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleCanalClientExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è¿æ¥ä¿¡æ¯é…ç½®</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">hostname</span> <span class="operator">=</span> <span class="string">&quot;*.*.*.*&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">11111</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">destination</span> <span class="operator">=</span> <span class="string">&quot;example&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºé“¾æ¥</span></span><br><span class="line">        <span class="type">CanalConnector</span> <span class="variable">connector</span> <span class="operator">=</span> CanalConnectors.newSingleConnector(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(hostname, port), destination, username, password</span><br><span class="line">        );</span><br><span class="line">        System.out.println(<span class="string">&quot;è¿æ¥åˆ›ç«‹æˆåŠŸ&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">batchSize</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connector.connect();</span><br><span class="line">            connector.subscribe(<span class="string">&quot;.*\\..*&quot;</span>);</span><br><span class="line">            connector.rollback();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> connector.getWithoutAck(batchSize); <span class="comment">// è·å–æŒ‡å®šæ•°é‡çš„æ•°æ®</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">batchId</span> <span class="operator">=</span> message.getId();</span><br><span class="line">                <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> message.getEntries().size();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// æ²¡æœ‰æ‹¿åˆ°æ•°æ®</span></span><br><span class="line">                <span class="keyword">if</span> (batchId == -<span class="number">1</span> || size == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.printf(<span class="string">&quot;message[batchId=%s, size=%s] \n&quot;</span>, batchId, size);</span><br><span class="line">                    printEntry(message.getEntries());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                connector.ack(batchId); <span class="comment">// æäº¤ç¡®è®¤</span></span><br><span class="line">                <span class="comment">// connector.rollback(batchId); // å¤„ç†å¤±è´¥, å›æ»šæ•°æ®</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            connector.disconnect();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printEntry</span><span class="params">(List&lt;Entry&gt; entries)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Entry entry : entries) &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry.getEntryType() == EntryType.TRANSACTIONBEGIN || entry.getEntryType() == EntryType.TRANSACTIONEND) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">RowChange</span> <span class="variable">rowChange</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                rowChange = RowChange.parseFrom(entry.getStoreValue());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ERROR ## parser of eromanga-event has an error , data:&quot;</span> + entry.toString(),</span><br><span class="line">                        e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">EventType</span> <span class="variable">eventType</span> <span class="operator">=</span> rowChange.getEventType();</span><br><span class="line">            System.out.println(String.format(<span class="string">&quot;binlog[%s:%s] , name[%s,%s] , eventType : %s&quot;</span>,</span><br><span class="line">                    entry.getHeader().getLogfileName(),</span><br><span class="line">                    entry.getHeader().getLogfileOffset(),</span><br><span class="line">                    entry.getHeader().getSchemaName(),</span><br><span class="line">                    entry.getHeader().getTableName(),</span><br><span class="line">                    eventType));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ•°æ®å˜åŒ–</span></span><br><span class="line">            <span class="keyword">for</span> (RowData rowData : rowChange.getRowDatasList()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (eventType == EventType.DELETE) &#123;</span><br><span class="line">                    printColumn(rowData.getBeforeColumnsList());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (eventType == EventType.INSERT) &#123;</span><br><span class="line">                    printColumn(rowData.getAfterColumnsList());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    printColumn(rowData.getAfterColumnsList());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printColumn</span><span class="params">(List&lt;Column&gt; columns)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Column column : columns) &#123;</span><br><span class="line">            System.out.println(column.getName() + <span class="string">&quot; : &quot;</span> + column.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åå¼€å§‹å’Œæ¶ˆæ¯é˜Ÿåˆ—å’ŒSpringbootæ•´åˆå•¦</p><h2 id="ä¿®æ”¹canalé…ç½®canal-properties">ä¿®æ”¹canalé…ç½®canal.properties</h2><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">canal.serverMode = rabbitMQ</span><br><span class="line"></span><br><span class="line">##################################################</span><br><span class="line">#########           RabbitMQ         #############</span><br><span class="line">##################################################</span><br><span class="line">rabbitmq.host = <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">rabbitmq.virtual.host = /</span><br><span class="line">rabbitmq.exchange = canal-exchange</span><br><span class="line">rabbitmq.username = root</span><br><span class="line">rabbitmq.password = <span class="number">123456</span></span><br></pre></td></tr></table></figure><p>åŒæ—¶ç»§ç»­ä¿®æ”¹instance.properties</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mq config</span></span><br><span class="line"><span class="comment"># canal.mq.topic=example</span></span><br><span class="line"><span class="attr">canal.mq.topic</span>=canal-routing-key</span><br></pre></td></tr></table></figure><p>ç„¶åé‡å¯canalæœåŠ¡</p><h1>Springbooté›†æˆ</h1><p>æ¶ˆæ¯è®¢é˜…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.karlyn.dogie.Canal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.DirectExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CanalProvider</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">canalQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * durable:æ˜¯å¦æŒä¹…åŒ–ï¼Œé»˜è®¤falseï¼ŒæŒä¹…åŒ–é˜Ÿåˆ—ï¼šä¼šè¢«å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œå½“æ¶ˆæ¯ä»£ç†é‡å¯æ—¶ä»ç„¶å­˜åœ¨ï¼›æš‚å­˜é˜Ÿåˆ—ï¼šå½“å‰è¿æ¥æœ‰æ•ˆ</span></span><br><span class="line"><span class="comment">         * exclusive:é»˜è®¤ä¸ºfalseï¼Œåªèƒ½è¢«å½“å‰åˆ›å»ºçš„è¿æ¥ä½¿ç”¨ï¼Œè€Œä¸”å½“è¿æ¥å…³é—­åé˜Ÿåˆ—å³è¢«åˆ é™¤ã€‚æ­¤å‚è€ƒä¼˜å…ˆçº§é«˜äºdurable</span></span><br><span class="line"><span class="comment">         * autoDelete:æ˜¯å¦è‡ªåŠ¨åˆ é™¤ï¼Œå½“æ²¡æœ‰ç”Ÿäº§è€…æˆ–è€…æ¶ˆè´¹è€…ä½¿ç”¨æ­¤é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—ä¼šè‡ªåŠ¨åˆ é™¤</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(RabbitConstant.CanalQueue, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * äº¤æ¢æœºï¼Œè¿™é‡Œä½¿ç”¨ç›´è¿äº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    DirectExchange <span class="title function_">canalExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(RabbitConstant.CanalExchange, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç»‘å®šäº¤æ¢æœºå’Œé˜Ÿåˆ—ï¼Œå¹¶è®¾ç½®åŒ¹é…é”®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Binding <span class="title function_">bindingCanal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(canalQueue()).to(canalExchange()).with(RabbitConstant.CanalRouting);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¶ˆæ¯æ¶ˆè´¹ï¼Œæˆ‘è¿™é‡Œå†™çš„æ¯”è¾ƒç®€å•ï¼Œå¦‚æœæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥ä¹‹åæˆ‘ä¼šæŠŠå®ƒé‡æ–°æ”¾å›æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½†æ˜¯è¿™æ—¶å€™æ¶ˆæ¯é˜Ÿåˆ—ä¼šä¸€ç›´æŠŠè¿™ä¸ªæ¶ˆæ¯å‘ç»™æ¶ˆè´¹è€…ï¼Œæ‰€ä»¥è¿™å—è¿˜éœ€è¦ä¼˜åŒ–ä¸€ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.karlyn.dogie.Canal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.type.TypeReference;</span><br><span class="line"><span class="keyword">import</span> com.karlyn.dogie.entity.enums.UserContactStatusEnum;</span><br><span class="line"><span class="keyword">import</span> com.karlyn.dogie.entity.po.UserContact;</span><br><span class="line"><span class="keyword">import</span> com.karlyn.dogie.entity.query.UserContactQuery;</span><br><span class="line"><span class="keyword">import</span> com.karlyn.dogie.mappers.UserContactMapper;</span><br><span class="line"><span class="keyword">import</span> com.karlyn.dogie.redis.RedisComponent;</span><br><span class="line"><span class="keyword">import</span> com.karlyn.dogie.util.JsonUtils;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.support.AmqpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.handler.annotation.Header;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Canalæ¶ˆæ¯æ¶ˆè´¹è€…</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = RabbitConstant.CanalQueue)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CanalConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserContactMapper userContactMapper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisComponent redisComponent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CanalConsumer</span><span class="params">(UserContactMapper userContactMapper, RedisComponent redisComponent)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userContactMapper = userContactMapper;</span><br><span class="line">        <span class="built_in">this</span>.redisComponent = redisComponent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Listener</span><span class="params">(String message, Channel channel, <span class="meta">@Header(AmqpHeaders.DELIVERY_TAG)</span> <span class="type">long</span> tag)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ”¶åˆ°canalæ¶ˆæ¯ï¼š&quot;</span> + message);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        Map&lt;String, Object&gt; msg = objectMapper.readValue(message,<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, Object&gt;&gt;() &#123;&#125;);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isDdl</span> <span class="operator">=</span> (<span class="type">boolean</span>) msg.get(<span class="string">&quot;isDdl&quot;</span>);</span><br><span class="line">        <span class="comment">// ä¸å¤„ç†DDLäº‹ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (isDdl) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">database</span> <span class="operator">=</span> (String) msg.get(<span class="string">&quot;database&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">table</span> <span class="operator">=</span> (String) msg.get(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> (String) msg.get(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">        List&lt;LinkedHashMap&gt; data = (List&lt;LinkedHashMap&gt;) msg.get(<span class="string">&quot;data&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(database.equals(<span class="string">&quot;dogie&quot;</span>)&amp;&amp;table.equals(<span class="string">&quot;user_contact&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (LinkedHashMap s : data) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">UserId</span> <span class="operator">=</span> (String) s.get(<span class="string">&quot;user_id&quot;</span>);</span><br><span class="line">                    log.info(<span class="string">&quot;æ›´æ–°&#123;&#125;çš„è”ç³»äººç¼“å­˜&quot;</span>,UserId);</span><br><span class="line">                    <span class="type">UserContactQuery</span> <span class="variable">userContactQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserContactQuery</span>();</span><br><span class="line">                    userContactQuery.setUserId(UserId);</span><br><span class="line">                    userContactQuery.setStatus(UserContactStatusEnum.FRIEND.getStatus());</span><br><span class="line">                    List&lt;UserContact&gt; userContactList = <span class="built_in">this</span>.userContactMapper.selectList(userContactQuery);</span><br><span class="line">                    List&lt;String&gt; contactIds = userContactList.stream().map(item-&gt;item.getContactId()).collect(Collectors.toList());</span><br><span class="line">                    <span class="built_in">this</span>.redisComponent.cleanUserContact(UserId);</span><br><span class="line">                    <span class="keyword">if</span>(!contactIds.isEmpty())&#123;</span><br><span class="line">                        <span class="built_in">this</span>.redisComponent.addUserContactBatch(UserId, contactIds);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                channel.basicAck(tag,<span class="literal">false</span>);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                System.out.println(e.getMessage());</span><br><span class="line">                channel.basicNack(tag,<span class="literal">false</span>,<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;å†™åœ¨å‰é¢&lt;/h1&gt;
&lt;p&gt;è¿™æ˜¯æˆ‘æ‰©å……æˆ‘çš„é¡¹ç›®çš„ä¸€ä¸ªç‚¹ï¼Œæœ‰ç‚¹æ‘¸ç€çŸ³å¤´è¿‡æ²³çš„æ„æ€ï¼Œå¯èƒ½å¾ˆå¤šæ€è·¯ä¹Ÿä¸å¤Ÿä¼ä¸šåŒ–ï¼Œç„¶åæŠ€æœ¯é€‰å‹ä»€ä¹ˆçš„ä¹Ÿä¸å¤Ÿæ­£ç¡®ã€‚&lt;/p&gt;
&lt;h1&gt;MySQLå¼€å¯binlogå¹¶ä¸”è®¾å®šä¸ºRAWæ¨¡å¼&lt;/h1&gt;
&lt;figure class=&quot;highlight plaint</summary>
      
    
    
    
    <category term="é¡¹ç›®" scheme="https://www.karlyn.xyz/categories/%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="Java" scheme="https://www.karlyn.xyz/tags/Java/"/>
    
    <category term="æ¶ˆæ¯é˜Ÿåˆ—" scheme="https://www.karlyn.xyz/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
    <category term="Canal" scheme="https://www.karlyn.xyz/tags/Canal/"/>
    
    <category term="binlog" scheme="https://www.karlyn.xyz/tags/binlog/"/>
    
  </entry>
  
  <entry>
    <title>å…³äºå¤šçº¿ç¨‹çš„ä¸€äº›å®éªŒ</title>
    <link href="https://www.karlyn.xyz/posts/thread.html"/>
    <id>https://www.karlyn.xyz/posts/thread.html</id>
    <published>2025-03-30T11:13:02.000Z</published>
    <updated>2025-03-30T15:14:17.581Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>éƒ½æ˜¯åšçš„æ¯”è¾ƒæµ…æ˜¾çš„ä¸€äº›å®éªŒï¼Œå¾ˆå¤šé—®é¢˜æ¥è‡ªäºå°æ—codingï¼Œå¾ˆå¤šå†…å®¹å…¶å®æŒºå…«è‚¡çš„ï¼Œä½†æ˜¯æˆ‘çš„è®°å¿†å¶å°”ä¼šå¸¦æœ‰ä¸€äº›å†…å­˜ç‰¹æ€§ï¼Œå…³æœºå°±å¿˜äº†ï¼Œæ‰€ä»¥ç°åœ¨æƒ³åŠæ³•é€šè¿‡ä¸€ç‚¹å®éªŒå’Œæ‰‹æ•²ä»£ç è½ä¸€ä¸‹ç›˜ã€‚</p><h1 id="æ­£å¼å†…å®¹"><a href="#æ­£å¼å†…å®¹" class="headerlink" title="æ­£å¼å†…å®¹"></a>æ­£å¼å†…å®¹</h1><h2 id="çº¿ç¨‹"><a href="#çº¿ç¨‹" class="headerlink" title="çº¿ç¨‹"></a>çº¿ç¨‹</h2><h3 id="è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«"><a href="#è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«" class="headerlink" title="è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«"></a>è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«</h3><p>çº¿ç¨‹å’Œè¿›ç¨‹çš„åŒºåˆ«ï¼Œè¿™ä¸ªé—®é¢˜åœ¨å¾ˆå¤šåœ°æ–¹éƒ½ä¼šé‡åˆ°ï¼Œæ— è®ºæ˜¯åœ¨æ“ä½œç³»ç»Ÿè¿˜æ˜¯åœ¨Javaå¤šçº¿ç¨‹ã€‚</p><p>å…¶å®ä¸¤è€…æœ€å¤§çš„åŒºåˆ«å°±æ˜¯æ˜¯å¦äº«æœ‰ç‹¬ç«‹çš„æ‰§è¡Œç¯å¢ƒã€‚</p><p>æˆ‘ä»¬ä»¥Javaä¸¾ä¾‹ï¼ŒJVMçš„è¿è¡Œæ—¶å†…å­˜ä¸»è¦åŒ…æ‹¬è¿™æ ·äº”å—ï¼š</p><ol><li>è™šæ‹Ÿæœºæ ˆ</li><li>å †ï¼ˆå¸¸é‡æ± ä»€ä¹ˆçš„å…¶å®ä¹Ÿåœ¨å †é‡Œï¼‰</li><li>å…ƒç©ºé—´</li><li>æœ¬åœ°æ–¹æ³•æ ˆ(Native)</li><li>ç¨‹åºè®¡æ•°å™¨</li></ol><p>ä¸€ä¸ªè¿›ç¨‹ä¼šç‹¬ç«‹çš„äº«æœ‰è¿™å…¨éƒ¨çš„äº”ä¸ªè¿è¡Œæ—¶ç¯å¢ƒï¼Œè€Œçº¿ç¨‹åˆ™ä¸æ˜¯ï¼Œä¸€ä¸ªè¿›ç¨‹åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹ä¼šè·å¾—è‡ªå·±ç‹¬ç«‹çš„è™šæ‹Ÿæœºæ ˆã€ç¨‹åºè®¡æ•°å™¨ï¼Œå¯¹äºä»»æ„è¯¥è¿›ç¨‹åˆ›å»ºçš„çº¿ç¨‹ï¼Œå…¶ä½™ä¸‰è€…éƒ½æ˜¯å…±ç”¨çš„ã€‚</p><p>ä¸¾ä¸ªğŸŒ°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SleepTry</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException &#123;</span><br><span class="line">      <span class="comment">//è¿™ä¸ªStringBuilderæ˜¯åˆ›å»ºåœ¨è¿›ç¨‹å †ä¸Šçš„ï¼Œæ‰€ä»¥ä»–æ˜¯ä¼šè¢«å…±äº«çš„ï¼Œåˆ›å»ºçº¿ç¨‹çš„æ—¶å€™ä¼šæ‹·è´ä¸€ä¸ªå¼•ç”¨å‰¯æœ¬</span></span><br><span class="line">      <span class="comment">//æ‰€ä»¥ä»»ä½•çº¿ç¨‹éƒ½å¯ä»¥æ“ä½œå¹¶ä¿®æ”¹ä»–ï¼Œä¿®æ”¹çš„å¹¶ä¸æ˜¯çº¿ç¨‹è‡ªå·±åˆ›å»ºçš„ï¼Œè€Œæ˜¯è¿›ç¨‹æ‰€åˆ›å»ºçš„</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        BlockingQueue&lt;Runnable&gt; bq =<span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;();</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">5</span>,<span class="number">10</span>,<span class="number">1000L</span>, TimeUnit.SECONDS,bq);</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">task2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (sb)&#123;</span><br><span class="line">                    sb.append(<span class="string">&quot;I am Thread2\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Future&lt;?&gt; feature2 =  threadPoolExecutor.submit(task2);</span><br><span class="line">        feature2.get();</span><br><span class="line">        System.out.println(sb.toString());</span><br><span class="line">        threadPoolExecutor.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶æ¬¡ï¼Œçº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿè¿ç®—è°ƒåº¦çš„æœ€å°å•ä½ï¼Œå› ä¸ºçº¿ç¨‹ä¹‹é—´çš„èµ„æºå…±äº«æ€§è´¨ï¼Œå¯¼è‡´å®ƒçš„ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€æ›´å°ã€‚åŒæ—¶ï¼Œä»–ä»¬å¯ä»¥é€šè¿‡è®¿é—®å…¨å±€å˜é‡æˆ–è€…é™æ€å˜é‡æ¥é€šä¿¡ã€‚</p><p>è¿›ç¨‹çš„åˆ›å»ºå’Œé”€æ¯éœ€è¦åˆ›å»ºå’Œé”€æ¯ä¸Šè¿°çš„å…¨éƒ¨èµ„æºï¼Œè€Œè¿›ç¨‹åªéœ€è¦åˆ›å»ºå’Œé”€æ¯ç¨‹åºè®¡æ•°å™¨å’Œå¯¹åº”çš„è¿è¡Œæ—¶æ ˆå³å¯ã€‚</p><h3 id="çº¿ç¨‹çš„åˆ›å»º"><a href="#çº¿ç¨‹çš„åˆ›å»º" class="headerlink" title="çº¿ç¨‹çš„åˆ›å»º"></a>çº¿ç¨‹çš„åˆ›å»º</h3><p>å¾ˆå¤šé¢ç»å–œæ¬¢æŠŠè¿™ä¸ªé—®é¢˜æ€»ç»“ä¸ºå››ç±»ï¼ŒåŒ…æ‹¬ç»§æ‰¿Threadã€å®ç°Runableå’ŒFutureTaskã€å®ç°Callableã€ä½¿ç”¨çº¿ç¨‹æ± ï¼Œä½†å…¶å®å½’æ ¹åˆ°åº•æ¥è¯´è¿˜æ˜¯ä¸‰ç±»ï¼Œå› ä¸ºFutureTaskè¿™ä¸ªæŠ½è±¡ç±»å®ç°äº†RunnableFutureæ¥å£ï¼ŒRunnableFutureè¿™ä¸ªæ¥å£ç»§æ‰¿äº†Futureæ¥å£å’ŒRunableæ¥å£ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FutureTask</span>&lt;V&gt; <span class="keyword">implements</span> <span class="title class_">RunnableFuture</span>&lt;V&gt; &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Revision notes: This differs from previous versions of this</span></span><br><span class="line"><span class="comment">     * class that relied on AbstractQueuedSynchronizer, mainly to</span></span><br><span class="line"><span class="comment">     * avoid surprising users about retaining interrupt status during</span></span><br><span class="line"><span class="comment">     * cancellation races. Sync control in the current design relies</span></span><br><span class="line"><span class="comment">     * on a &quot;state&quot; field updated via CAS to track completion, along</span></span><br><span class="line"><span class="comment">     * with a simple Treiber stack to hold waiting threads.</span></span><br><span class="line"><span class="comment">     */</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RunnableFuture</span>&lt;V&gt; <span class="keyword">extends</span> <span class="title class_">Runnable</span>, Future&lt;V&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets this Future to the result of its computation</span></span><br><span class="line"><span class="comment">     * unless it has been cancelled.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•æ¥è¯´ï¼Œåˆ›å»ºçº¿ç¨‹æœ‰ä¸¤ä»¶äº‹æƒ…ï¼Œ1.ç¡®å®šçº¿ç¨‹è¦åšçš„äº‹æƒ…ï¼Œä¹Ÿå°±æ˜¯å®ç°runæˆ–è€…callæ–¹æ³•ã€‚2.å¯åŠ¨çº¿ç¨‹</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨ä¸€ä¸ªç±»ç»§æ‰¿Threadç„¶åé‡å†™runæ–¹æ³•ï¼Œå°±åƒè¿™æ ·ï¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Thread3</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello zhima.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">Thread3</span> <span class="variable">thread3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread3</span>();</span><br><span class="line">thread3.start();</span><br></pre></td></tr></table></figure><p>æˆ–è€…å°±åƒä¸Šé¢é‚£æ ·å®ç°Runableæ¥å£ã€‚</p><p>å…³äºä¸ºä»€ä¹ˆè¦ä½¿ç”¨FutureTaskè¿™ä¸ªæŠ½è±¡ç±»ï¼Œå…¶å®ä¸»è¦æ˜¯å¸Œæœ›è·å¾—çº¿ç¨‹çš„è¿”å›å€¼ã€‚</p><p>å°±åƒä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Thread4</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;Integer&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">return</span> random.nextInt(<span class="number">114514</span>,<span class="number">114515</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">FutureTask&lt;Integer&gt; ft = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">Thread4</span>());</span><br><span class="line"><span class="type">Thread</span> <span class="variable">t4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(ft);</span><br><span class="line">t4.start();</span><br><span class="line"><span class="type">Integer</span> <span class="variable">rand</span> <span class="operator">=</span> ft.get();</span><br><span class="line">System.out.println(rand);</span><br><span class="line"><span class="comment">//114514</span></span><br></pre></td></tr></table></figure><p>å¦‚æœç”¨çº¿ç¨‹æ± å…¶å®åˆ›å»ºæ–¹æ³•ä¹Ÿå¾ˆå¤šï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢å‡ ç§æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºå¤§å°å›ºå®šçš„çº¿ç¨‹æ± </span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"><span class="comment">//ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ª</span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorService1</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"><span class="comment">//ä¹Ÿå¯ä»¥ç›´æ¥newä¸€ä¸ªThreadPoolExecutor</span></span><br><span class="line"><span class="comment">//è¦æŒ‡å®šçš„ä¸œè¥¿å°±æ¯”è¾ƒå¤šäº†ï¼ŒåŒ…æ‹¬æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæœ€å¤§çš„çº¿ç¨‹æ•°ï¼Œéæ ¸å¿ƒç©ºé—²çº¿ç¨‹AliveTimeï¼ŒAliveTimeçš„å•ä½ï¼Œä»¥åŠç”¨æ¥å­˜å‚¨ç­‰å¾…ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">//å¦‚æœé˜»å¡é˜Ÿåˆ—ç”¨ArrayBlockingQueueçš„è¯è¿˜è¦æŒ‡å®šæœ€å¤§å¤§å°</span></span><br><span class="line">BlockingQueue&lt;Runnable&gt; blockingQueue =<span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;();</span><br><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">executorService2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">5</span>,<span class="number">10</span>,<span class="number">1000L</span>, TimeUnit.SECONDS,blockingQueue);</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰å…«è‚¡é‡Œé¢å¸¸é—®çš„startå’Œrunçš„åŒºåˆ«ï¼Œrunå…¶å®å°±æ˜¯è°ƒç”¨ä¸€ä¸‹ä½ å®šä¹‰çš„çº¿ç¨‹è¦æ‰§è¡Œçš„æ–¹æ³•ï¼Œè€Œstartæ‰æ˜¯å¯åŠ¨çº¿ç¨‹ã€‚</p><p>çº¿ç¨‹çš„çŠ¶æ€åŒ…æ‹¬ï¼šnewã€runableã€blockedã€waitingã€timed_waitingã€terminated</p><h3 id="sleepå’Œwaitçš„åŒºåˆ«"><a href="#sleepå’Œwaitçš„åŒºåˆ«" class="headerlink" title="sleepå’Œwaitçš„åŒºåˆ«"></a>sleepå’Œwaitçš„åŒºåˆ«</h3><p>è¿™æ˜¯æˆ‘å†³å®šå†™è¿™ç¯‡åšå®¢çš„å‡ºå‘ç‚¹ï¼Œä¸»è¦æ˜¯æˆ‘ä¸€å¼€å§‹ç«Ÿç„¶ä¸çŸ¥é“sleepä¸ä¼šé‡Šæ”¾å½“å‰å ç”¨çš„èµ„æºï¼Œå°±æ¯”å¦‚è¯´æˆ‘ç”¨synchronizedå…³é”®å­—åŒæ­¥ä½äº†ä¸€ä¸ªèµ„æºStringBuilderã€‚</p><p>å¦‚æœæˆ‘åœ¨åŒæ­¥å—å†…è°ƒç”¨äº†ä¸€ä¸‹sleep(0)ï¼Œè™½ç„¶çº¿ç¨‹ä¼šæ”¾å¼ƒå¯¹è¯¥æ—¶é—´ç‰‡çš„å ç”¨ï¼Œä½†æ˜¯å¹¶ä¸ä¼šé‡Šæ”¾èµ„æºã€‚</p><p>ä½†æ˜¯å¦‚æœåœ¨åŒæ­¥å—å†…ä½¿ç”¨wait()ï¼Œå°±ä¼šæ”¾å¼ƒå¯¹å½“å‰èµ„æºå’Œæ—¶é—´ç‰‡çš„å ç”¨ã€‚</p><p>åšä¸ªç®€å•çš„å®éªŒï¼Œå°±æ˜¯æœ€å¼€å§‹é‚£éƒ¨åˆ†çš„ä»£ç ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡å®éªŒè¿›è¡Œå°è¯•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SleepTry</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        BlockingQueue&lt;Runnable&gt; bq =<span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;();</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">5</span>,<span class="number">10</span>,<span class="number">1000L</span>, TimeUnit.SECONDS,bq);</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">task1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (sb)&#123;</span><br><span class="line">                    sb.append(<span class="string">&quot;hello\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                    sb.append(<span class="string">&quot;I am Thread1\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">task2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (sb)&#123;</span><br><span class="line">                    sb.append(<span class="string">&quot;I am Thread2\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Future&lt;?&gt; feature1 =  threadPoolExecutor.submit(task1);</span><br><span class="line">        Thread.sleep(<span class="number">10</span>);</span><br><span class="line">        Future&lt;?&gt; feature2 =  threadPoolExecutor.submit(task2);</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        <span class="comment">//feature1.get();</span></span><br><span class="line">        <span class="comment">//feature2.get();</span></span><br><span class="line">        System.out.println(sb.toString());</span><br><span class="line">        threadPoolExecutor.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘åœ¨åŒæ­¥å—é‡Œsleepäº†2sï¼Œå¦‚æœé‡Šæ”¾äº†èµ„æºï¼Œä¸€å®šæ˜¯å¤Ÿç¬¬äºŒä¸ªçº¿ç¨‹æŠŠè‡ªå·±çš„å†…å®¹åŠ è¿›å»çš„ã€‚</p><p>ä¸ºäº†è®©ä¸»è¿›ç¨‹ç­‰å¾…ä¸¤ä¸ªçº¿ç¨‹éƒ½æ‰§è¡Œå®Œï¼Œæˆ‘åŠ äº†ä¸€ä¸ªä¸¤æ­¥è®¡æ•°å™¨CountDownLatchï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œå°±å‡ä¸€ã€‚ç”¨è¢«æ³¨é‡Šæ‰çš„ä¸¤è¡Œgetå…¶å®ä¹Ÿå¯ä»¥ã€‚</p><p>ä½†æ˜¯å®é™…ç»“æœæ˜¯ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hello</span><br><span class="line"><span class="selector-tag">I</span> am Thread1</span><br><span class="line"><span class="selector-tag">I</span> am Thread2</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶ï¼Œèµ„æºå¹¶æ²¡æœ‰å¾—åˆ°é‡Šæ”¾</p><p>æ­¤æ—¶åˆ«çš„ä»£ç éƒ½ä¸ä½œä¿®æ”¹ï¼Œåœ¨ä¸¤ä¸ªçº¿ç¨‹çš„åŒæ­¥å—å†…åˆ†åˆ«è°ƒç”¨wait()å’ŒnotifyAll()æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SleepTry</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        BlockingQueue&lt;Runnable&gt; bq =<span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;();</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">5</span>,<span class="number">10</span>,<span class="number">1000L</span>, TimeUnit.SECONDS,bq);</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">task1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (sb)&#123;</span><br><span class="line">                    sb.append(<span class="string">&quot;hello\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        sb.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                    sb.append(<span class="string">&quot;I am Thread1\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">task2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (sb)&#123;</span><br><span class="line">                    sb.append(<span class="string">&quot;I am Thread2\n&quot;</span>);</span><br><span class="line">                    sb.notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Future&lt;?&gt; feature1 =  threadPoolExecutor.submit(task1);</span><br><span class="line">        Thread.sleep(<span class="number">10</span>);</span><br><span class="line">        Future&lt;?&gt; feature2 =  threadPoolExecutor.submit(task2);</span><br><span class="line">        <span class="comment">//feature1.get();</span></span><br><span class="line">        <span class="comment">//feature2.get();</span></span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        System.out.println(sb.toString());</span><br><span class="line">        threadPoolExecutor.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hello</span><br><span class="line"><span class="selector-tag">I</span> am Thread2</span><br><span class="line"><span class="selector-tag">I</span> am Thread1</span><br></pre></td></tr></table></figure><p>èµ„æºæˆåŠŸé‡Šæ”¾ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹ä¹ŸæˆåŠŸå†™å…¥ã€‚</p><p>å¦‚æœç¬¬äºŒä¸ªçº¿ç¨‹ä¸notifyï¼Œè€Œä¸»è¿›ç¨‹åˆç­‰ç€çº¿ç¨‹1å‡å°‘è®¡æ•°å™¨ï¼Œé‚£ä¹ˆè¿›ç¨‹å°±ä¼šä¸€ç›´ç­‰å¾…ã€‚</p><p>æ‰€ä»¥æ­¤æ—¶æˆ‘ä»¬waitçš„æ—¶å€™å¯ä»¥åŠ ä¸ªtimeoutçš„å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sb.wait(<span class="number">100</span>);</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¾ˆå¤šå…«è‚¡å…¶å®æ€»ç»“çš„å¹¶ä¸å¥½ï¼Œwaitå¹¶ä¸ä¸€å®šéœ€è¦notifyæ‰èƒ½å”¤é†’ï¼Œä¹Ÿå¯ä»¥ä¸»åŠ¨è®¾å®štimeoutï¼Œè¶…æ—¶ä¹Ÿä¼šå”¤é†’ã€‚</p><h4 id="å°å°æ€»ç»“ä¸€ä¸‹sleepå’Œwait"><a href="#å°å°æ€»ç»“ä¸€ä¸‹sleepå’Œwait" class="headerlink" title="å°å°æ€»ç»“ä¸€ä¸‹sleepå’Œwait"></a>å°å°æ€»ç»“ä¸€ä¸‹sleepå’Œwait</h4><ol><li><p>sleepæ–¹æ³•å±äºThreadç±»ï¼Œæ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œä½œç”¨æ˜¯è®©å½“å‰çº¿ç¨‹è¿›å…¥sleepçŠ¶æ€ï¼›è€Œwaitæ˜¯ä¸€ä¸ªå®ä¾‹æ–¹æ³•ï¼Œå±äºObjectç±»ï¼Œå¿…é¡»è¢«ä¸€ä¸ªåˆå§‹åŒ–äº†çš„å®åŠ›å¯¹è±¡è°ƒç”¨</p></li><li><p>å¦‚æœå¤„äºåŒæ­¥å—å†…ï¼Œsleepä¸ä¼šé‡Šæ”¾èµ„æºï¼Œä½†æ˜¯waitä¼šé‡Šæ”¾èµ„æº</p></li><li><p>sleepå¯ä»¥ä¸åœ¨åŒæ­¥å—å†…è°ƒç”¨ï¼Œä½†æ˜¯waitä¸€å®šè¦åœ¨åŒæ­¥å—å†…è°ƒç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ è¦é‡Šæ”¾è¿™ä¸ªèµ„æºï¼Œä½ å¿…é¡»æŒæœ‰è¿™ä¸ªèµ„æºçš„é”ï¼Œå¦åˆ™å°±ä¼šæŠ¥é”™å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.util.concurrent.ExecutionException: java.lang.IllegalMonitorStateException: current thread is not owner</span><br><span class="line">at java.base/java.util.concurrent.FutureTask.report(FutureTask.java:<span class="number">122</span>)</span><br><span class="line">at java.base/java.util.concurrent.FutureTask.get(FutureTask.java:<span class="number">191</span>)</span><br><span class="line">at SleepTry.main(SleepTry.java:<span class="number">44</span>)</span><br><span class="line">Caused by: java.lang.IllegalMonitorStateException: current thread is not owner</span><br><span class="line">at java.base/java.lang.Object.wait(Native Method)</span><br><span class="line">at java.base/java.lang.Object.wait(Object.java:<span class="number">338</span>)</span><br><span class="line">at SleepTry$<span class="number">1.</span>run(SleepTry.java:<span class="number">15</span>)</span><br><span class="line">at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:<span class="number">539</span>)</span><br><span class="line">at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:<span class="number">264</span>)</span><br><span class="line">at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1136</span>)</span><br><span class="line">at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">635</span>)</span><br><span class="line">at java.base/java.lang.Thread.run(Thread.java:<span class="number">833</span>)</span><br></pre></td></tr></table></figure></li></ol><ol><li>å”¤é†’æœºåˆ¶ï¼Œsleepåªèƒ½ç­‰å¾…è¶…æ—¶å”¤é†’ï¼Œä½†æ˜¯waitæ—¢å¯ä»¥è¶…æ—¶å”¤é†’ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è¢«notify()æˆ–è€…notifyAll()å”¤é†’</li></ol><p>æœ€åè¿™é‡Œè¡¥å……ä¸€ä¸‹notifyå’ŒnotifyAllçš„åŒºåˆ«ï¼Œè¿™æ˜¯å°æ—codingä¸Šå†™çš„ï¼Œè¯´çš„ç‰¹åˆ«å½¢è±¡</p><p>notifyï¼šå”¤èµ·ä¸€ä¸ªçº¿ç¨‹ï¼Œå…¶ä»–çº¿ç¨‹è¿˜å¤„äºwaitingçŠ¶æ€ï¼Œå¦‚æœè¿™ä¸ªçº¿ç¨‹ç»“æŸçš„æ—¶å€™æ²¡æœ‰notifyï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹åªèƒ½ç»§ç»­ç­‰å¾…åˆ°è¶…æ—¶æˆ–è¢«ä¸­æ–­ã€‚è€Œä¸”notifyè¯´æ˜¯éšæœºå”¤é†’ï¼Œä½†æ˜¯åœ¨hotspotè™šæ‹Ÿæœºé‡Œæ˜¯å…ˆè¿›å…ˆå‡ºçš„å”¤é†’ã€‚</p><p>notifyAllï¼šæ‰€æœ‰çº¿ç¨‹éƒ½è¢«å”¤é†’ï¼Œç„¶åè¿›å…¥èµ„æºäº‰å¤ºç¯èŠ‚ï¼Œå–œé—»ä¹è§çš„BLOCKEDçŠ¶æ€</p><h3 id="çº¿ç¨‹çŠ¶æ€"><a href="#çº¿ç¨‹çŠ¶æ€" class="headerlink" title="çº¿ç¨‹çŠ¶æ€"></a>çº¿ç¨‹çŠ¶æ€</h3><p>ä¹‹å‰è¯´äº†çº¿ç¨‹çš„å…­ä¸ªçŠ¶æ€ï¼Œè¿™é‡Œå†æé†’è‡ªå·±é»˜å†™ä¸€ä¸‹ï¼š</p><p>NEWã€RUNABLEã€BLOCKEDã€WAITINGã€TIMED_WAITINGã€TERMINATED</p><p>BLOCKEDå’ŒWAITINGå…¶å®è¿˜æŒºéš¾åˆ†æ¸…æ¥šçš„ï¼Œæˆ‘æ€»ç»“ä¸ºä¸‹ï¼š</p><p>è™½ç„¶éƒ½æ˜¯é˜»å¡åœ¨é‚£é‡Œï¼Œä½†æ˜¯BLOCKEDæ˜¯å› ä¸ºèµ„æºç«äº‰å¯¼è‡´çš„é˜»å¡</p><p>WAITINGæ˜¯çº¿ç¨‹æ— é™æœŸåœ°ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç‰¹å®šæ“ä½œï¼Œæ¯”å¦‚ä¸Šé¢æ‰€ä½¿ç”¨çš„CountDownLatchï¼Œå¦‚æœè°ƒç”¨await()æ–¹æ³•ï¼Œå…¶å®æ˜¯è¿›å…¥WAITINGçŠ¶æ€ï¼Œå’Œè°ƒç”¨waitæ–¹æ³•ç±»ä¼¼ã€‚</p><h3 id="çº¿ç¨‹åœæ­¢"><a href="#çº¿ç¨‹åœæ­¢" class="headerlink" title="çº¿ç¨‹åœæ­¢"></a>çº¿ç¨‹åœæ­¢</h3><p>è€ç”Ÿå¸¸è°ˆï¼Œå°±æ˜¯Javaå®˜æ–¹ä¸å»ºè®®ä½¿ç”¨Thread.stop()è¿™ç§æ–¹å¼æ¥åœæ­¢ã€‚</p><p>æœ‰å¾ˆå¤šç§æ–¹æ³•åŒ…æ‹¬</p><ol><li><p>ä½¿ç”¨volatileå…³é”®å­—æ¥ä¿®é¥°ä¸€ä¸ªbooleanå˜é‡ï¼Œçº¿ç¨‹å…³æ³¨åˆ°booleanå˜é‡è‡ªå·±å†…éƒ¨åœæ­¢</p></li><li><p>è°ƒç”¨çº¿ç¨‹ä¸­æ–­Thread.interrupt()ï¼Œç„¶åçº¿ç¨‹å†…éƒ¨æ£€æµ‹å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºä¸­æ–­çŠ¶æ€æˆ–è€…è§¦å‘å¯ä¸­æ–­æ“ä½œæ¥å“åº”ä¸­æ–­ã€‚</p><p>å¯è§¦å‘ä¸­æ–­æ“ä½œæ˜¯æŒ‡sleepæˆ–è€…waitç­‰é˜»å¡æ“ä½œï¼Œå¦‚æœè¿™æ—¶å€™æ”¶åˆ°ä¸­æ–­è¯·æ±‚ä¼šç›´æ¥æŠ›ä¸­æ–­å¼‚å¸¸çš„ã€‚</p></li><li><p>é€šè¿‡Futureç®¡ç†ä»»åŠ¡ï¼ŒFutureæ¥å£æ˜¯ä¸€ä¸ªå¯ä»¥ä¸»åŠ¨åœæ­¢ä»»åŠ¡çš„æ¥å£ï¼ŒFuture.cancel()</p></li><li><p>å…³é—­èµ„æº</p></li></ol><h2 id="é”"><a href="#é”" class="headerlink" title="é”"></a>é”</h2><h3 id="volatileå…³é”®å­—å’Œsynchronizedå…³é”®å­—"><a href="#volatileå…³é”®å­—å’Œsynchronizedå…³é”®å­—" class="headerlink" title="volatileå…³é”®å­—å’Œsynchronizedå…³é”®å­—"></a>volatileå…³é”®å­—å’Œsynchronizedå…³é”®å­—</h3><p>è¿™ä¸¤ä¸ªå…³é”®å­—æ€»æ˜¯è¢«æ‹¿å‡ºæ¥è¯´ï¼Œä½†å…¶å®ä¸¤è€…çš„ä½œç”¨å·®è·è¿˜æ˜¯æŒºå¤§çš„ã€‚</p><p>volatileçš„ä½œç”¨ä¸»è¦ä½“ç°åœ¨ç¦æ­¢æŒ‡ä»¤é‡æ’å¯¼è‡´çš„ä¿®æ”¹ä¸å¯è§ã€‚</p><p>è¿™ä¸ªğŸŒ°å…¶å®æŒºä¸å¥½ä¸¾çš„ï¼Œæˆ‘è¯•ç€çœ‹çœ‹èƒ½ä¸èƒ½å‡ºç°ã€‚å¤±è´¥äº†ï¼Œå¾ˆéš¾å¤ç°å•Šï¼Œå› ä¸ºå¹¶ä¸çŸ¥é“è™šæ‹Ÿæœºåº•å±‚æ˜¯å¦‚ä½•æŒ‡ä»¤é‡æ’å’Œä¼˜åŒ–çš„ã€‚</p><p>ä½†æ˜¯volatileå…³é”®å­—çš„ç›®çš„æ‰€åœ¨ï¼Œå°±æ˜¯ä¸ºäº†è®©çº¿ç¨‹çŸ¥é“ä¸€ä¸ªå˜é‡å®ƒå˜åŒ–äº†ï¼Œèƒ½æ„ŸçŸ¥åˆ°å®ƒçš„å˜åŒ–ï¼Œå€Ÿç”±æ­¤çº¿ç¨‹ä¹‹é—´å¯ä»¥ç›¸äº’é€šä¿¡ã€‚</p><p>ç„¶åè¯´è¯´volatileå…³é”®å­—çš„ä½œç”¨åŸŸï¼Œvolatileå…³é”®å­—ä¸»è¦ä½œç”¨äºå˜é‡å£°æ˜ä¸Šï¼Œæ›´å¤šçš„ç”¨äº<strong>å®ä¾‹å˜é‡</strong>æˆ–<strong>é™æ€å˜é‡</strong>ï¼Œæ‰€ä»¥å±€éƒ¨å˜é‡å£°æ˜æ— æ„ä¹‰ã€‚</p><h3 id="synchronizedå…³é”®å­—å’Œ-ReentrantLock"><a href="#synchronizedå…³é”®å­—å’Œ-ReentrantLock" class="headerlink" title="synchronizedå…³é”®å­—å’Œ ReentrantLock"></a>synchronizedå…³é”®å­—å’Œ ReentrantLock</h3><p>æ¥ä¸‹æ¥å°±æ˜¯synchronizedå…³é”®å­—ï¼Œå…¶å®å®ƒæ›´åº”è¯¥å’ŒReentrantLockæ”¾åœ¨ä¸€èµ·æ¯”è¾ƒæ‰é€‚åˆï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠå®ƒæŒªåˆ°ä¸‹é¢æ¥</p><p>synchronizedå…³é”®å­—ä¸»è¦ç”¨äºå£°æ˜åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯ç»™èµ„æºåŠ é”ã€‚</p><p>ä¸ReentrantLockç›¸åŒçš„ï¼Œsynchronizedä¹Ÿæ˜¯ä¸€ä¸ªå¯é‡å…¥é”ï¼Œä¹Ÿå°±æ˜¯åŒä¸€ä¸ªçº¿ç¨‹å†…å†æ¬¡ä¸Šé”ä¹Ÿå¯ä»¥è·å¾—èµ„æºã€‚</p><p>synchronizedæ˜¯Javaæä¾›çš„åŸå­å†…ç½®é”ï¼Œä¹Ÿè¢«ç§°ä¸ºç›‘è§†å™¨é”ã€‚</p><p>ä½¿ç”¨synchronizeå…³é”®å­—ä¿®é¥°çš„ä»£ç å—åœ¨ç¼–è¯‘çš„æ—¶å€™å‰åä¼šåˆ†åˆ«åŠ ä¸Šmonitorenterå’Œmonitorexitã€‚</p><p>è¿™ä¸ªæ‰§è¡Œåˆ°monitorenterçš„æ—¶å€™ä¼šå°è¯•è·å–èµ„æºï¼Œå¦‚æœè·å–åˆ°èµ„æºå°±æŠŠè®¡æ•°å™¨åŠ ä¸€ï¼Œæ‰§è¡Œåˆ°monitorexitçš„æ—¶å€™å°±æŠŠè®¡æ•°å™¨å‡ä¸€ã€‚ä¸º0çš„æ—¶å€™ä»£è¡¨æ˜¯å¯è·å–çš„ã€‚</p><p>æ¥ä¸‹æ¥æ˜¯synchronizedå…³é”®å­—çš„ä½œç”¨åŸŸï¼Œå…¶å®æŒºå¤æ‚çš„ï¼š</p><ol><li><p>ä½œç”¨äºç±»çš„å®ä¾‹æ–¹æ³•ä¸Šï¼Œé‚£å°±æ˜¯é”ä½äº†å½“å‰å®ä¾‹ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®è¯¥æ–¹æ³•çš„ä»»ä½• <code>synchronized</code> å®ä¾‹æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.LinkedBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronizedTry</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">beBlocked</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> a;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> b=<span class="number">10</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">getA</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">getB</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> b;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">beBlocked</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">beBlocked</span>();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">5</span>,<span class="number">10</span>,<span class="number">1000L</span>, TimeUnit.SECONDS,<span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;());</span><br><span class="line">        threadPoolExecutor.submit(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (a) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        test.getA();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        threadPoolExecutor.submit(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span>test.getB();</span><br><span class="line">                System.out.println(b);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        threadPoolExecutor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥è¿™æ®µä»£ç ä¸ºä¾‹ï¼Œè°ƒç”¨getAæ–¹æ³•sleepçš„é‚£10sï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æ˜¯æ²¡æœ‰åŠæ³•è·å¾—åˆ°å“ªæ€•æ˜¯getBæ–¹æ³•çš„è¿”å›å€¼çš„ã€‚</p></li><li><p>ä½œç”¨äºé™æ€æ–¹æ³•ï¼Œé‚£å°±ä¼šé”ä½ç±»å¯¹è±¡ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®è¯¥æ–¹æ³•çš„ä»»ä½• <code>synchronized</code> é™æ€æ–¹æ³•ã€‚</p></li><li><p>ä½œç”¨äºä»£ç å—ï¼Œä¹Ÿå°±æ˜¯å¸¸ç”¨çš„synchronized(){}èŒƒå¼ï¼Œæ‹¬å·é‡Œå¯ä»¥ä¸ºObjectæˆ–è€…thisï¼Œä¹Ÿå¯ä»¥æ˜¯Classå¯¹è±¡</p></li></ol><p>ReentrantLockç›¸æ¯”äºsynchronizedæ›´ä¸ºç²¾ç»†åŒ–ã€‚</p><p>å®ƒå®ç°äº†ä¸¤ä¸ªæ¥å£ï¼ŒLockæ¥å£å’Œåºåˆ—åŒ–æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReentrantLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span>, java.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">7373984872572414699L</span>;</span><br><span class="line">    <span class="comment">/** Synchronizer providing all implementation mechanics */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sync sync;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Base of synchronization control for this lock. Subclassed</span></span><br><span class="line"><span class="comment">     * into fair and nonfair versions below. Uses AQS state to</span></span><br><span class="line"><span class="comment">     * represent the number of holds on the lock.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Sync</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">5179523762034025860L</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åŒæ­¥çš„å®ç°ä¸»è¦ä¾èµ–äºç»§æ‰¿è‡ªAbstractQueuedSynchronizerç±»ï¼ˆAQSï¼‰ç±»çš„Syncç±»</p><p>ReentrantLockæ˜¯å¯é‡å…¥é”ï¼Œä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ¯æ¬¡è·å–éƒ½éœ€è¦ç›¸åº”çš„é‡Šæ”¾æ“ä½œï¼Œé”å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªè®¡æ•°å™¨æ¥è®°å½•è·å–çš„æ¬¡æ•°ã€‚è¿™ç‚¹å’Œsynchronizedå…³é”®å­—å¾ˆåƒã€‚</p><p>å®ä¾‹åŒ–ReentrantLockçš„æ—¶å€™å¯ä»¥é€‰æ‹©æ˜¯å¦å¯ç”¨å…¬å¹³é”ã€‚å…¬å¹³é”ä¼šæŒ‰ç…§è¯·æ±‚é¡ºåºæˆäºˆé”ï¼Œè€Œéå…¬å¹³é”åˆ™å…è®¸æ’é˜Ÿï¼ˆå³æ–°æ¥çš„çº¿ç¨‹å¯èƒ½åœ¨ç­‰å¾…ä¸­çš„çº¿ç¨‹ä¹‹å‰è·å¾—é”ï¼‰ã€‚é»˜è®¤æ˜¯éå…¬å¹³é”ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates an instance of &#123;<span class="doctag">@code</span> ReentrantLock&#125;.</span></span><br><span class="line"><span class="comment"> * This is equivalent to using &#123;<span class="doctag">@code</span> ReentrantLock(false)&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync = <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates an instance of &#123;<span class="doctag">@code</span> ReentrantLock&#125; with the</span></span><br><span class="line"><span class="comment"> * given fairness policy.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fair &#123;<span class="doctag">@code</span> true&#125; if this lock should use a fair ordering policy</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">(<span class="type">boolean</span> fair)</span> &#123;</span><br><span class="line">    sync = fair ? <span class="keyword">new</span> <span class="title class_">FairSync</span>() : <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶ReentrantLockæ”¯æŒä¸­æ–­å“åº”ï¼Œä¹Ÿå°±æ˜¯åœ¨ç­‰å¾…é”çš„æ—¶å€™åœ¨åŒæ­¥å—å†…å“åº”æ‰“æ–­ã€‚</p><p>åŒæ—¶ä¹Ÿæ”¯æŒéé˜»å¡å¼çš„è·å–é”ï¼ŒtryLockï¼Œå¦‚æœä¸èƒ½è·å¾—é”ï¼Œç«‹åˆ»è¿”å›ï¼Œä¹Ÿå¯ä»¥ä¼ å…¥ç­‰å¾…æ—¶é—´ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ReentrantLock</span> <span class="variable">reentrantLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(<span class="literal">true</span>);</span><br><span class="line">reentrantLock.lockInterruptibly();</span><br><span class="line"><span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> reentrantLock.tryLock(<span class="number">10</span>, TimeUnit.MICROSECONDS);</span><br></pre></td></tr></table></figure><h3 id="å…¶ä»–çš„é”"><a href="#å…¶ä»–çš„é”" class="headerlink" title="å…¶ä»–çš„é”"></a>å…¶ä»–çš„é”</h3><p>synchronizedå’ŒReentrantLockéƒ½æ˜¯æ’ä»–é”ï¼Œå…¶å®è¿˜æœ‰å¾ˆå¤šå…¶ä»–é”çš„ç±»å‹ã€‚</p><p>åƒæ˜¯ReadWriteLockï¼Œå†™é”æ˜¯ç‹¬å é”ï¼Œä½†æ˜¯è¯»é”æ˜¯å…±äº«é”ã€‚</p><p>ä»¥åŠä¸€äº›æ¦‚å¿µæ€§çš„é”ï¼Œä¹è§‚é”å’Œæ‚²è§‚é”ã€‚</p><p>ä¹è§‚é”å…¶å®æœ¬è´¨ä¸Šå°±æ˜¯å‡è®¾èµ„æºæ²¡äººç”¨ï¼Œæœ‰äººç”¨äº†æˆ‘å†é‡æ¥ã€‚æ‚²è§‚é”å°±æ˜¯synchronizedå’ŒReentrantLockè¿™æ ·çš„é”ï¼Œä¸€å®šè¦ç‹¬å äº†å†å»æ“ä½œã€‚</p><p>è‡ªæ—‹é”ä¸»è¦æ˜¯é CASå®ç°çš„ã€‚CASå…¨ç§°Compare And Setã€‚</p><p>æ¶‰åŠä¸‰ä¸ªå‚æ•°ï¼šå†…å­˜ä½ç½®ï¼ˆVï¼‰ã€é¢„æœŸåŸå€¼ï¼ˆAï¼‰å’Œæ–°å€¼ï¼ˆBï¼‰ã€‚CAS çš„æ‰§è¡Œé€»è¾‘å¦‚ä¸‹ï¼š</p><ol><li>æ£€æŸ¥å†…å­˜ä½ç½® V ä¸­çš„å€¼æ˜¯å¦ç­‰äºé¢„æœŸåŸå€¼ Aã€‚</li><li>å¦‚æœç›¸ç­‰ï¼Œåˆ™å°†å†…å­˜ä½ç½® V çš„å€¼æ›´æ–°ä¸ºæ–°å€¼ Bï¼Œå¹¶è¿”å›æˆåŠŸã€‚</li><li>å¦‚æœä¸ç›¸ç­‰ï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹å·²ç»ä¿®æ”¹äº†è¯¥ä½ç½®çš„å€¼ï¼Œåˆ™ä¸è¿›è¡Œä»»ä½•æ“ä½œï¼Œå¹¶è¿”å›å¤±è´¥ã€‚</li></ol><p>è¿™å…¶å®æ˜¯ä¹è§‚é”çš„ä¸€ç§å®ç°ã€‚Javaçš„åŸå­ç±»æ¯”å¦‚AtomicIntegerå°±æä¾›è¿™ç§ç±»å‹çš„æ–¹æ³•ï¼šcompareAndSet</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Atomically sets the value to &#123;<span class="doctag">@code</span> newValue&#125;</span></span><br><span class="line"><span class="comment"> * if the current value &#123;<span class="doctag">@code</span> == expectedValue&#125;,</span></span><br><span class="line"><span class="comment"> * with memory effects as specified by &#123;<span class="doctag">@link</span> VarHandle#compareAndSet&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> expectedValue the expected value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> newValue the new value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if successful. False return indicates that</span></span><br><span class="line"><span class="comment"> * the actual value was not equal to the expected value.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">compareAndSet</span><span class="params">(<span class="type">int</span> expectedValue, <span class="type">int</span> newValue)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> U.compareAndSetInt(<span class="built_in">this</span>, VALUE, expectedValue, newValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="sychronized"><a href="#sychronized" class="headerlink" title="sychronized"></a>sychronized</h3><p>sychronizedçš„é”å‡çº§è¿‡ç¨‹ï¼š</p><p>æ— é”-&gt;åå‘é”-&gt;è½»é‡çº§é”-&gt;é‡é‡çº§é”</p><p>åå‘é”æ˜¯JAVA1.6å¼•å…¥çš„ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹æ‹¿åˆ°é”ä¹‹åï¼Œä¼šè®°å½•å®ƒçš„çº¿ç¨‹IDï¼Œå¦‚æœæ²¡æœ‰ç«äº‰æ—¶ï¼Œåªéœ€è¦æ¯”è¾ƒè®°å½•çš„IDä¸è‡ªå·±æ˜¯å¦ä¸€è‡´ï¼Œä¸€è‡´ç›´æ¥è·å¾—é”ï¼Œä¸éœ€è¦CASæ“ä½œã€‚</p><p>å½“æœ‰é”ç«äº‰çš„æ—¶å€™ï¼Œåå‘é”å‡çº§ä¸ºè½»é‡çº§é”ã€‚è¿™æ—¶å€™çš„é”é€šè¿‡CASå®ç°ï¼Œå…è®¸è‡ªæ—‹ã€‚</p><p>å½“ç«äº‰æ¿€çƒˆçš„æ—¶å€™ï¼Œè½»é‡çº§é”å‡çº§ä¸ºé‡é‡çº§é”ï¼Œç³»ç»ŸæŒ‚èµ·çº¿ç¨‹è€Œä¸æ˜¯çº¿ç¨‹è‡ªæ—‹ã€‚</p><h3 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h3><p>å…¨åä¸ºæŠ½è±¡åŒæ­¥é˜Ÿåˆ—ï¼Œå®ç°åŒæ­¥çš„é‡è¦åº•å±‚ä¹‹ä¸€ã€‚</p><p>ä¸»è¦ç»´æŠ¤ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—å’Œä¸€ä¸ªstateã€‚å¦‚æœstateä¸º0æˆ–è€…ä¸ºåŒçº¿ç¨‹ï¼ˆå¯é‡å…¥é”ï¼‰ï¼Œåˆ™å¯è·å¾—é”ï¼Œè®¡æ•°å™¨+1ï¼›</p><p>ç«äº‰å¤±è´¥çš„çº¿ç¨‹åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—ä¸­å»ï¼Œå¦‚æœæ˜¯å…¬å¹³é”ï¼Œæ–°æ¥çš„çº¿ç¨‹ç›´æ¥åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—ä¸­å»</p><h3 id="éå…¬å¹³é”ä¸ºä»€ä¹ˆæ¯”å…¬å¹³é”ååé‡å¤§"><a href="#éå…¬å¹³é”ä¸ºä»€ä¹ˆæ¯”å…¬å¹³é”ååé‡å¤§" class="headerlink" title="éå…¬å¹³é”ä¸ºä»€ä¹ˆæ¯”å…¬å¹³é”ååé‡å¤§"></a>éå…¬å¹³é”ä¸ºä»€ä¹ˆæ¯”å…¬å¹³é”ååé‡å¤§</h3><p>å› ä¸ºéå…¬å¹³é”è·å–çº¿ç¨‹CASå¦‚æœè·å–åˆ°é”ç›´æ¥å°±æ‹¥æœ‰é”ï¼Œä¸éœ€è¦è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p><h3 id="æ­»é”æ¡ä»¶"><a href="#æ­»é”æ¡ä»¶" class="headerlink" title="æ­»é”æ¡ä»¶"></a>æ­»é”æ¡ä»¶</h3><ol><li>äº’æ–¥æ¡ä»¶</li><li>æ‹¥æœ‰å¹¶ç­‰å¾…</li><li>ä¸å¯å‰¥å¤º</li><li>èµ„æºä¾èµ–ç¯è·¯</li></ol>]]></content>
    
    
    <summary type="html">åšç‚¹å®éªŒæ¥ç¨å¾®å›é¡¾ä¸€ä¸‹Javaå¤šçº¿ç¨‹çš„å¸¸è§é—®é¢˜</summary>
    
    
    
    <category term="ä»£ç å®ç°" scheme="https://www.karlyn.xyz/categories/%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0/"/>
    
    
    <category term="Java" scheme="https://www.karlyn.xyz/tags/Java/"/>
    
    <category term="å¤šçº¿ç¨‹" scheme="https://www.karlyn.xyz/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>è½»é‡äº‘æœåŠ¡å™¨ç»“åˆRabbitMQå®ç°è°ƒç”¨æœ¬åœ°AIæ¥å£</title>
    <link href="https://www.karlyn.xyz/posts/deepseek.html"/>
    <id>https://www.karlyn.xyz/posts/deepseek.html</id>
    <published>2025-03-28T12:50:42.000Z</published>
    <updated>2025-03-28T14:47:53.799Z</updated>
    
    <content type="html"><![CDATA[<h1>èƒŒæ™¯</h1><p>æˆ‘æœ‰ä¸€ä¸ªä»¿å¾®ä¿¡çš„IMèŠå¤©é¡¹ç›®ï¼Œä½†æ˜¯æƒ³åšå‡ºä¸€ç‚¹æ–°çš„ä¸œè¥¿ï¼ŒAIè¿™ä¸ªé£å£ä¸Šæ‰€ä»¥è¿˜æ˜¯æƒ³çœ‹çœ‹èƒ½ä¸èƒ½åšç‚¹AIæ¥å£çš„è°ƒç”¨ã€‚ä½†æ˜¯ç›´æ¥è°ƒç”¨å®˜æ–¹æ¥å£æ„ä¹‰ä¸å¤§ï¼Œå…¶å®æœ¬è´¨ä¸Šæ¥è¯´ï¼Œæœ¬åœ°ç”¨Ollamaéƒ¨ç½²å®Œç„¶åæœ¬åœ°è°ƒç”¨æœ¬åœ°æ¥å£å…¶å®ä¹Ÿä¸ç®—å¾ˆæœ‰éš¾åº¦çš„äº‹æƒ…ã€‚</p><p>ä½†æ˜¯æ°å¥½æˆ‘çš„IMé¡¹ç›®å°±æœ‰è¿™ä¹ˆä¸€ç‚¹â€”â€”éœ€è¦æ”¯æŒè·¨æœåŠ¡å™¨ä¹‹é—´çš„æ¶ˆæ¯å‘é€ï¼Œæ‰€ä»¥è®¾è®¡äº†ä¸€ä¸ªå‘å¸ƒè®¢é˜…çš„ä¸­é—´ä»¶æ¥è¿›è¡ŒæœåŠ¡å™¨ä¸ŠæŸä¸ªèŠ‚ç‚¹çš„æ¶ˆæ¯æ‰©æ•£åˆ°å…¶ä»–æœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·å°±å¤©ç„¶æ”¯æŒäº†ä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯AæœåŠ¡å™¨çš„ä»»åŠ¡ï¼Œå¦‚æœè¢«BæœåŠ¡å™¨å¤„ç†äº†ï¼Œä¾ç„¶å¯ä»¥å‘é€å›åˆ°AæœåŠ¡å™¨ã€‚</p><h2 id="ç®€å•å±•ç¤º">ç®€å•å±•ç¤º</h2><p>å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ç»™æœåŠ¡ç«¯ï¼Œæˆ‘çš„æœåŠ¡ç«¯æ˜¯äº¬ä¸œäº‘çš„ä¸€ä¸ªè½»é‡çº§æœåŠ¡å™¨ï¼Œ2Gå†…å­˜çš„é‚£ç§ã€‚</p><p>ç°åœ¨æˆ‘åœ¨å®¢æˆ·ç«¯ç»™æœåŠ¡ç«¯å‘ä¸€æ¡æ¶ˆæ¯ï¼Œè¿™æ—¶å€™æˆ‘æ²¡å…³æˆ‘æœ¬åœ°çš„æœåŠ¡å™¨å•Šï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘æœ¬åœ°æœ‰ä¸ªèƒ½å¤„ç†AIå›¾ç‰‡çš„æœåŠ¡å™¨æŒ‚åœ¨é‚£é‡Œæ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™æ—¶å€™æœ‰æ­£å¸¸çš„å“åº”ï¼ˆåˆ«ä»‹æ„ï¼Œä¸æ˜¯32Bï¼Œåªæ˜¯æˆ‘å½“æ—¶è§‰å¾—èƒ½è·‘ï¼Œä½†æ˜¯ç¡®å®å¤ªæ…¢äº†ï¼Œåé¢æˆ‘ç›´æ¥æ¢1.5bäº†ï¼‰</p><p><img src="/picture/ai_message.png" alt="å®¢æˆ·ç«¯å‘æ¶ˆæ¯"></p><p>è¿™æ—¶å€™æˆ‘ä»¬çœ‹çœ‹æˆ‘äº¬ä¸œäº‘çš„æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸€æ¡æ—¥å¿—è¯´æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆæ¯å¢åŠ ï¼Œè¿™æ˜¯æˆ‘åœ¨æ¶ˆæ¯è¿›å…¥äº¤æ¢æœºçš„æ—¶å€™æ‰“çš„ä¸€ä¸ªlogï¼Œè¯æ˜è¿™æ¡æ¶ˆæ¯åœ¨ä¸åŒæœåŠ¡å™¨ä¸Šæ‰©æ•£äº†ï¼Œè¿™æ—¶å€™å°±è¦å»è‡ªå·±æœåŠ¡å™¨ä¸ŠæŠŠè¿™æ¡æ¶ˆæ¯å‘ç»™å¯¹åº”çš„äººï¼Œå¦‚æœè‡ªå·±ç»´æŠ¤çš„WebSocketChannelé‡Œæ²¡æœ‰ï¼Œå°±ç›´æ¥ä¸ç®¡äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;$&#123;rabbit.queue.message&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">Listener</span><span class="params">(String msg, Channel channel, <span class="meta">@Header(AmqpHeaders.DELIVERY_TAG)</span> <span class="type">long</span> tag)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">MessageSendDto</span> <span class="variable">sendDto</span> <span class="operator">=</span> JsonUtils.convertJson2Obj(msg, MessageSendDto.class);</span><br><span class="line">    log.info(<span class="string">&quot;æ¶ˆæ¯é˜Ÿåˆ—æ”¶åˆ°æ¶ˆæ¯&quot;</span>);</span><br><span class="line">    log.info(msg);</span><br><span class="line">    channelContextUtils.sendMessage(sendDto);</span><br><span class="line">    channel.basicAck(tag, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ¡æ¶ˆæ¯ç›´æ¥è¢«ä¸¢å¼ƒäº†ï¼Œä½†æ˜¯å› ä¸ºæ˜¯æœºå™¨äººï¼Œæ‰€ä»¥æˆ‘ä»¬åŒæ—¶æŠŠå®ƒåŠ åˆ°äº†æœºå™¨äººå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—é‡Œï¼Œä½†æ˜¯æˆ‘ä»¬äº¬ä¸œäº‘çš„æ—¥å¿—å¹¶æ²¡æœ‰åç»­çš„å¤„ç†ã€‚æ—¥å¿—å¦‚ä¸‹ï¼š</p><p><img src="/picture/jd_log.png" alt="äº¬ä¸œäº‘æ—¥å¿—"></p><p>ä½†æ˜¯æˆ‘ä»¬æœ¬åœ°å¤„ç†äº†ï¼Œè¿™æ˜¯æˆ‘æœ¬åœ°è¿è¡ŒjaråŒ…çš„è¾“å‡º</p><p><img src="/picture/local_log.png" alt="æœ¬åœ°è¾“å‡º"></p><p>è¿™æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹æƒ…å†µã€‚</p><p><img src="/picture/mq1.png" alt="æ¶ˆæ¯é˜Ÿåˆ—"></p><p>è¿™æ—¶å€™å¦‚æœæˆ‘ä»¬åœæ‰æœ¬åœ°çš„æœåŠ¡å™¨ï¼Œæ¶ˆæ¯å°±ä¼šå †ç§¯åœ¨æ¶ˆæ¯é˜Ÿåˆ—é‡Œç­‰å¾…æœ‰èƒ½åŠ›å¤„ç†çš„æœåŠ¡å™¨ä¸Šçº¿ã€‚</p><p><img src="/picture/mq2.png" alt="æ¶ˆæ¯é˜Ÿåˆ—"></p><p>è‡ªç„¶ä¹Ÿä¸ä¼šç»™ç”¨æˆ·æ¶ˆæ¯åé¦ˆã€‚</p><p><img src="/picture/ai_message2.png" alt="å®¢æˆ·ç«¯å‘æ¶ˆæ¯"></p><h1>æŠ€æœ¯é€‰å‹</h1><p>ä¸ºäº†åç»­æ‰©å±•æ–¹ä¾¿ï¼Œä»¥åŠä¸ºäº†è·¨æœåŠ¡å™¨èŠå¤©å°±æ˜¯ç”¨äº†RabbitMQçš„fanoutæ‰‡å‡ºäº¤æ¢æœºæ¥è¿›è¡ŒæœåŠ¡å™¨ä¹‹é—´çš„æ¶ˆæ¯æ‰©æ•£ï¼Œæ‰€ä»¥è¿™æ¬¡AIæ¥å£çš„æŠ€æœ¯æ‰©å±•æˆ‘ä»¬ç»§ç»­ä½¿ç”¨RabbitMQï¼Œä½†æ˜¯ä¸ä¹‹å‰é€‰æ‹©ä½¿ç”¨å‘å¸ƒè®¢é˜…æ¨¡å‹ä¸åŒï¼Œæˆ‘ä»¬è¿™æ¬¡é€‰æ‹©çš„æ¨¡å¼æ˜¯ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯å·¥ä½œé˜Ÿåˆ—æ¨¡å¼ã€‚</p><h2 id="è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹RabbitMQçš„äº”ç§æ¨¡å¼å§">è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹RabbitMQçš„äº”ç§æ¨¡å¼å§</h2><h3 id="ç®€å•æ¨¡å¼">ç®€å•æ¨¡å¼</h3><p>åŒ…å«ä¸€ä¸ªç”Ÿäº§è€…ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œä¸€ä¸ªé˜Ÿåˆ—ã€‚ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ç›‘å¬å¹¶æ¶ˆè´¹æ¶ˆæ¯ã€‚</p><p>è¿™ç§æ¨¡å¼çš„ä½œç”¨ä¸ºï¼šè§£è€¦ï¼Œå‰Šå³°å¡«è°·</p><p><img src="/picture/simple.png" alt="ç®€å•æ¨¡å¼"></p><p>å…¶å®é‚®ä»¶ã€èŠå¤©éƒ½æ˜¯è¿™ç§åœºæ™¯çš„å—ä¼—ï¼Œåªä¸è¿‡æˆ‘ä»¬çš„æœåŠ¡å™¨å……å½“äº†ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„åŠŸèƒ½</p><h3 id="å·¥ä½œé˜Ÿåˆ—æ¨¡å¼">å·¥ä½œé˜Ÿåˆ—æ¨¡å¼</h3><p>è¿™ç§æ¨¡å¼å°±æ˜¯ä¸€ä¸ªç”Ÿäº§è€…ï¼Œä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ï¼Œç”Ÿäº§è€…æºæºä¸æ–­å¾€é˜Ÿåˆ—é‡Œæ”¾ä»»åŠ¡ï¼Œæ¶ˆè´¹è€…ç›‘å¬å¹¶å¤„ç†ä»»åŠ¡ã€‚è¿™æ ·çš„æ¨¡å¼ä¹Ÿè¢«ç§°ä¸ºèƒ½è€…å¤šåŠ³æ¨¡å¼ï¼Œèƒ½åŠ›è¶Šå¼ºçš„æ¶ˆè´¹è€…æ¶ˆè´¹çš„æ¶ˆæ¯æ›´å¤šã€‚</p><p><img src="/picture/work.png" alt="å·¥ä½œé˜Ÿåˆ—"></p><p>ä½†æ˜¯éœ€è¦è¯´çš„æ˜¯ï¼ŒSpringbooté›†æˆRabbitMQï¼Œé»˜è®¤é™åˆ¶é™åˆ¶æ¶ˆè´¹è€…ä¸€æ¬¡ä»é˜Ÿåˆ—é‡Œè·å–250æ¡æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¶ˆè´¹è€…ä¼šä¸€æ¬¡é¢„æ”¯250æ¡æ¶ˆæ¯ï¼Œèƒ½åŠ›å·®çš„æ¶ˆè´¹è€…è¿™250æ¡æ¶ˆæ¯å¯èƒ½ä¼šå¤„ç†å¾ˆä¹…ã€‚è¿™ç‚¹åœ¨æˆ‘ä»¬çš„ä»»åŠ¡ä¸­è¡¨ç°çš„æä¸ºæ˜æ˜¾ã€‚æˆ‘æœ‰ä¸€ä¸ª7650GREçš„å¡å’Œä¸€å¼ 4090çš„å¡ï¼ŒåŒæ—¶ç”¨è¿™ä¸¤ä¸ªæœ¬åœ°æœºå™¨æ¶ˆè´¹æ¶ˆæ¯ï¼Œæ˜¾ç„¶7650GREçš„èƒ½åŠ›æ¯”ä¸ä¸Š4090ï¼Œ250æ¡æ¶ˆæ¯è¦å¤„ç†å¾ˆä¹…æ‰èƒ½ç»“æŸï¼Œä½†æ˜¯æˆ‘ä»¬çš„é¡¹ç›®æ˜¯ä¸€ä¸ªå®æ—¶èŠå¤©é¡¹ç›®ï¼Œå¯èƒ½4090å¤„ç†å®Œ250æ¡æ¶ˆæ¯ä¹‹ååˆä¼šæ¥ç€è·å–æ–°çš„æ¶ˆæ¯ï¼Œå¯¼è‡´åæ¥çš„æ¶ˆæ¯æ¯”å‰æ¥çš„æ¶ˆæ¯æ›´å¿«è¢«æ¨¡å‹å¤„ç†å’Œå“åº”ã€‚</p><p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬é™åˆ¶äº†æ¯ä¸ªæ¶ˆè´¹è€…ä¸€æ¬¡åªèƒ½è·å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¤„ç†å®Œä¹‹åæ‰èƒ½ç»§ç»­è·å–ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.rabbitmq.listener.simple.prefetch=1</span><br></pre></td></tr></table></figure><p>è¿™ç§æ¨¡å‹æœ€å…¸å‹çš„åº”ç”¨åœºæ™¯å°±æ˜¯æŠ¢çº¢åŒ…ï¼Œä½†æ˜¯å¯èƒ½ä¼šå‡ºç°çº¢åŒ…ä½™é¢è¢«é”™è¯¯ä¿®æ”¹çš„æƒ…å†µï¼Œè¿™ç§æ—¶å€™éœ€è¦å¯¹çº¢åŒ…ä½™é¢åŠ é”æˆ–è€…CASæ“ä½œã€‚</p><h3 id="å‘å¸ƒè®¢é˜…æ¨¡å¼">å‘å¸ƒè®¢é˜…æ¨¡å¼</h3><p>å‘å¸ƒè®¢é˜…æ¨¡å¼ä¸å·¥ä½œé˜Ÿåˆ—æ¨¡å¼ä¸åŒåœ¨äºï¼Œä¸€æ¡æ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œè¿™ç§åœ¨RabbitMQä¸­çš„å®ç°å°±æ˜¯fanoutäº¤æ¢æœºï¼Œfanoutäº¤æ¢æœºå°†è·å¾—çš„æ¶ˆæ¯æ‰‡å‡ºåˆ°bindåˆ°å®ƒä¸Šé¢çš„æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œæ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œè¿™æ ·å³å¯æ„æˆå‘å¸ƒè®¢é˜…æ¨¡å¼ã€‚</p><p><img src="/picture/sub.png" alt="å‘å¸ƒè®¢é˜…æ¨¡å¼"></p><p>è¿™ç§æ¨¡å¼æœ€ä¸ºç»å…¸çš„ç±»æ¯”å°±æ˜¯å¹¿æ’­æ¶ˆæ¯ã€‚ä½†æ˜¯è¿™ç§æ¨¡å¼å’Œåé¢çš„è·¯ç”±æ¨¡å¼çš„å·®åˆ«å°±åœ¨äºæ— æ³•è¿‡æ»¤æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯è¯´è¦æ‰‡å‡ºå°±ä¼šæ‰‡å‡ºåˆ°å…¨éƒ¨ç»‘å®šçš„é˜Ÿåˆ—ã€‚</p><h3 id="è·¯ç”±æ¨¡å¼">è·¯ç”±æ¨¡å¼</h3><p><img src="/picture/router.png" alt="è·¯ç”±æ¨¡å¼"></p><p>è·¯ç”±æ¨¡å¼æ ¹æ®ç”Ÿäº§è€…æä¾›çš„è·¯ç”±keyå°†æ¶ˆæ¯å‘é€åˆ°ç»‘å®šåˆ°äº¤æ¢æœºä¸Šä¸”è·¯ç”±keyç¬¦åˆçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p><h3 id="Topicæ¨¡å¼">Topicæ¨¡å¼</h3><p>ä¸»é¢˜æ¨¡å¼ï¼Œæ˜¯ç”±è·¯ç”±æ¨¡å¼è¡ç”Ÿå‡ºæ¥çš„ä¸€ç§æ¨¡å¼ï¼Œè·¯ç”±æ¨¡å¼å¹¶ä¸æ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼Œè·¯ç”±Keyå¿…é¡»å®Œå…¨å¯¹åº”æ‰ä¼šå‘é€åˆ°å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½†æ˜¯ä¸»é¢˜æ¨¡å¼ä¸åŒï¼Œå¯ä»¥ä½¿ç”¨é€šé…ç¬¦åŒ¹é…</p><p><img src="/picture/topic.png" alt="Topicæ¨¡å¼"></p><ol><li><p>æ˜Ÿå· å’Œ äº•å·ä»£è¡¨é€šé…ç¬¦</p></li><li><p>æ˜Ÿå·åŒ¹é…1ä¸ªè¯, #åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯ï¼ˆ* åŒ¹é…ä¸€çº§ä»»æ„å¤šä¸ªå­—ç¬¦ï¼Œ# åŒ¹é…å¤šçº§ä»»æ„å¤šä¸ªå­—ç¬¦ï¼‰</p></li></ol><p>â€‹       ä¾‹å¦‚ï¼šroutingKeyä¸º&quot;user.#â€œï¼Œè¡¨ç¤ºå¯ä»¥åŒ¹é…&quot;user.add&quot;å’Œ&quot;user.add.logâ€ã€‚</p><p>â€‹       routingKeyä¸º&quot;user.*â€œï¼Œè¡¨ç¤ºå¯ä»¥åŒ¹é…&quot;user.addâ€ï¼Œå¯¹äº&quot;user.add.log&quot;åˆ™æ— æ³•åŒ¹é…ã€‚</p><ol start="3"><li><p>è·¯ç”±åŠŸèƒ½æ·»åŠ æ¨¡ç³ŠåŒ¹é…</p></li><li><p>æ¶ˆæ¯äº§ç”Ÿè€…äº§ç”Ÿæ¶ˆæ¯,æŠŠæ¶ˆæ¯äº¤ç»™äº¤æ¢æœº</p></li><li><p>äº¤æ¢æœºæ ¹æ®keyçš„è§„åˆ™æ¨¡ç³ŠåŒ¹é…åˆ°å¯¹åº”çš„é˜Ÿåˆ—,ç”±é˜Ÿåˆ—çš„ç›‘å¬æ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯æ¶ˆè´¹</p></li></ol><h2 id="å…·ä½“å®ç°">å…·ä½“å®ç°</h2><p>åˆ°è¿™é‡Œæˆ‘ä»¬å¤ä¹ å®Œäº†äº”ç§æ¨¡å¼ï¼Œæˆ‘ä»¬é€‰æ‹©äº†å·¥ä½œé˜Ÿåˆ—æ¨¡å¼ï¼ŒåŒæ—¶é™å®šæ¶ˆè´¹è€…åªèƒ½æ¶ˆè´¹ä¸€ä¸ªé˜Ÿåˆ—ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åœ¨å…·ä½“å®ç°ä¸­ï¼Œåˆ¤æ–­ç”¨æˆ·å‘æ¥çš„æ¶ˆæ¯æ˜¯å¦æ˜¯å‘ç»™æŒ‡å®šçš„æœºå™¨äººIDçš„ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬è®¾å®šä¸ºURobotï¼Œå¦‚æœæ˜¯è¿™ä¸ªIDï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å°†ç”¨æˆ·çš„UIDä»¥åŠç”¨æˆ·å‘é€çš„ä¿¡æ¯å…ˆç®€å•æ‰“ä¸ªä¿¡æ¯è¡¨ï¼Œæ‰“å®Œä¿¡æ¯è¡¨ä¹‹åç›´æ¥å°†è¿™ä¸ªä¿¡æ¯å°è£…ä¸ºä¸€ä¸ªæ¶ˆæ¯Dtoï¼Œåºåˆ—åŒ–ä¹‹ååŠ å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­å»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Constants.ROBOT_UID.equals(contactId)) &#123;</span><br><span class="line">    <span class="type">SysSettingDto</span> <span class="variable">sysSettingDto</span> <span class="operator">=</span> redisComponet.getSysSetting();</span><br><span class="line">    <span class="type">TokenUserInfoDto</span> <span class="variable">robot</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TokenUserInfoDto</span>();</span><br><span class="line">    robot.setUserId(sysSettingDto.getRobotUid());</span><br><span class="line">    robot.setNickName(sysSettingDto.getRobotNickName());</span><br><span class="line">    <span class="type">ChatMessage</span> <span class="variable">robotChatMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChatMessage</span>();</span><br><span class="line">    robotChatMessage.setContactId(sendUserId);</span><br><span class="line">    <span class="comment">//å°è£…æ¶ˆæ¯è£…åˆ°ä½œä¸ºAIè¿”å›å‘é€åœ°å€ä»¥åŠpromptå‡†å¤‡åŠ å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­å»</span></span><br><span class="line">    robotChatMessage.setMessageType(MessageTypeEnum.CHAT.getType());</span><br><span class="line">    <span class="type">AIRabbitDto</span> <span class="variable">aIRabbitDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AIRabbitDto</span>();</span><br><span class="line">    aIRabbitDto.setChatMessage(robotChatMessage);</span><br><span class="line">    aIRabbitDto.setMessage(chatMessage.getMessageContent());</span><br><span class="line">    aIRabbitDto.setTokenUserInfoDto(robot);</span><br><span class="line">  <span class="comment">//å°†å¯¹åº”çš„æ¶ˆæ¯æŠ•é€’åˆ°å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­å»</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;dogie.direct&quot;</span>,<span class="string">&quot;chat&quot;</span>,JsonUtils.convertObj2Json(aIRabbitDto));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  messageHandler.sendMessage(messageSend);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬å°±éœ€è¦è®¾å®šå¯¹åº”çš„Listeneräº†ï¼Œè¿™é‡Œæˆ‘ä»¬å­˜ç•™äº†ä¸€ç‚¹ç§å¿ƒï¼Œå°±æ˜¯æˆ‘ä¸å¸Œæœ›ç”¨åˆ†ç¦»çš„æ–¹å¼æ¥å®ç°è¿™ä¸ªListenerï¼Œæˆ‘æœ€ä½³çš„æ„¿æœ›è‚¯å®šæ˜¯æˆ‘æœ‰å¤šä¸ªæœåŠ¡å™¨ï¼Œç„¶åæœ‰çš„æœåŠ¡å™¨æœ‰èƒ½åŠ›å¤„ç†æ¶ˆæ¯ä¼ é€’å’ŒAIåŠŸèƒ½ï¼Œæ²¡æœ‰AIåŠŸèƒ½çš„æœåŠ¡å™¨åªè´Ÿè´£å¯¹åº”çš„æ¶ˆæ¯ä¼ é€’ã€‚æ‰€ä»¥æˆ‘ä»¬ç»™Listenerçš„Beanä½¿ç”¨äº†@ConditionalOnPropertyæ³¨è§£ï¼Œå½“æœåŠ¡å™¨æœ‰èƒ½åŠ›å¤„ç†AIå¯¹è¯çš„æ—¶å€™ï¼Œå°±æŠŠé…ç½®æ–‡ä»¶ä¸­å¯¹åº”çš„å­—æ®µè®¾ç½®ä¸ºtrueï¼Œå¯¹åº”çš„æœåŠ¡å™¨å°±ä¼šæ³¨å†Œè¿™ä¸ªListenerçš„Beanï¼Œå°±ä¼šè¿›ä¸€æ­¥è°ƒç”¨listeneræ–¹æ³•ï¼Œå¦‚æœæœåŠ¡å™¨æ²¡æœ‰èƒ½åŠ›ï¼Œå°±ä¸æ³¨å†Œè¿™ä¸ªbeanï¼Œè‡ªç„¶ä¹Ÿä¸ä¼šä»æ¶ˆæ¯é˜Ÿåˆ—é‡Œå»å–è¿™ä¸ªä»»åŠ¡ã€‚</p><p>å…³äºAIçš„è°ƒç”¨ï¼Œæˆ‘çœ‹äº†æŒºå¤šåšå®¢çš„ï¼Œä»–ä»¬éƒ½è¯´SpringAIå¯ä»¥ç»§æ‰¿äº†ollamaçš„è°ƒç”¨ï¼Œæˆ‘å¥½åƒæ²¡æ‰¾ç€ï¼Œæ‰€ä»¥è¿˜æ˜¯æ‰‹æ“äº†ä¸€ä¸ªå‘æ¶ˆæ¯çš„æ–¹æ³•ï¼Œå°±æ˜¯ä½¿ç”¨OkHttpClientå»è°ƒè¿™ä¸ªapiï¼Œä¸ºäº†ç­‰å¾…å¼‚æ­¥æ¶ˆæ¯ç»“æŸï¼Œæˆ‘åŠ äº†ä¸ªCountDownLatch</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.karlyn.dogie.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.karlyn.dogie.entity.dto.AIRabbitDto;</span><br><span class="line"><span class="keyword">import</span> com.karlyn.dogie.entity.dto.OllamaResult;</span><br><span class="line"><span class="keyword">import</span> com.karlyn.dogie.entity.dto.TokenUserInfoDto;</span><br><span class="line"><span class="keyword">import</span> com.karlyn.dogie.entity.po.ChatMessage;</span><br><span class="line"><span class="keyword">import</span> com.karlyn.dogie.service.ChatMessageService;</span><br><span class="line"><span class="keyword">import</span> com.karlyn.dogie.util.JsonUtils;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> okhttp3.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.support.AmqpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.handler.annotation.Header;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(name = &quot;rabbit.listener.ai.enabled&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AIListener</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatMessageService chatMessageService;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;ai.timeout&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer timeout;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;ai.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String URL_OLLAMA;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;ai.model&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String MODEL_DEEPSEEK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AIListener</span><span class="params">(ChatMessageService chatMessageService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.chatMessageService = chatMessageService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;deepseek.queue&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">Listener</span><span class="params">(String msg, Channel channel, <span class="meta">@Header(AmqpHeaders.DELIVERY_TAG)</span> <span class="type">long</span> tag)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">AIRabbitDto</span> <span class="variable">aIRabbitDto</span> <span class="operator">=</span> JsonUtils.convertJson2Obj(msg, AIRabbitDto.class);</span><br><span class="line">        log.info(<span class="string">&quot;æ¶ˆè´¹æ¶ˆæ¯&quot;</span>);</span><br><span class="line">        log.info(aIRabbitDto.toString());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        getAiResult4Deepseek(aIRabbitDto.getMessage(),</span><br><span class="line">        aIRabbitDto.getChatMessage(),</span><br><span class="line">                            aIRabbitDto.getTokenUserInfoDto());</span><br><span class="line">          <span class="comment">//å¦‚æœæ¶ˆè´¹æˆåŠŸäº†ï¼Œå°±æ‰‹åŠ¨ç¡®è®¤ä¸€ä¸‹</span></span><br><span class="line">         channel.basicAck(tag, <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœæ¶ˆè´¹å¤±è´¥äº†å°±å¾—Nackä¸€ä¸‹ï¼ŒæŠŠå¯¹åº”çš„æ¶ˆæ¯é‡æ–°å¡å›æ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">            channel.basicNack(tag, <span class="literal">false</span>,<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getAiResult4Deepseek</span><span class="params">(String message, ChatMessage robotChatMessage, TokenUserInfoDto robot)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// è®¾å®šå¤´å‚æ•°</span></span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">&quot;prompt&quot;</span>, message);</span><br><span class="line">        params.put(<span class="string">&quot;model&quot;</span>, MODEL_DEEPSEEK);</span><br><span class="line">        params.put(<span class="string">&quot;stream&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        params.put(<span class="string">&quot;temperature&quot;</span>, <span class="number">0.7</span>);</span><br><span class="line">        params.put(<span class="string">&quot;top_p&quot;</span>, <span class="number">0.9</span>);</span><br><span class="line">        params.put(<span class="string">&quot;max_tokens&quot;</span>,<span class="number">400</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonParams</span> <span class="operator">=</span> JsonUtils.convertObj2Json(params);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºHttpè¯·æ±‚</span></span><br><span class="line">        Request.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder().url(URL_OLLAMA);</span><br><span class="line">        <span class="type">RequestBody</span> <span class="variable">body</span> <span class="operator">=</span> RequestBody.create(MediaType.parse(<span class="string">&quot;application/json; charset=utf-8&quot;</span>), jsonParams);</span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> builder.post(body).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é…ç½®OkHttpClient</span></span><br><span class="line">        <span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder()</span><br><span class="line">                .connectTimeout(timeout, TimeUnit.SECONDS)</span><br><span class="line">                .writeTimeout(timeout, TimeUnit.SECONDS)</span><br><span class="line">                .readTimeout(timeout, TimeUnit.SECONDS)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">eventLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);<span class="comment">//å®šä¹‰ä¸€ä¸ªåªæœ‰1çš„è®¡æ•°å™¨</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">resultBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(); <span class="comment">// ç”¨æ¥æ”¶é›†æ¶ˆæ¯</span></span><br><span class="line"></span><br><span class="line">        client.newCall(request).enqueue(<span class="keyword">new</span> <span class="title class_">Callback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Call call, IOException e)</span> &#123;</span><br><span class="line">                log.error(<span class="string">&quot;è¯·æ±‚å¤±è´¥&quot;</span>, e);</span><br><span class="line">                eventLatch.countDown(); <span class="comment">// è¯·æ±‚å¤±è´¥è®¡æ•°å™¨ä¹Ÿå‡ä¸€</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="keyword">if</span> (response.isSuccessful()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> (<span class="type">ResponseBody</span> <span class="variable">responseBody</span> <span class="operator">=</span> response.body()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (responseBody != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// è¯»å–å“åº”å†…å®¹</span></span><br><span class="line">                            <span class="type">String</span> <span class="variable">fullResponse</span> <span class="operator">=</span> responseBody.string();</span><br><span class="line">                          <span class="comment">//è¿™é‡Œæˆ‘æ˜¯å®šä¹‰äº†ä¸€ä¸ªå¯¹åº”çš„å‚æ•°æ¥è§£æè¿™ä¸ªresponseBody</span></span><br><span class="line">                            <span class="type">OllamaResult</span> <span class="variable">aiResult</span> <span class="operator">=</span> JsonUtils.convertJson2Obj(fullResponse, OllamaResult.class);</span><br><span class="line">                            log.info(aiResult.getResponse());</span><br><span class="line">                            resultBuffer.append(aiResult.getResponse()); <span class="comment">//è·å–æ¶ˆæ¯</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;è·å–å¤±è´¥&quot;</span>, response);</span><br><span class="line">                &#125;</span><br><span class="line">                eventLatch.countDown(); <span class="comment">// è¯·æ±‚æˆåŠŸè®¡æ•°å™¨å‡ä¸€</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        eventLatch.await(); <span class="comment">//ç­‰å¾…è®¡æ•°å™¨ä¸º0ï¼Œä¹Ÿå°±æ˜¯è¦ä¹ˆå¤±è´¥è¦ä¹ˆæˆåŠŸ</span></span><br><span class="line">        String[] messages = resultBuilder.toString().split(<span class="string">&quot;&lt;/think&gt;\n\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(messages.length&lt;=<span class="number">1</span>) messages[<span class="number">0</span>]=<span class="string">&quot;æœåŠ¡å™¨ç¹å¿™ï¼Œè¯·ç¨åå†è¯•&quot;</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœæˆåŠŸç›´æ¥æŠŠæ¶ˆæ¯å°è£…åˆ°Messageé‡Œå»ï¼Œç„¶åå°±å¯ä»¥æŠŠå®ƒç»§ç»­åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—é‡Œé¢å»ï¼Œä½†æ˜¯æ˜¯ç”¨æ¥è·¨æœåŠ¡å™¨é€šä¿¡çš„æ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">      <span class="comment">//åé¢è¿™ä¸ªbeanå°±æ˜¯åšè¿™ä»¶äº‹æƒ…çš„ï¼Œå†™è¡¨ç„¶ååŠ æ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">        robotChatMessage.setMessageContent(messages[messages.length - <span class="number">1</span>]);</span><br><span class="line">        chatMessageService.saveMessage(robotChatMessage, robot);</span><br><span class="line">        <span class="keyword">return</span> resultBuilder.toString(); <span class="comment">//è¿™ä¸ªè¿”å›å…¶å®æ²¡ä»€ä¹ˆç”¨ï¼Œæ˜¯æˆ‘åœ¨æµ‹è¯•çš„æ—¶å€™æ‰“å°çš„</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å¦‚æœæœ‰ä¸€ä¸ªéƒ¨ç½²åœ¨åœ¨å…¬ç½‘ä¸Šçš„æœåŠ¡ç«¯ï¼Œä½†æ˜¯ç®—åŠ›ä¸æ”¯æŒéƒ¨ç½²DeepSeekï¼Œä½†æ˜¯æœ¬åœ°æœ‰ä¸€ä¸ªæœºå™¨å¯ä»¥éƒ¨ç½²ï¼Œå¯ä»¥å°è¯•ç”¨RabbitMQæ¥æä¾›æ¶ˆæ¯çš„ä¸­è½¬ï¼Œå……å½“RPCè°ƒç”¨çš„æœåŠ¡ã€‚</summary>
    
    
    
    <category term="é¡¹ç›®" scheme="https://www.karlyn.xyz/categories/%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="Java" scheme="https://www.karlyn.xyz/tags/Java/"/>
    
    <category term="æ¶ˆæ¯é˜Ÿåˆ—" scheme="https://www.karlyn.xyz/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>èºæ—‹çŸ©é˜µæ±‡æ€»</title>
    <link href="https://www.karlyn.xyz/posts/spiral-matrix.html"/>
    <id>https://www.karlyn.xyz/posts/spiral-matrix.html</id>
    <published>2025-03-21T11:15:48.000Z</published>
    <updated>2025-03-28T14:47:26.995Z</updated>
    
    <content type="html"><![CDATA[<h1>å†™åœ¨å‰é¢</h1><p>å…¶å®èºæ—‹çŸ©é˜µç±»çš„é¢˜ç›®æŒ‰ç†æ¥è¯´åº”è¯¥æ˜¯ç®€å•çš„ï¼Œå› ä¸ºæ˜¯çº¯ç²¹çš„æ¨¡æ‹Ÿï¼Œåªä¸å¤§å®¶å®šä¹‰æ–¹å‘çš„æ–¹å¼å„æœ‰ä¸åŒï¼Œä»¥åŠæ–¹å‘çš„è½¬æ¢ä»¥åŠåˆ¤æ–­ä¸å¤Ÿçµæ´»ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ç®€å•è¯•è¯•ï¼</p><h1>èºæ—‹çŸ©é˜µ</h1><p><a href="https://leetcode.cn/problems/spiral-matrix/">LeetCodeåŸé¢˜é“¾æ¥</a></p><h2 id="é¢˜ç›®æè¿°">é¢˜ç›®æè¿°</h2><p>ç»™ä½ ä¸€ä¸ª <code>m</code> è¡Œ <code>n</code> åˆ—çš„çŸ©é˜µ <code>matrix</code> ï¼Œè¯·æŒ‰ç…§ <strong>é¡ºæ—¶é’ˆèºæ—‹é¡ºåº</strong> ï¼Œè¿”å›çŸ©é˜µä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚</p><p><strong>ç¤ºä¾‹1</strong></p><p><img src="https://assets.leetcode.com/uploads/2020/11/13/spiral1.jpg" alt="ç¤ºä¾‹1"></p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šmatrix = <span class="comment">[<span class="comment">[1,2,3]</span>,<span class="comment">[4,5,6]</span>,<span class="comment">[7,8,9]</span>]</span></span><br><span class="line">è¾“å‡ºï¼š<span class="comment">[1,2,3,6,9,8,7,4,5]</span></span><br></pre></td></tr></table></figure><p><strong>ç¤ºä¾‹ 2ï¼š</strong></p><p><img src="https://assets.leetcode.com/uploads/2020/11/13/spiral.jpg" alt="ç¤ºä¾‹2"></p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šmatrix = [[<span class="number">1,2,3,4</span>],[<span class="number">5,6,7,8</span>],[<span class="number">9,10,11,12</span>]]</span><br><span class="line">è¾“å‡ºï¼š[<span class="number">1,2,3,4</span>,<span class="number">8,12,11,10</span>,<span class="number">9,5,6,7</span>]</span><br></pre></td></tr></table></figure><p><strong>æç¤ºï¼š</strong></p><ul><li><code>m == matrix.length</code></li><li><code>n == matrix[i].length</code></li><li><code>1 &lt;= m, n &lt;= 10</code></li><li><code>-100 &lt;= matrix[i][j] &lt;= 100</code></li></ul><h2 id="è§£è¯»">è§£è¯»</h2><p>å…¶å®è¿™æ˜¯å¾ˆç»å…¸çš„é¡ºæ—¶é’ˆèºæ—‹çŸ©é˜µäº†ï¼Œåªéœ€è¦å®šä¹‰å¥½æ–¹å‘ï¼Œåˆ¤æ–­å¥½æ•°ç»„è¾¹ç•Œä»¥åŠå·²è®¿é—®è¾¹ç•Œï¼Œå°±å¯ä»¥å¾ˆé¡ºåˆ©è§£å†³äº†ã€‚æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬ç®€å•çœ‹çœ‹å®ç°ã€‚</p><p>æœ€é‡è¦çš„äº‹æƒ…å…¶å®æ˜¯å®šä¹‰å¥½æ–¹å‘ï¼Œç„¶åæ ¹æ®æ–¹å‘è¿›è¡Œèµ°æ­¥ã€‚</p><p>å­¦ä¼šä¼˜é›…çš„ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯å‹‡æ•¢çš„æ´¾å‡ºä¸€ä¸ªæ¢å­ï¼Œè®©å®ƒå»å°è¯•ï¼Œå¦‚æœå®ƒå¤±è´¥äº†æˆ‘ä»¬å°±æ¢æ–¹å‘èµ°ä¸€æ­¥ï¼Œå¦åˆ™å°±åŸæ–¹å‘èµ°ä¸€æ­¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;Integer&gt; <span class="title function_">spiralOrder</span><span class="params">(<span class="type">int</span>[][] matrix)</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> matrix.length;</span><br><span class="line">        <span class="type">int</span> m= matrix[<span class="number">0</span>].length;</span><br><span class="line">        <span class="comment">//æ­¤å¤„å®šä¹‰æ–¹å‘ï¼ŒæŒ‰åºåˆ†åˆ«ä¸ºå³ã€ä¸‹ã€å·¦ã€ä¸Šï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬èºæ—‹çš„é¡ºåº</span></span><br><span class="line">        <span class="type">int</span>[][] direction = &#123;&#123;<span class="number">0</span>,<span class="number">1</span>&#125;,&#123;<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">0</span>,-<span class="number">1</span>&#125;,&#123;-<span class="number">1</span>,<span class="number">0</span>&#125;&#125;;</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">        <span class="type">int</span> dir_key=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">0</span>; c &lt; n * m; c++)&#123;</span><br><span class="line">            res.add(matrix[i][j]);</span><br><span class="line">            <span class="comment">//å› ä¸ºæœ‰èŒƒå›´ä¸º-100ï¼Œ100ï¼Œæ ‡è®°å·²ç»è®¿é—®è¿‡å°±å¯ä»¥ç”¨101</span></span><br><span class="line">            matrix[i][j]=<span class="number">101</span>;</span><br><span class="line">            <span class="comment">//åˆ«ç®¡ç¢°ä¸ç¢°å£ï¼Œå…ˆæ´¾ä¸ªæ¢å­å»é€æ­»,å¦‚æœæ¢å­æ²¡äº‹æˆ‘ä»¬å°±åšæŒæ–¹å‘ï¼Œå¦‚æœæœ‰äº‹æˆ‘ä»¬å°±æ¢æ–¹å‘</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">i_try</span> <span class="operator">=</span> i + direction[dir_key][<span class="number">0</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">j_try</span> <span class="operator">=</span> j + direction[dir_key][<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span>(i_try&lt;<span class="number">0</span> || i_try&gt;=n || j_try&lt;<span class="number">0</span> || j_try&gt;=m || matrix[i_try][j_try]&gt;<span class="number">100</span>)&#123;</span><br><span class="line">                dir_key = (dir_key+<span class="number">1</span>)%<span class="number">4</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            i = i+direction[dir_key][<span class="number">0</span>];</span><br><span class="line">            j = j+direction[dir_key][<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>èºæ—‹çŸ©é˜µII</h1><p><a href="https://leetcode.cn/problems/spiral-matrix-ii/">LeetCodeåŸé¢˜é“¾æ¥</a></p><h2 id="é¢˜ç›®æè¿°-2">é¢˜ç›®æè¿°</h2><p>ç»™ä½ ä¸€ä¸ªæ­£æ•´æ•° <code>n</code> ï¼Œç”Ÿæˆä¸€ä¸ªåŒ…å« <code>1</code> åˆ° <code>n2</code> æ‰€æœ‰å…ƒç´ ï¼Œä¸”å…ƒç´ æŒ‰é¡ºæ—¶é’ˆé¡ºåºèºæ—‹æ’åˆ—çš„ <code>n x n</code> æ­£æ–¹å½¢çŸ©é˜µ <code>matrix</code> ã€‚</p><p><strong>ç¤ºä¾‹ 1ï¼š</strong></p><p><img src="https://assets.leetcode.com/uploads/2020/11/13/spiraln.jpg" alt="ç¤ºä¾‹1"></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šn = <span class="number">3</span></span><br><span class="line">è¾“å‡ºï¼š<span class="string">[[1,2,3],[8,9,4],[7,6,5]]</span></span><br></pre></td></tr></table></figure><p><strong>ç¤ºä¾‹ 2ï¼š</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šn = <span class="number">1</span></span><br><span class="line">è¾“å‡ºï¼š<span class="string">[[1]]</span></span><br></pre></td></tr></table></figure><p><strong>æç¤ºï¼š</strong></p><ul><li><code>1 &lt;= n &lt;= 20</code></li></ul><h2 id="è§£è¯»-2">è§£è¯»</h2><p>å…¶å®æœ¬è´¨ä¸Šå’Œä¸Šé¢˜æ˜¯åŒæ ·çš„æ€è·¯ï¼Œåªä¸è¿‡ä¸€ä¸ªæ˜¯å†™å…¥ï¼Œä¸€ä¸ªæ˜¯è¯»å–ï¼Œä¸å¤šèµ˜è¿°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[][] generateMatrix(<span class="type">int</span> n) &#123;</span><br><span class="line">        <span class="type">int</span>[][] res = <span class="keyword">new</span> <span class="title class_">int</span>[n][n];</span><br><span class="line">        <span class="type">int</span>[][] way = &#123;&#123;<span class="number">0</span>,<span class="number">1</span>&#125;,&#123;<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">0</span>,-<span class="number">1</span>&#125;,&#123;-<span class="number">1</span>,<span class="number">0</span>&#125;&#125;;</span><br><span class="line">        <span class="type">int</span> c=<span class="number">0</span>,l=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">way_key</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n*n;i++)&#123;</span><br><span class="line">            res[c][l]=i;</span><br><span class="line">            <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + way[way_key][<span class="number">0</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">nextl</span> <span class="operator">=</span> l + way[way_key][<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span> || nextc &gt;= n || nextl &lt; <span class="number">0</span> || nextl &gt;= n || res[nextc][nextl] != <span class="number">0</span>) &#123;</span><br><span class="line">                way_key = (way_key + <span class="number">1</span>) % <span class="number">4</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            c = c+way[way_key][<span class="number">0</span>];</span><br><span class="line">            l = l+way[way_key][<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>èºæ—‹çŸ©é˜µIII</h1><p>è¿™é¢˜è¿˜æœ‰æœ‰ä¸€ç‚¹ä»¤äººéš¾å—çš„ï¼Œå› ä¸ºéœ€è¦å‰ªææ‰èƒ½è®©æ•ˆç‡ç¨å¾®å¥½ä¸€äº›ï¼Œä½†æ˜¯æˆ‘å‰ªçš„ä¹Ÿä¸æ˜¯éå¸¸å¥½</p><p><a href="https://leetcode.cn/problems/spiral-matrix-iii/">LeetCodeåŸé¢˜é“¾æ¥</a></p><h2 id="é¢˜ç›®æè¿°-3">é¢˜ç›®æè¿°</h2><p>åœ¨ <code>rows x cols</code> çš„ç½‘æ ¼ä¸Šï¼Œä½ ä»å•å…ƒæ ¼ <code>(rStart, cStart)</code> é¢æœä¸œé¢å¼€å§‹ã€‚ç½‘æ ¼çš„è¥¿åŒ—è§’ä½äºç¬¬ä¸€è¡Œç¬¬ä¸€åˆ—ï¼Œç½‘æ ¼çš„ä¸œå—è§’ä½äºæœ€åä¸€è¡Œæœ€åä¸€åˆ—ã€‚</p><p>ä½ éœ€è¦ä»¥é¡ºæ—¶é’ˆæŒ‰èºæ—‹çŠ¶è¡Œèµ°ï¼Œè®¿é—®æ­¤ç½‘æ ¼ä¸­çš„æ¯ä¸ªä½ç½®ã€‚æ¯å½“ç§»åŠ¨åˆ°ç½‘æ ¼çš„è¾¹ç•Œä¹‹å¤–æ—¶ï¼Œéœ€è¦ç»§ç»­åœ¨ç½‘æ ¼ä¹‹å¤–è¡Œèµ°ï¼ˆä½†ç¨åå¯èƒ½ä¼šè¿”å›åˆ°ç½‘æ ¼è¾¹ç•Œï¼‰ã€‚</p><p>æœ€ç»ˆï¼Œæˆ‘ä»¬åˆ°è¿‡ç½‘æ ¼çš„æ‰€æœ‰ <code>rows x cols</code> ä¸ªç©ºé—´ã€‚</p><p>æŒ‰ç…§è®¿é—®é¡ºåºè¿”å›è¡¨ç¤ºç½‘æ ¼ä½ç½®çš„åæ ‡åˆ—è¡¨ã€‚</p><p><strong>ç¤ºä¾‹ 1ï¼š</strong></p><p><img src="https://s3-lc-upload.s3.amazonaws.com/uploads/2018/08/24/example_1.png" alt="ç¤ºä¾‹1"></p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šrows = 1, cols = 4, rStart = 0, cStart = 0</span><br><span class="line">è¾“å‡ºï¼š<span class="comment">[<span class="comment">[0,0]</span>,<span class="comment">[0,1]</span>,<span class="comment">[0,2]</span>,<span class="comment">[0,3]</span>]</span></span><br></pre></td></tr></table></figure><p><strong>ç¤ºä¾‹ 2ï¼š</strong></p><p><img src="https://s3-lc-upload.s3.amazonaws.com/uploads/2018/08/24/example_2.png" alt="ç¤ºä¾‹2"></p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šrows = 5, cols = 6, rStart = 1, cStart = 4</span><br><span class="line">è¾“å‡ºï¼š<span class="comment">[<span class="comment">[1,4]</span>,<span class="comment">[1,5]</span>,<span class="comment">[2,5]</span>,<span class="comment">[2,4]</span>,<span class="comment">[2,3]</span>,<span class="comment">[1,3]</span>,<span class="comment">[0,3]</span>,<span class="comment">[0,4]</span>,<span class="comment">[0,5]</span>,<span class="comment">[3,5]</span>,<span class="comment">[3,4]</span>,<span class="comment">[3,3]</span>,<span class="comment">[3,2]</span>,<span class="comment">[2,2]</span>,<span class="comment">[1,2]</span>,<span class="comment">[0,2]</span>,<span class="comment">[4,5]</span>,<span class="comment">[4,4]</span>,<span class="comment">[4,3]</span>,<span class="comment">[4,2]</span>,<span class="comment">[4,1]</span>,<span class="comment">[3,1]</span>,<span class="comment">[2,1]</span>,<span class="comment">[1,1]</span>,<span class="comment">[0,1]</span>,<span class="comment">[4,0]</span>,<span class="comment">[3,0]</span>,<span class="comment">[2,0]</span>,<span class="comment">[1,0]</span>,<span class="comment">[0,0]</span>]</span></span><br></pre></td></tr></table></figure><p><strong>æç¤ºï¼š</strong></p><ul><li><code>1 &lt;= rows, cols &lt;= 100</code></li><li><code>0 &lt;= rStart &lt; rows</code></li><li><code>0 &lt;= cStart &lt; cols</code></li></ul><h2 id="è§£è¯»-3">è§£è¯»</h2><p>å…¶å®è¿˜æ˜¯è€æ¨¡æ¿ï¼Œåªä¸è¿‡è¿™æ¬¡ä¸ä¼šç¢°å£ï¼Œæ˜¯ç”±å†…è€Œå¤–ï¼Œæ‰€ä»¥éœ€è¦è‡ªå·±åˆ¤æ–­èºæ—‹ä»€ä¹ˆæ—¶å€™éœ€è¦èµ°å¤šå°‘æ­¥ã€‚</p><p>å…¶å®æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåªè¦æ–¹å‘ç”±ä¸Šä¸‹å˜ä¸ºå·¦å³çš„æ—¶å€™ï¼Œå°±éœ€è¦æŠŠèºæ—‹çš„è¾¹é•¿å¢åŠ 1ï¼Œè¿™ç‚¹éœ€è¦è‡ªå·±å“å‘³ï¼Œä¸ºä»€ä¹ˆæˆ‘è®¾ç½®çš„åˆå§‹æ–¹å‘æ˜¯å‘ä¸Šï¼Œåˆå§‹stepæ˜¯0ï¼Œå…¶å®éƒ½æ˜¯æœ‰ä¸€ç‚¹æ„æ€çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[][] spiralMatrixIII(<span class="type">int</span> rows, <span class="type">int</span> cols, <span class="type">int</span> rStart, <span class="type">int</span> cStart) &#123;</span><br><span class="line">        <span class="type">int</span> r_n=rStart;</span><br><span class="line">        <span class="type">int</span> c_n=cStart;</span><br><span class="line">        <span class="type">int</span> <span class="variable">step</span> <span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span>[][] direction = &#123;&#123;<span class="number">0</span>,<span class="number">1</span>&#125;,&#123;<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">0</span>,-<span class="number">1</span>&#125;,&#123;-<span class="number">1</span>,<span class="number">0</span>&#125;&#125;;</span><br><span class="line">        <span class="type">int</span> <span class="variable">dir_key</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">        <span class="type">int</span> count=<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span>[][] res=<span class="keyword">new</span> <span class="title class_">int</span>[rows*cols][<span class="number">2</span>];</span><br><span class="line">        res[<span class="number">0</span>][<span class="number">0</span>]=r_n;</span><br><span class="line">        res[<span class="number">0</span>][<span class="number">1</span>]=c_n;</span><br><span class="line">        <span class="keyword">while</span>(count&lt;rows*cols)&#123;</span><br><span class="line">          <span class="comment">//æ–¹å‘è½¬æ¢</span></span><br><span class="line">            <span class="keyword">if</span>(dir_key%<span class="number">2</span>==<span class="number">1</span>)&#123;</span><br><span class="line">                step+=<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            dir_key = (dir_key+<span class="number">1</span>)%<span class="number">4</span>;</span><br><span class="line">          <span class="comment">//å‰ªæï¼Œå¦‚æœæ–¹å‘é”™äº†ï¼Œå°±ä¸ç”¨ä¸€æ­¥ä¸€æ­¥èµ°äº†ï¼Œåæ­£éƒ½ä¸ä¼šåŠ è¿›å»ï¼Œç›´æ¥ä¸€æ­¥èµ°åˆ°åº•</span></span><br><span class="line">            <span class="keyword">if</span>((r_n&lt;<span class="number">0</span>&amp;&amp;direction[dir_key][<span class="number">0</span>]&lt;=<span class="number">0</span>)||</span><br><span class="line">                (c_n&lt;<span class="number">0</span>&amp;&amp;direction[dir_key][<span class="number">1</span>]&lt;=<span class="number">0</span>)||</span><br><span class="line">                (r_n&gt;=rows&amp;&amp;direction[dir_key][<span class="number">0</span>]&gt;=<span class="number">0</span>)||</span><br><span class="line">                (c_n&gt;=cols&amp;&amp;direction[dir_key][<span class="number">1</span>]&gt;=<span class="number">0</span>))&#123;</span><br><span class="line">                r_n=r_n+direction[dir_key][<span class="number">0</span>]*step;</span><br><span class="line">                c_n=c_n+direction[dir_key][<span class="number">1</span>]*step;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          <span class="comment">// èµ°æ­¥</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;step;i++)&#123;</span><br><span class="line">                r_n=r_n+direction[dir_key][<span class="number">0</span>];</span><br><span class="line">                c_n=c_n+direction[dir_key][<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">if</span>(r_n&gt;=<span class="number">0</span>&amp;&amp;r_n&lt;rows&amp;&amp;c_n&gt;=<span class="number">0</span>&amp;&amp;c_n&lt;cols)&#123;</span><br><span class="line">                    res[count][<span class="number">0</span>]=r_n;</span><br><span class="line">                    res[count][<span class="number">1</span>]=c_n;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>èºæ—‹çŸ©é˜µIV</h1><p><a href="https://leetcode.cn/problems/spiral-matrix-iv/">LeetCodeåŸé¢˜é“¾æ¥</a></p><h2 id="é¢˜ç›®æè¿°-4">é¢˜ç›®æè¿°</h2><p>ç»™ä½ ä¸¤ä¸ªæ•´æ•°ï¼š<code>m</code> å’Œ <code>n</code> ï¼Œè¡¨ç¤ºçŸ©é˜µçš„ç»´æ•°ã€‚</p><p>å¦ç»™ä½ ä¸€ä¸ªæ•´æ•°é“¾è¡¨çš„å¤´èŠ‚ç‚¹ <code>head</code> ã€‚</p><p>è¯·ä½ ç”Ÿæˆä¸€ä¸ªå¤§å°ä¸º <code>m x n</code> çš„èºæ—‹çŸ©é˜µï¼ŒçŸ©é˜µåŒ…å«é“¾è¡¨ä¸­çš„æ‰€æœ‰æ•´æ•°ã€‚é“¾è¡¨ä¸­çš„æ•´æ•°ä»çŸ©é˜µ <strong>å·¦ä¸Šè§’</strong> å¼€å§‹ã€<strong>é¡ºæ—¶é’ˆ</strong> æŒ‰ <strong>èºæ—‹</strong> é¡ºåºå¡«å……ã€‚å¦‚æœè¿˜å­˜åœ¨å‰©ä½™çš„ç©ºæ ¼ï¼Œåˆ™ç”¨ <code>-1</code> å¡«å……ã€‚</p><p>è¿”å›ç”Ÿæˆçš„çŸ©é˜µã€‚</p><p><strong>ç¤ºä¾‹ 1ï¼š</strong></p><p><img src="https://assets.leetcode.com/uploads/2022/05/09/ex1new.jpg" alt="img"></p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šm = <span class="number">3</span>, n = <span class="number">5</span>, head = [<span class="number">3,0,2,6</span>,<span class="number">8,1,7,9</span>,<span class="number">4,2,5,5</span>,<span class="number">0</span>]</span><br><span class="line">è¾“å‡ºï¼š[[<span class="number">3,0,2,6</span>,<span class="number">8</span>],[<span class="number">5</span>,<span class="number">0</span>,-<span class="number">1</span>,-<span class="number">1</span>,<span class="number">1</span>],[<span class="number">5,2,4,9</span>,<span class="number">7</span>]]</span><br><span class="line">è§£é‡Šï¼šä¸Šå›¾å±•ç¤ºäº†é“¾è¡¨ä¸­çš„æ•´æ•°åœ¨çŸ©é˜µä¸­æ˜¯å¦‚ä½•æ’å¸ƒçš„ã€‚</span><br><span class="line">æ³¨æ„ï¼ŒçŸ©é˜µä¸­å‰©ä¸‹çš„ç©ºæ ¼ç”¨ -<span class="number">1</span> å¡«å……ã€‚</span><br></pre></td></tr></table></figure><p><strong>ç¤ºä¾‹ 2ï¼š</strong></p><p><img src="https://assets.leetcode.com/uploads/2022/05/11/ex2.jpg" alt="img"></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šm = <span class="number">1</span>, n = <span class="number">4</span>, head = [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>]</span><br><span class="line">è¾“å‡ºï¼š<span class="string">[[0,1,2,-1]]</span></span><br><span class="line">è§£é‡Šï¼šä¸Šå›¾å±•ç¤ºäº†é“¾è¡¨ä¸­çš„æ•´æ•°åœ¨çŸ©é˜µä¸­æ˜¯å¦‚ä½•ä»å·¦åˆ°å³æ’å¸ƒçš„ã€‚ </span><br><span class="line">æ³¨æ„ï¼ŒçŸ©é˜µä¸­å‰©ä¸‹çš„ç©ºæ ¼ç”¨ <span class="number">-1</span> å¡«å……ã€‚</span><br></pre></td></tr></table></figure><p><strong>æç¤ºï¼š</strong></p><ul><li><code>1 &lt;= m, n &lt;= 105</code></li><li><code>1 &lt;= m * n &lt;= 105</code></li><li>é“¾è¡¨ä¸­èŠ‚ç‚¹æ•°ç›®åœ¨èŒƒå›´ <code>[1, m * n]</code> å†…</li><li><code>0 &lt;= Node.val &lt;= 1000</code></li></ul><h2 id="è§£è¯»-4">è§£è¯»</h2><p>è¿™é¢˜ä¸å¤šè¯´å•Šï¼Œç›´æ¥ç…§æ¬IIçš„ä»£ç å°±å¯ä»¥äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for singly-linked list.</span></span><br><span class="line"><span class="comment"> * public class ListNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     ListNode next;</span></span><br><span class="line"><span class="comment"> *     ListNode() &#123;&#125;</span></span><br><span class="line"><span class="comment"> *     ListNode(int val) &#123; this.val = val; &#125;</span></span><br><span class="line"><span class="comment"> *     ListNode(int val, ListNode next) &#123; this.val = val; this.next = next; &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[][] spiralMatrix(<span class="type">int</span> m, <span class="type">int</span> n, ListNode head) &#123;</span><br><span class="line">        <span class="type">int</span>[][] res = <span class="keyword">new</span> <span class="title class_">int</span>[m][n];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;m;i++)&#123;</span><br><span class="line">            Arrays.fill(res[i],-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ­¤å¤„å®šä¹‰æ–¹å‘ï¼ŒæŒ‰åºåˆ†åˆ«ä¸ºå³ã€ä¸‹ã€å·¦ã€ä¸Šï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬èºæ—‹çš„é¡ºåº</span></span><br><span class="line">        <span class="type">int</span>[][] direction = &#123;&#123;<span class="number">0</span>,<span class="number">1</span>&#125;,&#123;<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">0</span>,-<span class="number">1</span>&#125;,&#123;-<span class="number">1</span>,<span class="number">0</span>&#125;&#125;;</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">        <span class="type">int</span> dir_key=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>;</span><br><span class="line">        ListNode pre=head;</span><br><span class="line">        <span class="keyword">while</span>(pre!=<span class="literal">null</span>)&#123;</span><br><span class="line">            res[i][j] = pre.val;</span><br><span class="line">            pre=pre.next;</span><br><span class="line">            <span class="comment">//åˆ«ç®¡ç¢°ä¸ç¢°å£ï¼Œå…ˆæ´¾ä¸ªæ¢å­å»é€æ­»,å¦‚æœæ¢å­æ²¡äº‹æˆ‘ä»¬å°±åšæŒæ–¹å‘ï¼Œå¦‚æœæœ‰äº‹æˆ‘ä»¬å°±æ¢æ–¹å‘</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">i_try</span> <span class="operator">=</span> i + direction[dir_key][<span class="number">0</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">j_try</span> <span class="operator">=</span> j + direction[dir_key][<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span>(i_try&lt;<span class="number">0</span> || i_try&gt;=m || j_try&lt;<span class="number">0</span> || j_try&gt;=n || res[i_try][j_try]!=-<span class="number">1</span>)&#123;</span><br><span class="line">                dir_key = (dir_key+<span class="number">1</span>)%<span class="number">4</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            i = i+direction[dir_key][<span class="number">0</span>];</span><br><span class="line">            j = j+direction[dir_key][<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…³äºè¾¹ç•Œå¤„ç†">å…³äºè¾¹ç•Œå¤„ç†</h2><p>å…¶å®Iå’ŒIVéƒ½å–å·§äº†ï¼Œå°±æ˜¯åœ¨åˆ¤æ–­æœ‰æ²¡æœ‰è¾¾åˆ°è¾¹ç•Œçš„æ—¶å€™ï¼Œç”¨äº†æ•°å€¼çš„èŒƒå›´ã€‚</p><p>æ‰€ä»¥å…¶å®å¢™å£ä¹Ÿéœ€è¦äº¤ç»™æˆ‘ä»¬ç®¡ç†çš„ï¼Œæ‰€ä»¥å¯¹äºIVçš„ä»£ç ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è¿™ä¹ˆå†™ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for singly-linked list.</span></span><br><span class="line"><span class="comment"> * public class ListNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     ListNode next;</span></span><br><span class="line"><span class="comment"> *     ListNode() &#123;&#125;</span></span><br><span class="line"><span class="comment"> *     ListNode(int val) &#123; this.val = val; &#125;</span></span><br><span class="line"><span class="comment"> *     ListNode(int val, ListNode next) &#123; this.val = val; this.next = next; &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[][] spiralMatrix(<span class="type">int</span> m, <span class="type">int</span> n, ListNode head) &#123;</span><br><span class="line">        <span class="type">int</span>[][] res = <span class="keyword">new</span> <span class="title class_">int</span>[m][n];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;m;i++)&#123;</span><br><span class="line">            Arrays.fill(res[i],-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ­¤å¤„å®šä¹‰æ–¹å‘ï¼ŒæŒ‰åºåˆ†åˆ«ä¸ºå³ã€ä¸‹ã€å·¦ã€ä¸Šï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬èºæ—‹çš„é¡ºåº</span></span><br><span class="line">        <span class="type">int</span>[][] direction = &#123;&#123;<span class="number">0</span>,<span class="number">1</span>&#125;,&#123;<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">0</span>,-<span class="number">1</span>&#125;,&#123;-<span class="number">1</span>,<span class="number">0</span>&#125;&#125;;</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">        <span class="type">int</span> dir_key=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>;</span><br><span class="line">        ListNode pre=head;</span><br><span class="line">      <span class="comment">//åˆå§‹åŒ–è¾¹ç•Œ</span></span><br><span class="line">        <span class="type">int</span> top=<span class="number">0</span>,left=<span class="number">0</span>,bottom=m-<span class="number">1</span>,right=n-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(pre!=<span class="literal">null</span>)&#123;</span><br><span class="line">            res[i][j] = pre.val;</span><br><span class="line">            pre=pre.next;</span><br><span class="line">            <span class="comment">//åˆ«ç®¡ç¢°ä¸ç¢°å£ï¼Œå…ˆæ´¾ä¸ªæ¢å­å»é€æ­»,å¦‚æœæ¢å­æ²¡äº‹æˆ‘ä»¬å°±åšæŒæ–¹å‘ï¼Œå¦‚æœæœ‰äº‹æˆ‘ä»¬å°±æ¢æ–¹å‘</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">i_try</span> <span class="operator">=</span> i + direction[dir_key][<span class="number">0</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">j_try</span> <span class="operator">=</span> j + direction[dir_key][<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span>(i_try&lt;top || i_try&gt;bottom || j_try&lt;left || j_try&gt;right)&#123;</span><br><span class="line">                <span class="comment">//ç¢°å£å°±ç¼©å°å¢™å£</span></span><br><span class="line">                dir_key = (dir_key+<span class="number">1</span>)%<span class="number">4</span>;</span><br><span class="line">                <span class="keyword">if</span>(dir_key==<span class="number">0</span>) left+=<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span>(dir_key==<span class="number">1</span>) top+=<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span>(dir_key==<span class="number">2</span>) right-=<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span>(dir_key==<span class="number">3</span>) bottom-=<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            i = i+direction[dir_key][<span class="number">0</span>];</span><br><span class="line">            j = j+direction[dir_key][<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å¦‚æœè§‰å¾—èºæ—‹çŸ©é˜µå†™çš„ä¸å¤Ÿä¼˜é›…å¯ä»¥çœ‹çœ‹è¿™ç¯‡ï¼Œè™½ç„¶æˆ‘ä¹Ÿå†™å¾—å¾ˆä¸€èˆ¬ã€‚</summary>
    
    
    
    <category term="åˆ·é¢˜" scheme="https://www.karlyn.xyz/categories/%E5%88%B7%E9%A2%98/"/>
    
    
    <category term="Java" scheme="https://www.karlyn.xyz/tags/Java/"/>
    
    <category term="Hot100" scheme="https://www.karlyn.xyz/tags/Hot100/"/>
    
  </entry>
  
  <entry>
    <title>IOæ¨¡å¼è¯¦è§£</title>
    <link href="https://www.karlyn.xyz/posts/io_introduce.html"/>
    <id>https://www.karlyn.xyz/posts/io_introduce.html</id>
    <published>2025-03-20T06:28:14.000Z</published>
    <updated>2025-03-21T02:01:19.840Z</updated>
    
    <content type="html"><![CDATA[<p><s>æˆ‘çœ‹äº†Bç«™ä¸€å †æ•™ç¨‹ï¼Œå¾ˆå°‘æœ‰èƒ½æŠŠIOå¤šè·¯å¤ç”¨è®²æ˜ç™½çš„ï¼Œæ‰€ä»¥æˆ‘è¯•ä¸€è¯•çœ‹çœ‹èƒ½ä¸èƒ½è®²æ˜ç™½å§ã€‚</s></p><p>è¯¯ï¼å…¶å®è¿˜æ˜¯æœ‰çš„ï¼Œæˆ‘è¿™é‡Œç›´æ¥æŒ‚ä¸ªé“¾æ¥ï¼</p><p><a href="https://www.bilibili.com/video/BV1gozdYSEkR">BIOã€NIOã€IOå¤šè·¯å¤ç”¨</a></p><h1>BIO</h1><p>BIOçš„æ¦‚å¿µæ˜¯åŒæ­¥é˜»å¡IOï¼Œä¸¤ä¸ªå…³é”®è¯ï¼ŒåŒæ­¥ï¼Œé˜»å¡ã€‚</p><p>åŒæ­¥åœ¨è¿™é‡Œä¸»è¦æ˜¯çœ‹æœ‰æ¶ˆæ¯è¿”å›ä¹‹åï¼Œæ˜¯å¦éœ€è¦åŸçº¿ç¨‹ç»§ç»­å¤„ç†ã€‚</p><p>é˜»å¡æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…æŸä¸ªæ“ä½œå®Œæˆæ—¶æš‚åœå…¶æ‰§è¡Œçš„çŠ¶æ€ã€‚</p><p>æˆ‘ä»¬ä»¥Socketé€šä¿¡çš„æ–¹å¼æ¥å®ç°è¿™äº›BIOï¼Œä»¥ä¸€æ–¹è¯·æ±‚å¦ä¸€æ–¹ä¸ºä¾‹å­ã€‚</p><p>æˆ‘ä»¬å…ˆè®¾è®¡ä¸€ä¸ªSocketçš„æœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯æ¯æ¬¡å‘æ¥æ¶ˆæ¯å°±è®©çº¿ç¨‹ä¼‘æ¯5sï¼Œæ¥æ¨¡æ‹Ÿæ‰§è¡Œè€—æ—¶ï¼Œ5såç»™å®¢æˆ·ç«¯å‘é€ä¸€æ¡æ¶ˆæ¯ã€‚</p><p>å½“å‰æˆ‘ä»¬è®¾è®¡ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä¸€å…±è¿›è¡Œå››æ¬¡è¾“å…¥ï¼Œç¬¬ä¸€æ¬¡å®¢æˆ·ç«¯è¾“å…¥ä¸é˜»å¡ç­‰å¸¦æœåŠ¡å™¨çš„è¿”å›ã€‚</p><p>æœåŠ¡ç«¯ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BIOServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//å®šä¹‰æœåŠ¡å™¨çš„æ¥æ”¶ç«¯å£</span></span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">8080</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Server started on port &quot;</span>+<span class="number">8080</span>);</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> serverSocket.accept();<span class="comment">//é˜»å¡ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">BioHandler</span>(socket)).start(); <span class="comment">// ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥å¯åŠ¨æ–°çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">BioHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> Socket socket;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">BioHandler</span><span class="params">(Socket socket)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.socket = socket;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="built_in">this</span>.socket.getInputStream()));</span><br><span class="line">                <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(<span class="built_in">this</span>.socket.getOutputStream(), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                String inputLine;</span><br><span class="line">                <span class="keyword">while</span> ((inputLine = in.readLine()) != <span class="literal">null</span>) &#123; <span class="comment">// é˜»å¡ç­‰å¾…è¾“å…¥</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;Received: &quot;</span> + inputLine);</span><br><span class="line">                    System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">                    <span class="comment">//sleep5sï¼Œæ¨¡æ‹Ÿå¤„ç†æ—¶é—´</span></span><br><span class="line">                    Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">                    out.println(<span class="string">&quot;Echo: &quot;</span> + inputLine); <span class="comment">// å›æ˜¾æ¶ˆæ¯</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    socket.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ä¸é˜»å¡ç­‰å¾…è¿”å›å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BIOClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//å‡è®¾æˆ‘ä»¬å›ºå®šæœåŠ¡å™¨çš„ç«¯å£å·ä¸º8080ï¼Œä¹‹åæˆ‘ä»¬ä¼šè®¿é—®è¿™ä¸ªç«¯å£å·ï¼Œç„¶åæˆ‘ä»¬ä¼šæ¨¡æ‹ŸæœåŠ¡å™¨éœ€è¦å¾ˆä¹…æ‰ä¼šè¿”å›</span></span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;localhost&quot;</span>,<span class="number">8080</span>);</span><br><span class="line">        <span class="comment">//å®šä¹‰å‘é€æµ</span></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(socket.getOutputStream(), <span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//å®šä¹‰æ¥å—æµ</span></span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(socket.getInputStream()));</span><br><span class="line">        System.out.println(<span class="string">&quot;Connected to server. Type messages and press enter.&quot;</span>);</span><br><span class="line">        String userInput;</span><br><span class="line">        <span class="comment">//æˆ‘ä¸€å…±è¿›è¡Œå››æ¬¡è¾“å…¥ï¼ŒæŒ‰ç†æ¥è¯´æˆ‘è¿™å››æ¬¡è¾“å…¥é—´éš”æ—¶é—´åº”è¯¥æ˜¯å¾ˆçŸ­çš„</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;=<span class="number">4</span>;i++)&#123;</span><br><span class="line">            userInput = <span class="string">&quot;mess&quot;</span>+i;</span><br><span class="line">            out.println(userInput); <span class="comment">// å‘é€åˆ°æœåŠ¡å™¨</span></span><br><span class="line">            System.out.println(<span class="string">&quot;æ¶ˆæ¯:\&quot;&quot;</span>+userInput+<span class="string">&quot;\&quot;å·²ç»æˆåŠŸå‘é€ï¼Œå½“å‰æ—¶é—´æ˜¯&quot;</span>+<span class="keyword">new</span> <span class="title class_">Date</span>());<span class="comment">//æè¿°æˆåŠŸå‘é€åˆ°æœåŠ¡å™¨</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        out.close();</span><br><span class="line">        in.close();</span><br><span class="line">        socket.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬çœ‹å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯åˆ†åˆ«çš„æ—¶é—´</p><p>å®¢æˆ·ç«¯</p><p><img src="/picture/bio_c_nBlock.png" alt="BIOéé˜»å¡å®¢æˆ·ç«¯"></p><p>æœåŠ¡ç«¯</p><p><img src="/picture/bio_s_nBlock.png" alt="BIOéé˜»å¡æœåŠ¡ç«¯"></p><p>å¯ä»¥çœ‹å‡ºï¼Œéé˜»å¡çš„å®¢æˆ·ç«¯æ˜¯èƒ½ç›´æ¥æŠŠå…¨éƒ¨çš„æ¶ˆæ¯å‘ç»™æœåŠ¡å™¨ç«¯çš„ï¼Œåªä¸è¿‡æœåŠ¡å™¨ç«¯æ˜¯ä¸€ä¸ªä¸€ä¸ªå¤„ç†çš„</p><p>é‚£å¦‚æœæˆ‘ä»¬çš„å®¢æˆ·ç«¯é˜»å¡ç­‰å¾…æœåŠ¡å™¨ç«¯çš„è¿”å›å‘¢ï¼Ÿ</p><p>åªéœ€è¦åœ¨å®¢æˆ·ç«¯é‡ŒåŠ ä¸Šä¸€è¡Œä»£ç å°±å¯ä»¥äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BIOClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//å‡è®¾æˆ‘ä»¬å›ºå®šæœåŠ¡å™¨çš„ç«¯å£å·ä¸º8080ï¼Œä¹‹åæˆ‘ä»¬ä¼šè®¿é—®è¿™ä¸ªç«¯å£å·ï¼Œç„¶åæˆ‘ä»¬ä¼šæ¨¡æ‹ŸæœåŠ¡å™¨éœ€è¦å¾ˆä¹…æ‰ä¼šè¿”å›</span></span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;localhost&quot;</span>,<span class="number">8080</span>);</span><br><span class="line">        <span class="comment">//å®šä¹‰å‘é€æµ</span></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(socket.getOutputStream(), <span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//å®šä¹‰æ¥å—æµ</span></span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(socket.getInputStream()));</span><br><span class="line">        System.out.println(<span class="string">&quot;Connected to server. Type messages and press enter.&quot;</span>);</span><br><span class="line">        String userInput;</span><br><span class="line">        <span class="comment">//æˆ‘ä¸€å…±è¿›è¡Œå››æ¬¡è¾“å…¥ï¼ŒæŒ‰ç†æ¥è¯´æˆ‘è¿™å››æ¬¡è¾“å…¥é—´éš”æ—¶é—´åº”è¯¥æ˜¯å¾ˆçŸ­çš„</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;=<span class="number">4</span>;i++)&#123;</span><br><span class="line">            userInput = <span class="string">&quot;mess&quot;</span>+i;</span><br><span class="line">            out.println(userInput); <span class="comment">// å‘é€åˆ°æœåŠ¡å™¨</span></span><br><span class="line">            System.out.println(<span class="string">&quot;æ¶ˆæ¯:\&quot;&quot;</span>+userInput+<span class="string">&quot;\&quot;å·²ç»æˆåŠŸå‘é€ï¼Œå½“å‰æ—¶é—´æ˜¯&quot;</span>+<span class="keyword">new</span> <span class="title class_">Date</span>());<span class="comment">//æè¿°æˆåŠŸå‘é€åˆ°æœåŠ¡å™¨</span></span><br><span class="line">            System.out.println(<span class="string">&quot;echo: &quot;</span> + in.readLine()); <span class="comment">// é˜»å¡ç­‰å¾…æœåŠ¡å™¨è¿”å›æ¶ˆæ¯</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        out.close();</span><br><span class="line">        in.close();</span><br><span class="line">        socket.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™æ—¶å€™å®¢æˆ·ç«¯çš„å‘é€çš„æ–¹å¼æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p><img src="/picture/bio_c_Block.png" alt="BIOé˜»å¡å®¢æˆ·ç«¯"></p><p>ä»ç»“æœæˆ‘ä»¬å‘ç°ï¼Œå®¢æˆ·ç«¯é˜»å¡åœ¨è¿™é‡Œï¼Œç­‰å¾…æœåŠ¡å™¨æ¶ˆè´¹å®Œä¸€æ¡æ¶ˆæ¯æ‰èƒ½æ‰§è¡Œè‡ªå·±æ¥ä¸‹æ¥è¦åšçš„äº‹æƒ…ï¼Œå¦‚æœè¿™æ—¶å€™å®¢æˆ·ç«¯ä¸æ˜¯è¦ç»™æœåŠ¡å™¨å‘é€æ¶ˆæ¯ï¼Œè€Œæ˜¯åšå…¶ä»–çš„äº‹æƒ…ï¼Œæ˜¯ä¸æ˜¯è¿™äº›ç­‰å¾…æ—¶é—´å°±æ˜¯ä¸å¿…è¦çš„ï¼Œå®Œå…¨å¯ä»¥å»åšå…¶ä»–çš„äº‹æƒ…ã€‚</p><p>é‚£ä¹ˆè¿™æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯èƒ½æœ‰è¿™æ ·ä¸€ç§æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸åœ¨è¿™é‡Œç­‰ç€æœåŠ¡å™¨å¤„ç†å®Œï¼Œæˆ‘å¯ä»¥å…ˆå»åšå…¶ä»–çš„äº‹æƒ…ï¼Œç„¶åæ—¶ä¸æ—¶çœ‹æœåŠ¡å™¨æœ‰æ²¡æœ‰å¤„ç†å®Œï¼Œå¤„ç†å®Œäº†æˆ‘å†è·å–è¿™ä¸ªæ•°æ®å‘¢ã€‚è¿™æ—¶å€™NIOå°±åº”è¿è€Œç”Ÿäº†ã€‚</p><h1>NIO</h1><p>NIOçš„æ¦‚å¿µæ˜¯åŒæ­¥éé˜»å¡IOï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä¸ç”¨é˜»å¡åœ¨è¿™é‡Œç­‰å¾…å¯¹æ–¹æ‰§è¡Œå®Œæ¯•ã€‚è€Œæ˜¯æˆ‘ä¼ é€’å®Œæ¶ˆæ¯ä¹‹åå°±å»åšæˆ‘è‡ªå·±çš„äº‹æƒ…ï¼Œæ—¶ä¸æ—¶çš„é€šè¿‡Selectoræ¥çœ‹ä¸€çœ‹å®ƒæ˜¯ä¸æ˜¯æœ‰è¿”å›å€¼ï¼Œä¹Ÿå°±æ˜¯ReadAbleçŠ¶æ€ã€‚</p><p>æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å°±é€šè¿‡Javaæ¥ç®€å•å®ç°ä¸€ä¸‹å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ã€‚</p><p>é¦–å…ˆä»‹ç»ä¸€ä¸‹Selectorï¼Œå®ƒæä¾›äº†ä¸€ç§æœºåˆ¶æ¥ç®¡ç†å¤šä¸ªé€šé“ï¼ˆChannelï¼‰çš„I/Oæ“ä½œã€‚é€šè¿‡ä½¿ç”¨selectorï¼Œå¯ä»¥åˆ©ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥ç›‘è§†å¤šä¸ªé€šé“ä¸Šçš„äº‹ä»¶ï¼ˆå¦‚è¿æ¥è¯·æ±‚ã€æ•°æ®åˆ°è¾¾ç­‰ï¼‰ï¼Œä»è€Œå®ç°é«˜æ•ˆçš„æœåŠ¡ç«¯åº”ç”¨è®¾è®¡ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤§é‡å¹¶å‘è¿æ¥æ—¶ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥æ”¹é€ å®¢æˆ·ç«¯å§ï¼Œæ”¹é€ æ¯”è¾ƒå®¹æ˜“ï¼Œé¦–å…ˆæ˜¯æ¶ˆæ¯å°±ä¸é€šè¿‡PrintWriterå‘é€äº†ï¼Œå› ä¸ºä»–ä»¬å±äºä¸åŒçš„I/Oæ¨¡å‹ï¼Œæˆ‘ä»¬è¿™æ¬¡å°±å¾—ä½¿ç”¨ByteBufferæ¥å­˜æˆ‘ä»¬çš„è¾“å…¥æ•°æ®ï¼Œç„¶åè®©Channelå»writeã€‚</p><p>åŒæ—¶å‘¢ï¼Œæˆ‘ä»¬éœ€è¦æŠŠChannelæ³¨å†Œåˆ°Selectorä¸Šå»ï¼Œè®©Selectoræ¥ä¸ºæˆ‘ä»¬è½®è¯¢Channelçš„çŠ¶æ€ï¼Œå½“ç„¶ä¹Ÿæœªå¿…æ˜¯è½®è¯¢ï¼Œåé¢æˆ‘ä»¬è®²åˆ°I/Oå¤šè·¯å¤ç”¨çš„æ—¶å€™ä¼šè¯´åˆ°ã€‚è™½ç„¶è¿™éƒ¨åˆ†çš„ä»£ç å†…å®¹ç¨å¤šä¸€äº›ï¼Œä½†æ˜¯æˆ‘çš„æ³¨é‡Šå†™çš„è¿˜æ˜¯æ¯”è¾ƒç¿”å®çš„ã€‚</p><p>æ¯”è¾ƒæœ‰è¶£çš„æ˜¯ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯çš„å®ç°æ²¡æœ‰è€ƒè™‘åˆ°ç²˜åŒ…é—®é¢˜ï¼Œåˆšå¥½è®©æˆ‘ç¢°åˆ°äº†æˆ‘ä»¥å‰æ¯”è¾ƒå¥½å¥‡ä¸ºä»€ä¹ˆä¼šå‡ºç°çš„ç²˜åŒ…é—®é¢˜ï¼Œè¿™éƒ¨åˆ†æˆ‘ä»¬ä¼šé€æ¸ä¼˜åŒ–ç»™å¤§å®¶çœ‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentLinkedQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentLinkedQueue&lt;String&gt; messageQueue = <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedQueue</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> count=<span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">clientChannel</span> <span class="operator">=</span> SocketChannel.open();</span><br><span class="line">        clientChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        clientChannel.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">8080</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">        <span class="comment">//å°†Channelæ³¨å†Œåˆ°selectorä¸­å»ï¼Œå¹¶ä¸”è®¾ç½®è¯¥é€šé“å…³æ³¨å¯è¿æ¥äº‹ä»¶</span></span><br><span class="line">        clientChannel.register(selector, SelectionKey.OP_CONNECT);</span><br><span class="line">        <span class="comment">//å½“channelæ²¡è¢«å…³çš„æ—¶å€™ä¸€ç›´å¾ªç¯</span></span><br><span class="line">        <span class="keyword">while</span> (clientChannel.isOpen()) &#123;</span><br><span class="line">            <span class="comment">//è¿™æ®µä»£ç è¿˜æ˜¯ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æœ‰æ³¨å†Œåˆ°selectorçš„é€šé“å‡†å¤‡å¥½äº†è¿›è¡ŒæŸé¡¹æ“ä½œ</span></span><br><span class="line">            selector.select();</span><br><span class="line">            <span class="comment">//ä¸€æ—¦ select() æ–¹æ³•è¿”å›ï¼Œé€šè¿‡è°ƒç”¨ selectedKeys() æ–¹æ³•æ¥è·å–ä¸€ä¸ªåŒ…å«æ‰€æœ‰å·²å‡†å¤‡å¥½è¿›è¡Œæ“ä½œçš„é€šé“çš„ SelectionKey é›†åˆã€‚</span></span><br><span class="line">            <span class="comment">// æ¯ä¸ª SelectionKey éƒ½ä»£è¡¨äº†ä¸€ä¸ªä¸ç‰¹å®šé€šé“å’Œæ“ä½œç›¸å…³çš„é”®ã€‚</span></span><br><span class="line">            <span class="comment">// è¿™äº›é”®åŒ…å«äº†å…³äºå“ªäº›é€šé“å‡†å¤‡å¥½è¿›è¡Œå“ªç§ç±»å‹çš„æ“ä½œçš„ä¿¡æ¯ï¼ˆä¾‹å¦‚å¯è¯»ã€å¯å†™ç­‰ï¼‰ã€‚</span></span><br><span class="line">            <span class="comment">// å…¶å®è¿™é‡ŒåŒ…å«äº†å¤šè·¯å¤ç”¨çš„å®ç°ï¼Œå› ä¸ºè·å¾—äº†å‡†å¤‡å¥½çš„æ‰€æœ‰channelçš„ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªchannelå‡†å¤‡å¥½äº†å°±åˆ‡æ¢å›ç”¨æˆ·æ€</span></span><br><span class="line">            Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; iter = keys.iterator();</span><br><span class="line">            <span class="comment">//ç„¶åå¯¹æ‰€æœ‰å‡†å¤‡å¥½çš„é€šé“ä¾æ¬¡å¤„ç†</span></span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iter.next();</span><br><span class="line">                iter.remove();</span><br><span class="line">                <span class="comment">//åœ¨ç¬¬ä¸€æ¬¡channelå¯ç”¨æ—¶å€™ï¼Œå…¶å®åªä¼šè§¦å‘è¿™ä¸ªisConnectable()ï¼Œå› ä¸ºæˆ‘ä»¬åªæ³¨å†Œè¯¥é€šé“ä¸ºå¯è¿æ¥çš„</span></span><br><span class="line">                <span class="comment">//è¿™æ—¶å€™å°±ä¼šè°ƒç”¨æˆ‘ä»¬å®šä¹‰å¥½çš„è¿æ¥handler</span></span><br><span class="line">                <span class="keyword">if</span> (key.isConnectable()) &#123;</span><br><span class="line">                    handleConnect(key);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//åœ¨ä¹‹åæˆ‘ä»¬å…³æ³¨äº†å¯å†™äº‹ä»¶ï¼Œå¦‚æœè¿™ä¸ªé€šé“å¯å†™äº†ï¼Œselectorè¿”å›çš„keyé‡Œå°±ä¼šè®¾ç½®ä¸ºå¯å†™çš„</span></span><br><span class="line">                <span class="comment">//è¿™æ—¶å€™å°±ä¼šè°ƒç”¨æˆ‘ä»¬å®šä¹‰å¥½çš„writeHandler</span></span><br><span class="line">                <span class="comment">//å¯å†™å…¶å®æ˜¯é¢‘ç¹è§¦å‘çš„</span></span><br><span class="line">                <span class="keyword">if</span> (key.isWritable()) &#123;</span><br><span class="line">                    handleWrite(key);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//è¿™æ—¶å€™å¦‚æœæœåŠ¡å™¨è¿”å›æ¶ˆæ¯äº†ï¼Œå°±ä¼šè§¦å‘å¯è¯»äº‹ä»¶ï¼Œselectorè¿”å›çš„keyé‡Œå°±ä¼šè®¾ç½®ä¸ºå¯è¯»çš„</span></span><br><span class="line">                <span class="comment">//è¿™æ—¶å€™å°±è°ƒç”¨æˆ‘ä»¬å®šä¹‰å¥½çš„readHandler</span></span><br><span class="line">                <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                    handleRead(key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        clientChannel.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿æ¥handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key selectorçš„åŒ…å«channelä¿¡æ¯ä»¥åŠå…¶å¯¹åº”ç±»å‹çš„key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleConnect</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//ä»keyé‡Œè·å–channel</span></span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">        <span class="comment">//å¦‚æœè¿æ¥å®Œæ¯•ï¼Œå°±è¦æŠŠchannelçš„å…³æ³¨åˆ‡æ¢ä¸ºå…³æ³¨å¯å†™äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (channel.finishConnect()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è¿æ¥å»ºç«‹æˆåŠŸï¼Œå¼€å§‹å‘é€æ•°æ®...&quot;</span>);</span><br><span class="line">            key.interestOps(SelectionKey.OP_WRITE);</span><br><span class="line">            <span class="comment">//å½“ç„¶å…¶å®ä¹Ÿå¯ä»¥è¿™ä¹ˆåˆ‡æ¢ï¼Œå°±æ˜¯æ—¢å…³æ³¨å¯å†™äº‹ä»¶ï¼Œåˆå…³æ³¨å¯è¯»äº‹ä»¶ï¼Œæ¯•ç«Ÿè°è§„å®šæœåŠ¡å™¨ä¸å¯ä»¥åœ¨è¿æ¥ä¸Šä¹‹åç»™å®¢æˆ·ç«¯å‘æ¶ˆæ¯çš„</span></span><br><span class="line">            <span class="comment">//key.interestOps(SelectionKey.OP_READ | SelectionKey.OP_WRITE);</span></span><br><span class="line">            <span class="comment">//è¿æ¥æˆåŠŸä¹‹åæˆ‘ä»¬å¾€æ¶ˆæ¯é˜Ÿåˆ—é‡ŒåŠ ç‚¹æ•°æ®</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                messageQueue.add(<span class="string">&quot;mess&quot;</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleWrite</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">        <span class="comment">//è§¦å‘å¯å†™äº‹ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä»æ¶ˆæ¯é˜Ÿåˆ—é‡ŒæŒ‘é€‰ä¸€æ¡æ¶ˆæ¯å‘è¿‡å»</span></span><br><span class="line">        <span class="comment">//æ‰€ä»¥æˆ‘ä»¬å¯èƒ½ä¼šè§¦å‘ç²˜åŒ…äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (!messageQueue.isEmpty()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è§¦å‘å¯å†™äº‹ä»¶ä¸”æœ‰æ¶ˆæ¯è¦å‘ï¼&quot;</span>);</span><br><span class="line">            <span class="comment">//åˆ†é…å†™å…¥å­—èŠ‚æµ</span></span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">50</span>);</span><br><span class="line">            <span class="comment">//ä»æ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> messageQueue.peek();</span><br><span class="line">            <span class="comment">//é‡ç½®ç¼“å†²åŒºï¼Œå°†é™åˆ¶è®¾ç½®ä¸º50ï¼Œå¹¶å°†ä½ç½®é‡ç½®ä¸º0</span></span><br><span class="line">            buffer.clear();</span><br><span class="line">            buffer.put(msg.getBytes());</span><br><span class="line">            <span class="comment">//å°†ç¼“å†²åŒºä»å†™æ¨¡å¼åˆ‡æ¢åˆ°è¯»æ¨¡å¼ã€‚</span></span><br><span class="line">            <span class="comment">//å®ƒé€šè¿‡è®¾ç½®é™åˆ¶ï¼ˆlimitï¼‰ä¸ºå½“å‰ä½ç½®ï¼Œå¹¶å°†ä½ç½®ï¼ˆpositionï¼‰é‡ç½®ä¸º0ã€‚</span></span><br><span class="line">            <span class="comment">//è¿™æ„å‘³ç€æ¥ä¸‹æ¥å¯ä»¥ä»ä½ç½®0å¼€å§‹è¯»å–æ•°æ®ï¼Œç›´åˆ°è¾¾åˆ°ä¹‹å‰çš„ä½ç½®ï¼ˆç°åœ¨å˜æˆäº†é™åˆ¶ï¼‰ã€‚</span></span><br><span class="line">            buffer.flip();</span><br><span class="line">            <span class="comment">//å‘channelå†™å…¥æ•°æ®</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">bytesWritten</span> <span class="operator">=</span> channel.write(buffer);</span><br><span class="line">            <span class="comment">//å¦‚æœå†™å…¥æ•°æ®é•¿åº¦ä¸º0ï¼Œå°±ä¸è¿›è¡Œæ¥ä¸‹æ¥çš„æ“ä½œäº†ï¼Œä¹Ÿå°±æ˜¯ä»æ¶ˆæ¯é˜Ÿåˆ—é‡Œåˆ é™¤ï¼Œé‚£æ—¶å€™å°±ä¼šé‡æ–°å‘é€æ¶ˆæ¯</span></span><br><span class="line">            <span class="keyword">if</span> (bytesWritten == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="comment">//å¦‚æœå…¨éƒ¨å†™å…¥æˆåŠŸï¼Œå°±ä¼šæŠŠæ¶ˆæ¯åˆ é™¤ï¼Œå¹¶ä¸”æ‰“å°å·²å‘é€</span></span><br><span class="line">            <span class="keyword">if</span> (!buffer.hasRemaining()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">sentMsg</span> <span class="operator">=</span> messageQueue.poll();</span><br><span class="line">                System.out.println(<span class="string">&quot;æ¶ˆæ¯:\&quot;&quot;</span> + sentMsg + <span class="string">&quot;\&quot;å·²å‘é€ï¼Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ‡æ¢å…³æ³¨è¯»äº‹ä»¶ï¼Œä½†ä¿æŒå†™äº‹ä»¶å…³æ³¨</span></span><br><span class="line">        key.interestOps(SelectionKey.OP_READ | SelectionKey.OP_WRITE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleRead</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">50</span>);</span><br><span class="line">        <span class="type">int</span> bytesRead;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((bytesRead = channel.read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//åŒæ ·æ˜¯æŠŠbufferè®¾ç½®ä¸ºè¯»çŠ¶æ€</span></span><br><span class="line">            buffer.flip();</span><br><span class="line">            <span class="comment">//è¯»å–å“åº”æ¶ˆæ¯</span></span><br><span class="line">            System.out.println(<span class="string">&quot;æ”¶åˆ°å“åº”ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, bytesRead)+<span class="string">&quot; ,å½“å‰æ—¶é—´æ˜¯:&quot;</span>+<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            buffer.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä¸ºäº†éªŒè¯è¯»æ¶ˆæ¯ä¹‹åè¿˜èƒ½è§¦å‘å†™äº‹ä»¶ï¼Œæˆ‘ä»¬æ¯æ¬¡è¯»å®Œå¾€messageQueueé‡ŒåŠ 2æ¡æ¶ˆæ¯</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> count; i &lt; count+<span class="number">2</span>; i++) &#123;</span><br><span class="line">            messageQueue.add(<span class="string">&quot;mess&quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        count+=<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥½ï¼Œè®¾è®¡å®Œå®¢æˆ·ç«¯ä¹‹åï¼Œå°±æ˜¯è®¾è®¡æœåŠ¡ç«¯äº†ï¼Œä¸ä¹‹å‰BIOå¤„ç†å¤šä¸ªè¿æ¥çš„æ–¹å¼ä¸åŒï¼Œæˆ‘ä»¬æœåŠ¡ç«¯è¿™æ¬¡ä¸ä½¿ç”¨å¤šçº¿ç¨‹æ¥ç®¡ç†å¤šä¸ªè¿æ¥ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨Selectoræ¥ç®¡ç†å¤šä¸ªChannelï¼ŒServerSocketChannelå’ŒSocketChannelä¸€è§†åŒä»ï¼Œéƒ½äº¤ç»™ä¸€ä¸ªSelectorç®¡ç†ã€‚</p><p>è®©æˆ‘ä»¬ç«¯ä¸Šæ¥å§ï¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.ServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// NIOåŸºäºChannelæ§åˆ¶ï¼Œæ‰€ä»¥æœ‰Selectorç®¡ç†æ‰€æœ‰çš„Channel</span></span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">        <span class="comment">// è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼</span></span><br><span class="line">        serverSocketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// è®¾ç½®ç›‘å¬ç«¯å£</span></span><br><span class="line">        serverSocketChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line">        <span class="comment">// è®¾ç½®Selectorç®¡ç†æ‰€æœ‰Channel</span></span><br><span class="line">        <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">        <span class="comment">// æ³¨å†Œå¹¶è®¾ç½®è¿æ¥æ—¶å¤„ç†</span></span><br><span class="line">        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">        System.out.println(<span class="string">&quot;æœåŠ¡å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£ä¸ºï¼š&quot;</span> + <span class="number">8080</span>);</span><br><span class="line">        <span class="comment">// NIOä½¿ç”¨è½®è¯¢ï¼Œå½“æœ‰è¯·æ±‚è¿æ¥æ—¶ï¼Œåˆ™å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">keySelect</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (serverSocketChannel.isOpen()) &#123;</span><br><span class="line">            selector.select();</span><br><span class="line">            Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">next</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                <span class="keyword">if</span> (next.isAcceptable()) &#123;    <span class="comment">//  å¦‚æœæ˜¯è¿æ¥çš„</span></span><br><span class="line">                    <span class="type">SocketChannel</span> <span class="variable">accept</span> <span class="operator">=</span> serverSocketChannel.accept();</span><br><span class="line">                    <span class="keyword">if</span> (accept != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//æŠŠæ–°çš„ä¼šè¯æµ‹channelæ³¨å†Œåˆ°selectoré‡Œå»ï¼Œè®©Selectoræ¥ç®¡ç†å®ƒ</span></span><br><span class="line">                        accept.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                        <span class="comment">//å¹¶ä¸”æŠŠå®ƒçš„æ„Ÿå…´è¶£çŠ¶æ€å˜ä¸ºå¯è¯»çŠ¶æ€</span></span><br><span class="line">                        accept.register(selector,SelectionKey.OP_READ);</span><br><span class="line">                    &#125;</span><br><span class="line">                    iterator.remove();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//ä¸€æ—¦å¯è¯»äº†ï¼Œå°±ä»£è¡¨å®¢æˆ·ç«¯å‘æ¥äº†æ¶ˆæ¯ï¼Œé‚£æˆ‘ä»¬å°±å»å¤„ç†è¿™ä¸ªæ¶ˆæ¯</span></span><br><span class="line">                <span class="keyword">if</span>(next.isReadable())&#123;</span><br><span class="line">                    handleRead(next);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        serverSocketChannel.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å…¶å®å¤„ç†è¿™ä¸ªæ¶ˆæ¯æˆ‘ä»¬ä¾ç„¶æœ‰ä¸€å¤„æ˜¯é˜»å¡çš„ï¼Œå°±æ˜¯æˆ‘ä»¬è¿”å›ç»™å®¢æˆ·ç«¯çš„æ—¶å€™ï¼Œè¦æ±‚å®¢æˆ·ç«¯æ˜¯å†™å¯ç”¨çš„ã€‚</span></span><br><span class="line">    <span class="comment">//ä½†æ˜¯å†™å¯ç”¨çš„è§¦å‘æ˜¯å¾ˆå¤šæ¬¡çš„ï¼Œä¸€èˆ¬éƒ½æ˜¯å†™å¯ç”¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æ²¡æœ‰åšè¿‡å¤šçš„å¹²é¢„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleRead</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">50</span>);</span><br><span class="line">        buffer.clear();</span><br><span class="line">        <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> channel.read(buffer);</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, read).trim();</span><br><span class="line">        System.out.println(<span class="string">&quot;æœåŠ¡ç«¯æ”¶åˆ°æ¶ˆæ¯ï¼š&quot;</span>+msg);</span><br><span class="line">        <span class="type">String</span> <span class="variable">outMsg</span> <span class="operator">=</span> <span class="string">&quot;ã€Echoã€‘&quot;</span> + msg; <span class="comment">// ç”Ÿæˆå›åº”ä¿¡æ¯</span></span><br><span class="line">        <span class="comment">//æ¨¡æ‹Ÿæ¶ˆæ¯å¤„ç†æ—¶é•¿</span></span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        buffer.clear();</span><br><span class="line">        buffer.put(outMsg.getBytes());  <span class="comment">//å›ä¼ ä¿¡æ¯æ”¾å…¥ç¼“å†²åŒº</span></span><br><span class="line">        buffer.flip();</span><br><span class="line">        channel.write(buffer);<span class="comment">// å›ä¼ ä¿¡æ¯</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœåŠ¡å™¨çš„å®ç°æˆ‘ä»¬å†™çš„æ—¶å€™è¿˜æ˜¯é˜»å¡çš„ï¼Œä½†æ˜¯å…¶å®å†™å¯ç”¨è§¦å‘é¢‘ç‡æ˜¯å¾ˆé«˜çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä¸æŠŠè¿™ä¸ªé˜»å¡è€ƒè™‘è¿›å»äº†ã€‚</p><p>è¿™æ—¶å€™æˆ‘ä»¬èµ·ä¸€ä¸ªæœåŠ¡ç«¯ï¼Œä¸€ä¸ªå®¢æˆ·ç«¯çœ‹çœ‹æƒ…å†µå¦‚ä½•ï¼</p><p><img src="/picture/nio_single.png" alt="NIOå•å®¢æˆ·ç«¯"></p><p>æ˜¯ä¸æ˜¯å‡ºç°äº†ç²˜åŒ…é—®é¢˜ï¼åœ¨æœåŠ¡å™¨å¤„ç†mess0ï¼ˆä¹Ÿå°±æ˜¯sleep 5sçš„æ—¶å€™ï¼‰ï¼Œåé¢çš„mess1ã€mess2ã€mess3ã€mess4éƒ½åˆ°äº†ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨å¤´éƒ¨æˆ–è€…åŒºåˆ†ç¬¦å·æ¥è¿›è¡ŒåŒºåˆ†ï¼Œå¯¼è‡´å‡ºç°äº†ç²˜åŒ…é—®é¢˜ã€‚</p><p>ä½†æ˜¯æ°æ°æ˜¯è¿™ä¸ªç²˜åŒ…ï¼Œä¹Ÿè¿›ä¸€æ­¥ä½è¯äº†æˆ‘ä»¬å®ç°äº†NIOï¼Œå› ä¸ºç²˜åŒ…æ˜¯NIOçš„å¸¸è§é—®é¢˜ä¹‹ä¸€ã€‚</p><p>é‚£æ˜¯å¦æˆ‘ä»¬çš„æœåŠ¡å™¨åœ¨ä¸ä½¿ç”¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œä¸é˜»å¡çš„åŒæ—¶å“åº”ä¸¤ä¸ªå®¢æˆ·ç«¯å‘¢ï¼Œæˆ‘ä»¬æ¥è¯•ä¸€ä¸‹å°±è¡Œå“©ï¼</p><p><img src="/picture/nio_two.png" alt="NIOå¤šå®¢æˆ·ç«¯"></p><p>ç”±æ­¤å¯è§ï¼Œæ˜¯å¯ä»¥çš„ï¼åªä¸è¿‡å•çº¿ç¨‹å“åº”å°±è¦åšå¥½é€ä¸ªå¤„ç†çš„ç¼“æ…¢å‡†å¤‡ã€‚</p><h2 id="å¦‚ä½•è§£å†³ç²˜åŒ…é—®é¢˜">å¦‚ä½•è§£å†³ç²˜åŒ…é—®é¢˜</h2><p>å…¶å®è§£å†³ç²˜åŒ…é—®é¢˜å¾ˆç®€å•ï¼Œå°±æ˜¯è®¾è®¡ä¸€ä¸ªè‡ªå·±é€šç”¨çš„åè®®ï¼Œæ¯”å¦‚è¯´è®¾å®šä¸€ä¸ªè‡ªå·±é€šç”¨çš„ç»ˆæ­¢ç¬¦å·æˆ–è€…è®¾è®¡ä¸€ä¸ªå®šé•¿çš„å¤´ï¼Œç”¨è¿™ä¸ªå¤´æ¥è§„å®šé•¿åº¦ã€‚</p><p>æˆ‘ä»¬å°±é€‰æ‹©åè€…å®ç°ã€‚</p><p>ä¸‹é¢æ˜¯æœåŠ¡ç«¯çš„ä»£ç ï¼Œè¿™éƒ¨åˆ†æ³¨é‡Šå°±å°‘å¾ˆå¤šäº†ï¼Œä¸»è¦è¿˜æ˜¯çœ‹handleReadéƒ¨åˆ†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.ServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// NIOåŸºäºChannelæ§åˆ¶ï¼Œæ‰€ä»¥æœ‰Selectorç®¡ç†æ‰€æœ‰çš„Channel</span></span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">        <span class="comment">// è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼</span></span><br><span class="line">        serverSocketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// è®¾ç½®ç›‘å¬ç«¯å£</span></span><br><span class="line">        serverSocketChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line">        <span class="comment">// è®¾ç½®Selectorç®¡ç†æ‰€æœ‰Channel</span></span><br><span class="line">        <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">        <span class="comment">// æ³¨å†Œå¹¶è®¾ç½®è¿æ¥æ—¶å¤„ç†</span></span><br><span class="line">        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">        System.out.println(<span class="string">&quot;æœåŠ¡å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£ä¸ºï¼š&quot;</span> + <span class="number">8080</span>);</span><br><span class="line">        <span class="comment">// NIOä½¿ç”¨è½®è¯¢ï¼Œå½“æœ‰è¯·æ±‚è¿æ¥æ—¶ï¼Œåˆ™å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">while</span> (serverSocketChannel.isOpen()) &#123;</span><br><span class="line">            selector.select();</span><br><span class="line">            Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">next</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                <span class="keyword">if</span> (next.isAcceptable()) &#123;    <span class="comment">//  å¦‚æœæ˜¯è¿æ¥çš„</span></span><br><span class="line">                    <span class="type">SocketChannel</span> <span class="variable">accept</span> <span class="operator">=</span> serverSocketChannel.accept();</span><br><span class="line">                    <span class="keyword">if</span> (accept != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//æŠŠæ–°çš„ä¼šè¯æµ‹channelæ³¨å†Œåˆ°selectoré‡Œå»ï¼Œè®©Selectoræ¥ç®¡ç†å®ƒ</span></span><br><span class="line">                        accept.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                        <span class="comment">//å¹¶ä¸”æŠŠå®ƒçš„æ„Ÿå…´è¶£çŠ¶æ€å˜ä¸ºå¯è¯»çŠ¶æ€</span></span><br><span class="line">                        accept.register(selector,SelectionKey.OP_READ);</span><br><span class="line">                    &#125;</span><br><span class="line">                    iterator.remove();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//ä¸€æ—¦å¯è¯»äº†ï¼Œå°±ä»£è¡¨å®¢æˆ·ç«¯å‘æ¥äº†æ¶ˆæ¯ï¼Œé‚£æˆ‘ä»¬å°±å»å¤„ç†è¿™ä¸ªæ¶ˆæ¯</span></span><br><span class="line">                <span class="keyword">if</span>(next.isReadable())&#123;</span><br><span class="line">                    handleRead(next);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        serverSocketChannel.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleRead</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">expectedLength</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        buffer.clear();</span><br><span class="line">        <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> channel.read(buffer);</span><br><span class="line">        <span class="keyword">if</span>(read ==-<span class="number">1</span> ) <span class="keyword">return</span>;</span><br><span class="line">        buffer.flip();</span><br><span class="line">        <span class="keyword">while</span> (buffer.remaining() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (expectedLength == -<span class="number">1</span>) &#123; <span class="comment">// ç­‰å¾…è¯»å–é•¿åº¦å¤´</span></span><br><span class="line">                <span class="keyword">if</span> (buffer.remaining() &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">                    expectedLength = buffer.getInt(); <span class="comment">// è¯»å–4å­—èŠ‚é•¿åº¦å¤´</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>; <span class="comment">// é•¿åº¦å¤´æœªæ¥æ”¶å®Œæ•´</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (buffer.remaining() &gt;= expectedLength) &#123;</span><br><span class="line">                <span class="type">byte</span>[] bodyBytes = <span class="keyword">new</span> <span class="title class_">byte</span>[expectedLength];</span><br><span class="line">                buffer.get(bodyBytes);</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bodyBytes);</span><br><span class="line">                System.out.println(<span class="string">&quot;æœåŠ¡ç«¯æ”¶åˆ°æ¶ˆæ¯ï¼š&quot;</span>+message);</span><br><span class="line">                <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> <span class="string">&quot;ã€Echoã€‘&quot;</span> + message;</span><br><span class="line">                <span class="comment">// æ¨¡æ‹Ÿå¤„ç†å»¶è¿Ÿ</span></span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">                <span class="type">byte</span>[] responseBytes = response.getBytes();</span><br><span class="line">                <span class="comment">// æ„é€ å“åº”ï¼š4å­—èŠ‚é•¿åº¦å¤´ + æ¶ˆæ¯ä½“</span></span><br><span class="line">                <span class="type">ByteBuffer</span> <span class="variable">responseBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">4</span> + responseBytes.length);</span><br><span class="line">                responseBuffer.putInt(responseBytes.length);</span><br><span class="line">                responseBuffer.put(responseBytes);</span><br><span class="line">                responseBuffer.flip();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å‘é€å“åº”</span></span><br><span class="line">                <span class="keyword">while</span> (responseBuffer.hasRemaining()) &#123;</span><br><span class="line">                    channel.write(responseBuffer);</span><br><span class="line">                &#125;</span><br><span class="line">                expectedLength = -<span class="number">1</span>; <span class="comment">// é‡ç½®ç­‰å¾…ä¸‹ä¸€ä¸ªæ¶ˆæ¯</span></span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>; <span class="comment">//æ¶ˆæ¯ä½“æœªæ¥æ”¶å®Œæ•´</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        buffer.compact(); <span class="comment">// å‹ç¼©ç¼“å†²åŒºï¼Œä¿ç•™æœªå¤„ç†æ•°æ®</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯éƒ¨åˆ†çš„ä»£ç ä¿®æ”¹ä¸ºä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentLinkedQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentLinkedQueue&lt;String&gt; messageQueue = <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedQueue</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> count=<span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">clientChannel</span> <span class="operator">=</span> SocketChannel.open();</span><br><span class="line">        clientChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        clientChannel.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">8080</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">        clientChannel.register(selector, SelectionKey.OP_CONNECT);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!messageQueue.isEmpty() || clientChannel.isOpen()) &#123;</span><br><span class="line">            selector.select();</span><br><span class="line">            Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; iter = keys.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iter.next();</span><br><span class="line">                iter.remove();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (key.isConnectable()) &#123;</span><br><span class="line">                    handleConnect(key);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (key.isWritable()) &#123;</span><br><span class="line">                    handleWrite(key);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                    handleRead(key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        clientChannel.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿æ¥handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key selectorçš„åŒ…å«channelä¿¡æ¯ä»¥åŠå…¶å¯¹åº”ç±»å‹çš„key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleConnect</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//ä»keyé‡Œè·å–channel</span></span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">        <span class="comment">//å¦‚æœè¿æ¥å®Œæ¯•ï¼Œå°±è¦æŠŠchannelçš„å…³æ³¨åˆ‡æ¢ä¸ºå…³æ³¨å¯å†™äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (channel.finishConnect()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è¿æ¥å»ºç«‹æˆåŠŸï¼Œå¼€å§‹å‘é€æ•°æ®...&quot;</span>);</span><br><span class="line">            key.interestOps(SelectionKey.OP_WRITE);</span><br><span class="line">            <span class="comment">//å½“ç„¶å…¶å®ä¹Ÿå¯ä»¥è¿™ä¹ˆåˆ‡æ¢ï¼Œå°±æ˜¯æ—¢å…³æ³¨å¯å†™äº‹ä»¶ï¼Œåˆå…³æ³¨å¯è¯»äº‹ä»¶ï¼Œæ¯•ç«Ÿè°è§„å®šæœåŠ¡å™¨ä¸å¯ä»¥åœ¨è¿æ¥ä¸Šä¹‹åç»™å®¢æˆ·ç«¯å‘æ¶ˆæ¯çš„</span></span><br><span class="line">            <span class="comment">//key.interestOps(SelectionKey.OP_READ | SelectionKey.OP_WRITE);</span></span><br><span class="line">            <span class="comment">//è¿æ¥æˆåŠŸä¹‹åæˆ‘ä»¬å¾€æ¶ˆæ¯é˜Ÿåˆ—é‡ŒåŠ ç‚¹æ•°æ®</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                messageQueue.add(<span class="string">&quot;mess&quot;</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleWrite</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">        <span class="comment">//è§¦å‘å¯å†™äº‹ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä»æ¶ˆæ¯é˜Ÿåˆ—é‡ŒæŒ‘é€‰ä¸€æ¡æ¶ˆæ¯å‘è¿‡å»</span></span><br><span class="line">        <span class="comment">//æ‰€ä»¥æˆ‘ä»¬å¯èƒ½ä¼šè§¦å‘ç²˜åŒ…äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (!messageQueue.isEmpty()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è§¦å‘å¯å†™äº‹ä»¶ä¸”æœ‰æ¶ˆæ¯è¦å‘ï¼&quot;</span>);</span><br><span class="line">            <span class="comment">//åˆ†é…å†™å…¥å­—èŠ‚æµ</span></span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">            <span class="comment">//ä»æ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> messageQueue.peek();</span><br><span class="line">            <span class="type">byte</span>[] msgBytes = msg.getBytes();</span><br><span class="line">            <span class="comment">//æ•°æ®æ€»é•¿ä¸º4+çœŸå®æ•°æ®ï¼Œ4æ˜¯ä¸€ä¸ªintï¼Œç”¨æ¥å­˜å‚¨æ•°æ®é•¿åº¦</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">totalLength</span> <span class="operator">=</span> <span class="number">4</span> + msgBytes.length; <span class="comment">// å¤´éƒ¨4å­—èŠ‚ + æ¶ˆæ¯ä½“</span></span><br><span class="line">            <span class="comment">//é‡ç½®ç¼“å†²åŒºï¼Œå°†é™åˆ¶è®¾ç½®ä¸º500ï¼Œå¹¶å°†ä½ç½®é‡ç½®ä¸º0</span></span><br><span class="line">            buffer.clear();</span><br><span class="line">            buffer.putInt(msgBytes.length); <span class="comment">// å†™å…¥4å­—èŠ‚é•¿åº¦å¤´ï¼ˆå¤§ç«¯åºï¼‰</span></span><br><span class="line">            buffer.put(msgBytes);           <span class="comment">// å†™å…¥æ¶ˆæ¯ä½“</span></span><br><span class="line">            <span class="comment">//å°†ç¼“å†²åŒºä»å†™æ¨¡å¼åˆ‡æ¢åˆ°è¯»æ¨¡å¼ã€‚</span></span><br><span class="line">            <span class="comment">//å®ƒé€šè¿‡è®¾ç½®é™åˆ¶ï¼ˆlimitï¼‰ä¸ºå½“å‰ä½ç½®ï¼Œå¹¶å°†ä½ç½®ï¼ˆpositionï¼‰é‡ç½®ä¸º0ã€‚</span></span><br><span class="line">            <span class="comment">//è¿™æ„å‘³ç€æ¥ä¸‹æ¥å¯ä»¥ä»ä½ç½®0å¼€å§‹è¯»å–æ•°æ®ï¼Œç›´åˆ°è¾¾åˆ°ä¹‹å‰çš„ä½ç½®ï¼ˆç°åœ¨å˜æˆäº†é™åˆ¶ï¼‰ã€‚</span></span><br><span class="line">            buffer.flip();</span><br><span class="line">            <span class="comment">//å‘channelå†™å…¥æ•°æ®</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">bytesWritten</span> <span class="operator">=</span> channel.write(buffer);</span><br><span class="line">            <span class="comment">//å¦‚æœå†™å…¥æ•°æ®é•¿åº¦ä¸º0ï¼Œå°±ä¸è¿›è¡Œæ¥ä¸‹æ¥çš„æ“ä½œäº†ï¼Œä¹Ÿå°±æ˜¯ä»æ¶ˆæ¯é˜Ÿåˆ—é‡Œåˆ é™¤ï¼Œé‚£æ—¶å€™å°±ä¼šé‡æ–°å‘é€æ¶ˆæ¯</span></span><br><span class="line">            <span class="keyword">if</span> (bytesWritten == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="comment">//å¦‚æœå…¨éƒ¨å†™å…¥æˆåŠŸï¼Œå°±ä¼šæŠŠæ¶ˆæ¯åˆ é™¤ï¼Œå¹¶ä¸”æ‰“å°å·²å‘é€</span></span><br><span class="line">            <span class="keyword">if</span> (!buffer.hasRemaining()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">sentMsg</span> <span class="operator">=</span> messageQueue.poll();</span><br><span class="line">                System.out.println(<span class="string">&quot;æ¶ˆæ¯:\&quot;&quot;</span> + sentMsg + <span class="string">&quot;\&quot;å·²å‘é€ï¼Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        key.interestOps(SelectionKey.OP_READ | SelectionKey.OP_WRITE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleRead</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">readBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        readBuffer.clear();</span><br><span class="line">        <span class="type">int</span> <span class="variable">bytesRead</span> <span class="operator">=</span> channel.read(readBuffer);</span><br><span class="line">        <span class="keyword">if</span> (bytesRead == -<span class="number">1</span>) &#123;</span><br><span class="line">            channel.close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        readBuffer.flip();</span><br><span class="line">        <span class="type">int</span> <span class="variable">expectedLength</span> <span class="operator">=</span>-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (readBuffer.remaining() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (expectedLength == -<span class="number">1</span>) &#123; <span class="comment">// ç­‰å¾…è¯»å–é•¿åº¦å¤´</span></span><br><span class="line">                <span class="keyword">if</span> (readBuffer.remaining() &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">                    expectedLength = readBuffer.getInt(); <span class="comment">// è¯»å–4å­—èŠ‚é•¿åº¦å¤´</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>; <span class="comment">// é•¿åº¦å¤´æœªæ¥æ”¶å®Œæ•´</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (readBuffer.remaining() &gt;= expectedLength) &#123;</span><br><span class="line">                <span class="type">byte</span>[] bodyBytes = <span class="keyword">new</span> <span class="title class_">byte</span>[expectedLength];</span><br><span class="line">                readBuffer.get(bodyBytes);</span><br><span class="line">                <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bodyBytes);</span><br><span class="line">                System.out.println(<span class="string">&quot;æ”¶åˆ°å“åº”ï¼š&quot;</span> + response + <span class="string">&quot;ï¼Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">                expectedLength = -<span class="number">1</span>; <span class="comment">// é‡ç½®ç­‰å¾…ä¸‹ä¸€ä¸ªæ¶ˆæ¯</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>; <span class="comment">// æ¶ˆæ¯ä½“æœªæ¥æ”¶å®Œæ•´,ç»§ç»­å›å»å€™ç€</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        readBuffer.compact(); <span class="comment">// å‹ç¼©ç¼“å†²åŒºï¼Œä¿ç•™æœªå¤„ç†æ•°æ®</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆçš„ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="/picture/nianbao.png" alt="è§£å†³NIOç²˜åŒ…é—®é¢˜"></p><p>å¯ä»¥å‘ç°ï¼ŒæˆåŠŸè§£å†³å“©ï¼</p><p>é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥è½¬æˆ˜I/Oå¤šè·¯å¤ç”¨äº†ã€‚</p><h1>I/Oå¤šè·¯å¤ç”¨</h1><p>å…¶å®ï¼Œåœ¨å®ç°ä¹‹å‰çš„NIOçš„æ—¶å€™ï¼Œæˆ‘ä»¬å·²ç»æœ‰ç”¨åˆ°I/Oå¤šè·¯å¤ç”¨äº†ï¼Œè¿˜è®°å¾—æˆ‘ä»¬ä½¿ç”¨äº†Selectorå—ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰çš„SocketChannelæ³¨å†Œåˆ°ä¸€ä¸ªSelectorä¸Šï¼ŒSelectorå¸®æˆ‘ä»¬åˆ¤æ–­ä»–ä»¬æ˜¯å¦èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬å…³æ³¨çš„äº‹ä»¶ï¼Œå¦‚æœèƒ½æ»¡è¶³æˆ‘ä»¬å…³æ³¨çš„äº‹ä»¶ï¼Œå°±è§¦å‘å¯¹åº”çš„äº‹ä»¶å…³æ³¨æ¨¡å¼ã€‚</p><p>é‚£è¿™æ—¶å€™å¤§å®¶æœ‰æ²¡æœ‰ä¸€ä¸ªç–‘æƒ‘å‘¢ï¼Ÿä¸ºä»€ä¹ˆè°ƒç”¨<code> Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</code>è¿™æ®µä»£ç ï¼Œè¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ªé›†åˆå‘¢ï¼Ÿå®ƒç›‘è§†äº†selectç®¡ç†çš„å…¨éƒ¨channelçš„çŠ¶æ€ï¼Œè¿™å°±æ˜¯IOå¤šè·¯å¤ç”¨çš„ä½“ç°ï¼ç”±æ­¤ï¼Œæˆ‘ä»¬åœ¨å®ç°NIOçš„æœåŠ¡å™¨çš„æ—¶å€™å¹¶æ²¡æœ‰åœ¨ç¨‹åºé‡Œæ˜¾ç¤ºåˆ›å»ºé¢å¤–çš„å­çº¿ç¨‹æ¥å“åº”ï¼Œè€Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦channelï¼Œå¹¶æŠŠå®ƒäº¤ç»™selectorç®¡ç†ï¼å®¢æˆ·ç«¯å…¶å®æ˜¯ä¸éœ€è¦IOå¤šè·¯å¤ç”¨çš„ï¼Œå› ä¸ºå®¢æˆ·ç«¯åªè®¾ç½®äº†ä¸€ä¸ªChannelã€‚</p><p>æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæ²¡æœ‰IOå¤šè·¯å¤ç”¨ï¼Œè¿™æ®µä»£ç çš„é€»è¾‘æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬è¿˜æ˜¯æ›´åŠ å…·ä½“çš„è®²ä¸€ä¸‹Selectorçš„å·¥ä½œæµç¨‹å§</p><ol><li><strong>æ³¨å†Œé€šé“ä¸å…´è¶£æ“ä½œ</strong>ï¼šé¦–å…ˆï¼Œé€šè¿‡è°ƒç”¨<code>SelectableChannel.register(Selector sel, int ops)</code>æ–¹æ³•å°†ä¸€ä¸ªæˆ–å¤šä¸ªé€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Šï¼Œå¹¶æŒ‡å®šå¯¹è¯¥é€šé“æ„Ÿå…´è¶£çš„I/Oæ“ä½œç±»å‹ï¼ˆå¦‚<code>OP_READ</code>, <code>OP_WRITE</code>, <code>OP_CONNECT</code>, æˆ– <code>OP_ACCEPT</code>ï¼‰ã€‚è¿™ä¸€æ­¥éª¤ä¸»è¦æ˜¯åœ¨ç”¨æˆ·æ€å®Œæˆçš„ã€‚</li><li><strong>è½®è¯¢è¯·æ±‚</strong>ï¼šå½“è°ƒç”¨<code>selector.select()</code>æˆ–è€…å…¶å˜ç§æ—¶ï¼ŒJavaç¨‹åºä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è§¦å‘ä¸€ä¸ªæ‰“æ–­ï¼Œç”±ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œç›´åˆ°è‡³å°‘æœ‰ä¸€ä¸ªå·²æ³¨å†Œçš„é€šé“å‡†å¤‡å¥½æ‰§è¡Œè‡³å°‘ä¸€ä¸ªä½ æ„Ÿå…´è¶£çš„æ“ä½œã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒJavaè¿è¡Œæ—¶ç¯å¢ƒä¼šå‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼ˆä¾‹å¦‚ï¼Œåœ¨Unix/Linuxç³»ç»Ÿä¸Šçš„<code>epoll_wait</code>æˆ–åœ¨Windowsä¸Šçš„<code>WSAWaitForMultipleEvents</code>ï¼‰ï¼Œè¿™äº›ç³»ç»Ÿè°ƒç”¨å®é™…ä¸Šä¼šä½¿æ§åˆ¶æƒè½¬ç§»åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚</li><li><strong>å†…æ ¸æ€å¤„ç†</strong>ï¼šä¸€æ—¦æ§åˆ¶æƒè½¬ç§»åˆ°å†…æ ¸ï¼Œæ“ä½œç³»ç»Ÿä¼šç›‘è§†æ‰€æœ‰è¢«æ³¨å†Œçš„é€šé“ï¼Œæ£€æŸ¥å®ƒä»¬æ˜¯å¦æ»¡è¶³ä»»ä½•å·²æ³¨å†Œçš„å…´è¶£æ¡ä»¶ã€‚è¿™ä¸€è¿‡ç¨‹é«˜æ•ˆåœ°åˆ©ç”¨äº†æ“ä½œç³»ç»Ÿæä¾›çš„äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼Œæ¯”å¦‚Linuxä¸Šçš„<code>epoll</code>ã€BSDç³»ç»Ÿä¸Šçš„<code>kqueue</code>æˆ–Windowsä¸Šçš„I/Oå®Œæˆç«¯å£(IOCP)ç­‰ã€‚å¦‚æœæŸä¸ªæˆ–æŸäº›é€šé“çš„çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–ï¼ˆä¾‹å¦‚ï¼Œæ–°çš„æ•°æ®åˆ°è¾¾ä½¿å¾—è¯»æ“ä½œå˜ä¸ºå¯èƒ½ï¼‰ï¼Œå†…æ ¸å°±ä¼šè¯†åˆ«å‡ºè¿™äº›äº‹ä»¶ã€‚</li><li><strong>è¿”å›ç”¨æˆ·æ€å¹¶æ›´æ–°å°±ç»ªçŠ¶æ€</strong>ï¼šå½“æœ‰é€šé“å˜å¾—â€œå°±ç»ªâ€æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šè¿”å›ç›¸åº”çš„ä¿¡æ¯ç»™Javaçš„NIOå±‚ï¼Œç„¶åä»<code>select()</code>æ–¹æ³•è¿”å›ï¼Œå…è®¸Javaç¨‹åºç»§ç»­æ‰§è¡Œã€‚æ­¤æ—¶ï¼Œä½ å¯ä»¥é€šè¿‡<code>selectedKeys()</code>æ–¹æ³•è·å–æ‰€æœ‰å·²ç»å‡†å¤‡å¥½çš„é€šé“å¯¹åº”çš„<code>SelectionKey</code>å¯¹è±¡é›†åˆï¼Œå¹¶å¯¹è¿™äº›é€šé“è¿›è¡Œç›¸åº”çš„I/Oæ“ä½œã€‚</li></ol><p>å¦‚æœæ²¡æœ‰IOå¤šè·¯å¤ç”¨å‘¢ï¼Ÿæ˜¯ä¸æ˜¯å¤„ç†å°±ä¸ä¸€æ ·äº†å‘¢ï¼Ÿéœ€è¦æ‰‹åŠ¨çš„éå†æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦æ‰‹åŠ¨éå†æ¯ä¸€ä¸ªChannelï¼Œç„¶åå»å†…æ ¸æ€åˆ¤æ–­ä»–ä»¬æ˜¯ä¸æ˜¯å¯æ¥å—ã€å¯è¿æ¥ã€å¯è¯»ã€å¯å†™çš„ï¼Œç„¶åå†å›åˆ°ç”¨æˆ·æ€æ¥è¿›è¡Œå¯¹åº”çš„æ“ä½œã€‚ä¼¼ä¹è¿™æ ·æ˜¯å¯è¡Œçš„ï¼Ÿ</p><p>ä½†æ˜¯éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œè¿™æ ·åˆä¸€ä¸ªå¾ˆæ˜æ˜¾çš„é—®é¢˜ï¼Œå°±æ˜¯é¢‘ç¹çš„è¿›è¡Œäº†ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œè¿™ç§åˆ‡æ¢æ˜¯éœ€è¦é¢å¤–è€—æ—¶çš„ã€‚</p><p>é‚£ä¹ˆé™¤æ­¤ä¹‹å¤–ï¼Œå…¶å®è¿˜æœ‰ä¸€äº›å…¶ä»–çš„é—®é¢˜ï¼š</p><ol><li>æ¯ä¸ªè¿æ¥éƒ½éœ€è¦ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æˆ–è¿›ç¨‹ï¼šåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸ºäº†å¤„ç†å¤šä¸ªå¹¶å‘è¿æ¥ï¼Œå¸¸è§çš„åšæ³•æ˜¯ä¸ºæ¯ä¸ªè¿æ¥åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æˆ–è¿›ç¨‹ã€‚è¿™ä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹å°†è´Ÿè´£æ‰§è¡Œè¯»å†™æ“ä½œï¼Œç›´åˆ°è¯¥è¿æ¥å…³é—­ã€‚è¿™å¯¼è‡´äº†æ‰€è°“çš„â€œä¸€è¿æ¥ä¸€çº¿ç¨‹â€æ¨¡å‹ã€‚</li><li>ç¼ºä¹é«˜æ•ˆçš„äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼šåœ¨æ²¡æœ‰IOå¤šè·¯å¤ç”¨ï¼ˆå¦‚selectã€pollã€epollç­‰ï¼‰çš„æƒ…å†µä¸‹ï¼Œç¨‹åºå‘˜éœ€è¦æ‰‹åŠ¨æ£€æŸ¥æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€ï¼Œæˆ–è€…ä¾èµ–äºæ¯ä¸ªçº¿ç¨‹/è¿›ç¨‹é˜»å¡åœ¨ä¸€ä¸ªç‰¹å®šçš„æ–‡ä»¶æè¿°ç¬¦ä¸Šç­‰å¾…æ•°æ®çš„åˆ°æ¥ã€‚è¿™ç§æ–¹å¼æ— æ³•é«˜æ•ˆåœ°ç®¡ç†å’Œç›‘æ§å¤§é‡æ–‡ä»¶æè¿°ç¬¦ã€‚</li><li>èµ„æºæ¶ˆè€—å¤§ä¸”æ‰©å±•æ€§å·®ï¼šç”±äºæ¯ä¸ªè¿æ¥éƒ½éœ€è¦ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æˆ–è¿›ç¨‹ï¼Œéšç€è¿æ¥æ•°çš„å¢åŠ ï¼Œç³»ç»Ÿèµ„æºï¼ˆå¦‚å†…å­˜å’ŒCPUæ—¶é—´ï¼‰ä¼šè¢«è¿…é€Ÿè€—å°½ã€‚æ­¤å¤–ï¼Œå¤§é‡çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä¹Ÿä¼šé™ä½ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ï¼Œä½¿å¾—è¿™ç§æ–¹æ³•éš¾ä»¥æ‰©å±•åˆ°æ”¯æŒæ•°åƒç”šè‡³æ•°ä¸‡ä¸ªå¹¶å‘è¿æ¥ã€‚</li></ol><p>æ‰€ä»¥è¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ç†è§£ä»€ä¹ˆæ˜¯IOå¤šè·¯å¤ç”¨äº†ï¼Œç®€å•æ¥è¯´å°±æ˜¯ï¼šå…è®¸å•ä¸ªçº¿ç¨‹åŒæ—¶ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚é‚£ä¹ˆå…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œå°±æ˜¯ä¸‹é¢è¦è®¨è®ºçš„å†…å®¹äº†ã€‚åˆ†ä¸ºï¼šselectã€pollã€epollä¸‰ç§ã€‚å…¶å®åˆ°åé¢å·²ç»æœ‰ç‚¹è„±ç¦»Javaçš„èŒƒç•´äº†ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæå‰è¯´ä¸€ä¸‹ã€‚Javaçš„Selectorçš„selectæ–¹æ³•æ˜¯çµæ´»çš„ï¼Œä¸»è¦è¿˜æ˜¯æ ¹æ®ç³»ç»Ÿä¸åŒæ¥å®ç°çš„ï¼Œå¦‚æœåœ¨Linuxå†…æ ¸ä¸Šï¼Œä¼šé»˜è®¤ä½¿ç”¨epollæ¥å®ç°ï¼Œå¦‚æœepollæœ‰äº›ç‰¹æ€§æ— æ³•æ»¡è¶³åˆ™ä¼šä½¿ç”¨pollã€‚åœ¨Windowså†…æ ¸ä¸Šå°±éœ€è¦ä½¿ç”¨selectæ¥å®ç°ã€‚</p><h2 id="Select">Select</h2><p>Selectæ¨¡å‹çš„å®ç°æ˜¯åŸºäºè½®è¯¢çš„ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸€æ¬¡éƒ½æŠŠæ–‡ä»¶æè¿°ç¬¦çš„bitmapä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ã€‚è¿™ä¸ªbitmapæœ€å¤§å¤§å°ä¸º1024ï¼Œæ‰€ä»¥selectæ¨¡å‹çš„ä¸€ä¸ªselectoræœ€å¤šåªèƒ½ç›‘ç®¡1024ä¸ªchannel</p><p>ç”¨æˆ·æ€çš„bitmapå­˜å‚¨äº†å“ªäº›æ–‡ä»¶æè¿°ç¬¦éœ€è¦è¢«ç›‘è§†ï¼Œå¦‚æœéœ€è¦è¢«ç›‘è§†ï¼Œbitmapå¯¹åº”ä½ç½®ç½®ä¸º1ã€‚</p><p>å†…æ ¸æ€éå†ä¸º1çš„bitmapï¼Œå¦‚æœæ–‡ä»¶æè¿°ç¬¦å·²ç»å°±ç»ªï¼Œé‚£å°±å°†å¯¹åº”ä½ç½®ç½®ä¸º1ï¼Œå¦åˆ™ä¸º0ï¼Œç„¶åå°†bitmapè¿”å›ç»™ç”¨æˆ·æ€</p><p>ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å°†å½“å‰è¿›ç¨‹çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€æ¬¡æ€§çš„ä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼›</li><li>åœ¨å†…æ ¸ä¸­å¿«é€Ÿçš„æ— å·®åˆ«éå†æ¯ä¸ªfdï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®åˆ°è¾¾ï¼›</li><li>å°†æ‰€æœ‰fdçŠ¶æ€ï¼Œä»å†…æ ¸æ€æ‹·è´åˆ°ç”¨æˆ·æ€ï¼Œå¹¶è¿”å›å·²å°±ç»ªfdçš„ä¸ªæ•°ï¼›</li><li>åœ¨ç”¨æˆ·æ€éå†åˆ¤æ–­å…·ä½“å“ªä¸ªfdå·²å°±ç»ªï¼Œç„¶åè¿›è¡Œç›¸åº”çš„äº‹ä»¶å¤„ç†ã€‚</li></ul><p>ç¼ºç‚¹æ˜¯å¾ˆæ˜æ˜¾çš„ï¼š</p><ol><li>èƒ½ç®¡ç†çš„æ–‡ä»¶æè¿°ç¬¦æœ‰é™ï¼Œæœ€å¤šä¸º1024</li><li>æ¯æ¬¡éƒ½éœ€è¦å°†æ–‡ä»¶æè¿°ç¬¦çš„bitmapä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œå†ä»å†…æ ¸æ€æ‹·è´åˆ°ç”¨æˆ·æ€</li><li>å†…æ ¸æ€è¿”å›bitmapä¹‹åï¼Œç”¨æˆ·æ€ä»ç„¶éœ€è¦éå†æ‰èƒ½çŸ¥é“å“ªä¸ªæ–‡ä»¶æè¿°ç¬¦å°±ç»ªäº†</li></ol><p>ä¸€å…±æœ‰ä¸‰ä¸ªbitmapï¼Œåˆ†åˆ«å¯¹åº”äº†readfdsã€writefdsã€errorfdsã€‚ä¸»è¦æ£€æŸ¥ä¸‰ä¸ªå¯¹åº”çš„é¡¹ç›®ã€‚</p><p>è¯»ç¼“å†²åŒºï¼ˆreadfdsï¼‰ï¼šæ£€æµ‹é‡Œè¾¹æœ‰æ²¡æœ‰æ•°æ®ï¼Œå¦‚æœæœ‰æ•°æ®è¯¥ç¼“å†²åŒºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å°±ç»ª<br>å†™ç¼“å†²åŒºï¼ˆwritefdsï¼‰ï¼šæ£€æµ‹å†™ç¼“å†²åŒºæ˜¯å¦å¯ä»¥å†™(æœ‰æ²¡æœ‰å®¹é‡)ï¼Œå¦‚æœæœ‰å®¹é‡å¯ä»¥å†™ï¼Œç¼“å†²åŒºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å°±ç»ª<br>è¯»å†™å¼‚å¸¸ï¼ˆerrorfdsï¼‰ï¼šæ£€æµ‹è¯»å†™ç¼“å†²åŒºæ˜¯å¦æœ‰å¼‚å¸¸ï¼Œå¦‚æœæœ‰è¯¥ç¼“å†²åŒºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å°±ç»ª</p><h2 id="Poll">Poll</h2><p>Pollæ¨¡å‹å…¶å®å’ŒSelectæ¨¡å‹æ˜¯æ¯”è¾ƒç±»ä¼¼çš„ï¼Œä¹Ÿæ˜¯éœ€è¦è½®è¯¢çš„ã€‚</p><p>åŒºåˆ«åœ¨äºï¼š</p><p>selectä½¿ç”¨ä½å›¾æ¥æ ‡è®°æƒ³å…³æ³¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä½¿ç”¨ä¸‰ä¸ªä½å›¾æ¥æ ‡è®°æƒ³å…³æ³¨çš„è¯»äº‹ä»¶ï¼Œå†™äº‹ä»¶ï¼Œé”™è¯¯äº‹ä»¶ã€‚</p><p>pollä½¿ç”¨ä¸€ä¸ªç»“æ„ä½“pollfdæ•°ç»„æ¥æ ‡å¿—æƒ³å…³æ³¨çš„æ–‡ä»¶æè¿°ç¬¦å’Œåœ¨è¿™ä¸ªæè¿°ç¬¦ä¸Šæ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œpollçš„ä¼˜ç‚¹æ˜¯æ•°ç»„çš„é•¿åº¦çªç ´äº†1024çš„é™åˆ¶ï¼Œå…¶ä»–çš„åŒºåˆ«ä¸å¤§ã€‚</p><p>selectå¯ä»¥è·¨å¹³å°ï¼Œä½†æ˜¯pollåªæ”¯æŒLinuxä½¿ç”¨</p><p>ä¸¤è€…åŒæ ·éƒ½éœ€è¦è¿›è¡Œå¤šæ¬¡å†…æ ¸æ€å’Œç”¨æˆ·æ€çš„æ‹·è´</p><h2 id="EPoll">EPoll</h2><p>å…¶å®epollæ‰æ˜¯æœ€éš¾ç†è§£çš„éƒ¨åˆ†ï¼Œä½†æ˜¯ä¹Ÿæ˜¯å¯¹å‰ä¸¤è€…è®¾è®¡äº†ä¼˜åŒ–ï¼Œè§£å†³äº†æ–‡ä»¶æè¿°ç¬¦é™åˆ¶å’Œå¤šæ¬¡å†…æ ¸æ€å’Œç”¨æˆ·æ€æ‹·è´å¯¼è‡´çš„æ€§èƒ½å¼€é”€é—®é¢˜ã€‚</p><p>Epollå…¶å®åŸºäºä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ¨¡å‹ï¼Œå°±æ˜¯äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œä½¿ç”¨äº†å›è°ƒæœºåˆ¶ã€‚</p><p>Selectæ¨¡å‹å’ŒPollæ¨¡å‹æ¯æ¬¡éƒ½éœ€è¦éå†å…¨éƒ¨çš„æ–‡ä»¶æè¿°ç¬¦æ¥æ£€æŸ¥å®ƒæ˜¯å¦å°±ç»ªï¼Œè€Œepollä¸åŒï¼Œå®ƒå…è®¸ç”¨æˆ·åœ¨æ³¨å†Œæ—¶æŒ‡å®šæ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œè¿™æ ·åœ¨äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå†…æ ¸åªéœ€è¦æ›´æ–°å®ƒçš„å†…éƒ¨æ•°æ®ç»“æ„ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½éå†å…¨éƒ¨çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><h3 id="æ‰§è¡ŒåŸç†">æ‰§è¡ŒåŸç†</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> num_size = <span class="number">5</span>;<span class="comment">//epollç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°ï¼Œå…¶å®åœ¨linux2.6.8çš„æ—¶å€™å°±å–æ¶ˆè¿™ä¸ªé™åˆ¶äº†ï¼Œè¿™ä¸ªæ•°å­—çš„å­˜åœ¨åªæ˜¯ä¸ºäº†å…¼å®¹</span></span><br><span class="line"><span class="type">int</span> epoll_fd = poll_create(num_size);<span class="comment">//åˆ›å»ºä¸€ä¸ªepollæ¨¡å‹ï¼Œå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">//ç„¶åä¼šåˆ›å»ºä¸€ä¸ªå†…éƒ¨æ•°æ®ç»“æ„ï¼Œé‡ç‚¹æ˜¯ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯çº¢é»‘æ ‘çš„æ ¹ï¼Œå¦ä¸€ä¸ªæ˜¯rd_listï¼Œä¹Ÿå°±æ˜¯å·²å°±ç»ªçš„åŒç«¯é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">//å‡è®¾è¿™ä¸ªæ—¶å€™æœ‰5ä¸ªå®¢æˆ·ç«¯è¿æ¥åˆ°äº†æœåŠ¡ç«¯ï¼Œepollå°±ä¼šè°ƒç”¨äº”æ¬¡event_ctlï¼Œä¼šåœ¨çº¢é»‘æ ‘ä¸Šåˆ›å»º5ä¸ªèŠ‚ç‚¹ï¼Œä½¿ç”¨çš„æ–¹æ³•æ˜¯ADDï¼Œå¦‚æœå·²ç»å»ºç«‹å®Œæˆå®¢æˆ·ç«¯ï¼Œå°±è¦ä½¿ç”¨MODä¿®æ”¹ç›‘å¬çš„äº‹ä»¶ä¸ºè¯»äº‹ä»¶</span></span><br><span class="line"><span class="comment">//event_ctlæ–¹æ³•éœ€è¦ä¼ å…¥çš„åŒ…æ‹¬çº¢é»‘æ ‘çš„æ ¹ä¹Ÿå°±æ˜¯evenæ¨¡å‹ï¼Œéœ€è¦æ“ä½œçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯¹è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œï¼Œéœ€è¦ç›‘è§†æ–‡ä»¶æè¿°ç¬¦äº‹ä»¶é›†åˆ</span></span><br><span class="line"><span class="comment">//event_ctlæ–¹æ³•å‘å†…å­˜æ³¨å†Œfdå’Œäº‹ä»¶çš„æ—¶å€™ï¼Œæ³¨å†Œäº†ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“æ“ä½œç³»ç»Ÿå°†æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒºåï¼Œå°±ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment">//åˆ›å»ºå®Œæˆä¹‹åï¼Œå¦‚æœæœ‰ä¸‰ä¸ªå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯çš„ç½‘å¡å‘é€æ•°æ®ï¼Œç½‘å¡ä¼šç”¨DMA-CopyæŠ€æœ¯å°†æ•°æ®æ‹·è´åˆ°å†…å­˜ç¼“å†²åŒºï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œè¿™æ—¶å€™ä¼šå°†ç¼“å†²åŒºçš„å†…å®¹å’Œæ–‡ä»¶æè¿°ç¬¦åŠ å…¥åˆ°rd_listï¼Œå…¶å®æ²¡æœ‰åšæ‹·è´æ“ä½œï¼Œåªæ˜¯åšäº†æŒ‡é’ˆçš„è¿æ¥æ“ä½œ</span></span><br><span class="line"><span class="comment">//è¿™æ—¶å€™å¦‚æœæœåŠ¡ç«¯è°ƒç”¨epoll_waitæ–¹æ³•ï¼Œå°±ä¼šåˆ¤æ–­å“ªäº›æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„å“ªäº›äº‹ä»¶å·²ç»å°±ç»ªäº†ï¼Œä¹Ÿå°±æ˜¯æŠŠrd_linkçš„å†…å®¹æ‹·è´åˆ°è¿”å›æ•°ç»„ä¸­ï¼Œç„¶åè¿”å›å†…æ ¸æ€</span></span><br></pre></td></tr></table></figure><h3 id="ä¸ºä»€ä¹ˆä¼šå¿«">ä¸ºä»€ä¹ˆä¼šå¿«</h3><p>åªæœ‰è¢«è°ƒç”¨epoll_waitæ–¹æ³•çš„æ—¶å€™ï¼Œepollæ‰ä¼šè¿›è¡Œä¸€æ¬¡å†…æ ¸æ€åˆ°ç”¨æˆ·æ€çš„æ‹·è´ï¼Œæ‰€ä»¥ä¸Šä¸‹æ–‡åˆ‡æ¢è¾ƒå°‘ã€‚</p><p>epollè¿”å›çš„äº‹ä»¶åªæœ‰å°±ç»ªçš„äº‹ä»¶ï¼Œä¸éœ€è¦éå†æ¯”è¾ƒã€‚</p><p>è€Œä¸”epollæ˜¯é€šè¿‡å›è°ƒçš„æ–¹å¼æ¥å°†å°±ç»ªçš„äº‹ä»¶åŠ å…¥åˆ°å°±ç»ªé˜Ÿåˆ—ä¸­ã€‚</p><h1>æ€»ç»“</h1><p>è‡³æ­¤ï¼ŒIOç³»åˆ—åŸºæœ¬å°±åˆ†æå®Œäº†ï¼Œå¦‚æœæœ‰é—®é¢˜æ¬¢è¿å„ç§å¹³å°äº¤æµã€‚</p>]]></content>
    
    
    <summary type="html">è®¾è®¡äº†ä¸€ä¸ªBIOå’ŒNIOçš„å°å®éªŒï¼ŒåŒ…å«IOè®¾è®¡æ¨¡å¼çš„ç†è§£ä»¥åŠNIOçš„ç²˜åŒ…é—®é¢˜å¤ç°åŠè§£å†³ã€I/Oå¤šè·¯å¤ç”¨</summary>
    
    
    
    <category term="ä»£ç å®ç°" scheme="https://www.karlyn.xyz/categories/%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0/"/>
    
    
    <category term="Java" scheme="https://www.karlyn.xyz/tags/Java/"/>
    
    <category term="IO" scheme="https://www.karlyn.xyz/tags/IO/"/>
    
  </entry>
  
  <entry>
    <title>BGPæ•´ç†</title>
    <link href="https://www.karlyn.xyz/posts/bgp_introduce.html"/>
    <id>https://www.karlyn.xyz/posts/bgp_introduce.html</id>
    <published>2025-03-19T01:46:56.000Z</published>
    <updated>2025-03-19T09:38:59.096Z</updated>
    
    <content type="html"><![CDATA[<h1>BGPæ•´ç†</h1><p>ä¸»è¿˜æ˜¯æ•´ç†ä¸€ä¸‹BGPç›¸å…³çš„å†…å®¹ï¼Œæ¯•ç«Ÿæœ‰ä¸€æ®µåœ¨BGPçš„å®ä¹ ï¼Œé˜²æ­¢è‡ªå·±é€æ¸å¿˜è®°ã€‚</p><h2 id="ç®€å•ä»‹ç»">ç®€å•ä»‹ç»</h2><p>BGPä¹Ÿæ˜¯è·¯ç”±åè®®ä¹‹ä¸€ï¼Œä¸»è¦ç”¨åœ¨ASé—´äº¤æ¢è·¯ç”±ä¿¡æ¯ï¼ˆeBGPï¼‰ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨åœ¨ASå†…äº¤æ¢è·¯ç”±ä¿¡æ¯ï¼ˆiBGPï¼‰ã€‚</p><p>ä¸å…¶ä»–è·¯ç”±åè®®åˆ©äºISISã€OSPFç­‰å»ºç«‹åœ¨IPåè®®ä¸Šï¼ŒRIPå»ºç«‹åœ¨UDPä¸Šä¸åŒï¼ŒBGPå»ºç«‹åœ¨<strong>TCP</strong>è¿æ¥ä¹‹ä¸Šï¼Œé»˜è®¤ç«¯å£å·æ˜¯<strong>179å·ç«¯å£</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œæœ‰ä¸ªè§‚å¿µï¼Œå°±æ˜¯BGPå…¶å®æ˜¯ä¸€ä¸ªåº”ç”¨å±‚çš„åè®®ï¼Œå³ä½¿å®ƒæ˜¯ä¸€ä¸ªè·¯ç”±åè®®ã€‚</p><p>BGPæ—¢ç„¶å»ºç«‹åœ¨TCPè¿æ¥ä¹‹ä¸Šï¼Œå°±è¦æ±‚BGPå¯¹ç­‰ä½“ä¹‹é—´æœ‰ç¨³å®šçš„è·¯ç”±é“¾è·¯è¿æ¥ï¼Œå¹¶ä¸è¦æ±‚å¯¹ç­‰ä½“ä¹‹é—´ç›´æ¥è¿æ¥ã€‚æ‰€ä»¥BGPæ‰€åœ¨ASå†…éœ€è¦é€šè¿‡ISISã€OSPFã€RIPç­‰å»ºç«‹èµ·è¿æ¥ï¼Œè€Œé€šè¿‡BGPå’Œå…¶ä»–è‡ªæ²»ç³»ç»Ÿé€šä¿¡ã€‚</p><p>BGPæ˜¯åŸºäºè·¯å¾„å‘é‡çš„ï¼Œè¿™æ—¢ä¸åŒäºè·ç¦»å‘é‡ï¼Œä¹Ÿä¸åŒäºé“¾è·¯çŠ¶æ€ã€‚BGPæ‰€è¦ä¼ é€’çš„ä¿¡æ¯ä¸ä»…åŒ…å«åˆ°è¾¾ç›®çš„åœ°çš„æœ€ä½³è·¯å¾„ï¼Œè¿˜ä¼šæºå¸¦æ‰€ç»è¿‡çš„å…¨éƒ¨è‡ªæ²»ç³»ç»Ÿçš„ASå·ï¼Œé¿å…è·¯ç”±ç¯è·¯ã€‚</p><p>åŒæ—¶ï¼ŒBGPè®¾å®šäº†å¾ˆå¤šå±æ€§å’Œç­–ç•¥ï¼Œå¯ä»¥æ ¹æ®ä»–ä»¬æ¥å†³ç­–ä¸åŒçš„æœ€ä½³è·¯å¾„ï¼ŒåŒ…æ‹¬ï¼šæœ¬åœ°ä¼˜å…ˆçº§ã€å¤šå‡ºå£åŒºåˆ†ç¬¦(MED)ï¼Œæƒé‡ç­‰ç­‰ã€‚</p><h3 id="å¸¸è§é—®é¢˜">å¸¸è§é—®é¢˜</h3><ol><li><p>ä¸ºä»€ä¹ˆå…¶ä»–è·¯ç”±ä¸é€‚åˆåšåŸŸé—´è·¯ç”±ï¼Ÿ</p><p>a. è·¯ç”±è§„æ¨¡é—®é¢˜ï¼ŒIGPä¸»è¦å…³æ³¨è¾ƒå°çš„ç½‘ç»œç¯å¢ƒï¼Œæ²¡æœ‰ä¸ºå¤„ç†å¤§é‡è·¯ç”±ä¿¡æ¯è€Œä¼˜åŒ–</p><p>b. ç­–ç•¥æ§åˆ¶æ–¹é¢ï¼Œå¸¸è§çš„IGPåè®®æ²¡æœ‰æä¾›BGPæ‰€æä¾›çš„è¯¸å¤šç­–ç•¥æ§åˆ¶å±æ€§ï¼Œä¸èƒ½å¯¹æµé‡è¿›è¡Œç»†ç²’åº¦æ§åˆ¶</p><p>c. é˜²ç¯æ–¹é¢ï¼Œä¸€äº›å¸¸ç”¨çš„IGPé˜²ç¯ç­–ç•¥ï¼ˆ1.æœ€å¤§è·³æ•°é™åˆ¶ï¼Œ2.æ°´å¹³åˆ†å‰²ï¼ˆæ¥å£aæ”¶åˆ°çš„è·¯ç”±ä¸ä¼šå†ä»æ¥å£aå¹¿æ’­å‡ºå»ï¼‰ï¼Œ3.æ¯’æ€§é€†è½¬ï¼ˆè·¯ç”±å¤±æ•ˆçš„æ—¶å€™å¹¶ä¸æ˜¯ç›´æ¥åˆ é™¤ï¼Œè€Œæ˜¯å‘ŠçŸ¥é‚»å±…è‡ªå·±ä¸å…¶è·ç¦»æ— ç©·å¤§ï¼‰ï¼‰åœ¨è·¨ASå…¶å®å¹¶ä¸èƒ½å¾ˆå¥½çš„ä½¿ç”¨</p></li><li><p>èŠåˆ°äº†IGPçš„é˜²ç¯ç­–ç•¥ï¼Œé‚£å°±èŠä¸€ä¸‹BGPçš„é˜²ç¯ç­–ç•¥å§</p><p>a. ASè·¯å¾„è¿‡æ»¤ï¼Œå°±æ˜¯å½“æ”¶åˆ°çš„è·¯ç”±æ›´æ–°ä¸­åŒ…å«è‡ªå·±çš„ASå·ï¼Œå°±å¿½ç•¥è¿™æ¡è·¯ç”±</p><p>b. IBGPæ°´å¹³åˆ†å‰²ï¼ŒiBGPä¸ä¼šæŠŠè‡ªå·±ä»å…¶ä»–iBGPé‚»å±…å­¦åˆ°çš„è·¯ç”±è½¬å‘ç»™å¦ä¸€ä¸ªiBGPé‚»å±…ï¼Œä½†æ˜¯å¯ä»¥è½¬å‘ç»™ä»–çš„eBGPé‚»å±…</p><p>c. è·¯ç”±åå°„å™¨ï¼Œè·¯ç”±åå°„å™¨å…è®¸ä¸€äº›è·¯ç”±å™¨ä½œä¸ºåå°„å™¨ï¼Œå¯ä»¥å°†ä»ä¸€ä¸ªiBGPé‚»å±…å­¦åˆ°çš„è·¯ç”±åå°„ç»™å…¶ä»–iBGPé‚»å±…ï¼Œè§£å†³äº†éœ€è¦å…¨è¿æ¥iBGPæ‰èƒ½é˜²ç¯çš„é—®é¢˜ã€‚è·¯ç”±åå°„å™¨RRä¼šæ¥å—ä¸å…¶å»ºç«‹iBGPè¿æ¥(å®¢æˆ·ç«¯)ä»¥åŠå…¶ä»–IGPè¿æ¥(éå®¢æˆ·ç«¯)çš„è·¯ç”±å™¨çš„æ¶ˆæ¯ï¼Œä»ä»å®¢æˆ·ç«¯å­¦åˆ°çš„è·¯ç”±åå°„ç»™å®¢æˆ·ç«¯å’Œéå®¢æˆ·ç«¯ï¼Œä»éå®¢æˆ·ç«¯å­¦åˆ°çš„è·¯ç”±ä»…åå°„ç»™å®¢æˆ·ç«¯ã€‚</p><p>è·¯ç”±åå°„å™¨ä¼šåœ¨è·¯ç”±æ›´æ–°ä¸­æ·»åŠ Originator_IDï¼Œè®°å½•åŸå§‹è·¯ç”±å™¨IDï¼Œå½“å†æ¬¡æ”¶åˆ°ç›¸åŒOriginator_IDçš„è·¯ç”±æ›´æ–°çš„æ—¶å€™å¿½ç•¥ã€‚</p><p>åŒæ—¶å¦‚æœå­˜åœ¨å¤šä¸ªè·¯ç”±åå°„å™¨ï¼Œæ¯ä¸ªè·¯ç”±åå°„å™¨ä¼šåœ¨Cluster_Listé‡Œæ·»åŠ è‡ªå·±çš„Cluster_IDï¼Œå¦‚æœå‘ç°è‡ªå·±çš„IDï¼Œå°±è¯æ˜é›†ç¾¤å†…å¾ªç¯ï¼Œç›´æ¥ä¸¢å¼ƒ</p><p>d. BGPè”é‚¦ã€‚ä¹Ÿå°±æ˜¯åœ¨ASå†…åˆ’åˆ†å¤šä¸ªBGPè”é‚¦ï¼Œæ¯ä¸ªè”é‚¦è‡ªæ²»ï¼Œå¯ä»¥ä½¿ç”¨è”é‚¦ASå·æ¥é¿å…ç¯è·¯</p></li><li><p>BGPå’ŒISISçš„åŒºåˆ«</p><p>a. ä¸€ä¸ªæ˜¯EGPï¼Œä¸€ä¸ªæ˜¯IGP</p><p>b. è¿è¡Œå±‚æ¬¡ï¼Œä¸€ä¸ªè¿è¡Œåœ¨TCPçš„179ç«¯å£ä¸Šï¼Œä¸€ä¸ªè¿è¡Œåœ¨IPåè®®ä¹‹ä¸Š</p><p>c. é‡‡ç”¨çš„è·¯ç”±ç®—æ³•ä¸åŒï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨è·¯å¾„å‘é‡ç®—æ³•ï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨é“¾è·¯çŠ¶æ€ç®—æ³•</p><p>d. é€‚ç”¨è§„æ¨¡ä¸åŒï¼ŒBGPé€‚ç”¨äºå¤§è§„æ¨¡ç»„ç½‘ï¼ŒISISé€‚åˆä¸­å¤§ä¼ä¸šå†…éƒ¨ç»„ç½‘</p><p>e. ç­–ç•¥æ§åˆ¶åŠ›åº¦ä¸åŒï¼ŒBGPæ”¯æŒæ›´åŠ ç»†ç²’åº¦çš„ç­–ç•¥æ§åˆ¶</p></li><li><p>BGPå’Œå…¶ä»–åè®®æ€ä¹ˆäº’ç›¸å­¦ä¹ </p><p>BGPæœ‰IGPè·¯ç”±å¼•å…¥</p></li></ol><h2 id="BGPçš„å±æ€§">BGPçš„å±æ€§</h2><ol><li><p>Originï¼Œè·¯ç”±æ¥æºï¼Œæ˜¯é€šè¿‡ä»€ä¹ˆåè®®å­¦åˆ°çš„ï¼Œæ¯”å¦‚IGPï¼ŒEGPï¼Œè¿˜æ˜¯é‡åˆ†å¸ƒ</p></li><li><p>AS_PATHï¼Œé€”ç»çš„å…¨éƒ¨ASå·ï¼Œä¸»è¦ç”¨äºé˜²ç¯å’Œæ ¹æ®è·¯å¾„é•¿åº¦é€‰è·¯</p></li><li><p>Next_Hopï¼Œä¸‹ä¸€è·³ï¼ŒiBGPä¸€èˆ¬ä¸ä¼šä¿®æ”¹ä¸‹ä¸€è·³ï¼ŒeBGPä¼šæŠŠä¸‹ä¸€è·³ä¿®æ”¹ä¸ºæœ¬åœ°è·¯ç”±å™¨çš„æ¥å£åœ°å€</p></li><li><p>MEDï¼Œå¤šå‡ºå£é‰´åˆ«å™¨ï¼Œä¸»è¦æ˜¯å½±å“å…¶ä»–è‡ªæ²»ç³»ç»Ÿå¦‚ä½•é€‰æ‹©è¿›å…¥æœ¬è‡ªæ²»ç³»ç»Ÿçš„è·¯å¾„ï¼Œè¾ƒä½å€¼ä¼˜å…ˆã€‚ä»…åœ¨ä¸¤ä¸ªç›¸é‚»çš„ASä¹‹å†…ç”Ÿæ•ˆã€‚</p></li><li><p>Local_Prefï¼Œæœ¬åœ°ä¼˜å…ˆçº§ï¼Œä¸»è¦æ˜¯ç”¨äºé€‰æ‹©æ€ä¹ˆç¦»å¼€è¯¥è‡ªæ²»ç³»ç»Ÿï¼ŒåŒæ ·æ˜¯è¾ƒä½å€¼ä¼˜å…ˆã€‚</p></li><li><p>Communityï¼Œä¸»è¦ç”¨äºè·¯ç”±åˆ†ç»„</p></li><li><p>Weightï¼ŒæŸäº›BGPå®ç°å•†çš„ç‰¹æœ‰å±æ€§ï¼Œä¸»è¦ç”¨äºæœ€ä½³è·¯å¾„é€‰æ‹©</p></li></ol><h3 id="å¸¸è§é—®é¢˜-2">å¸¸è§é—®é¢˜</h3><ol><li><p>è¯´åˆ°BGPï¼Œäº†è§£è¿è¥å•†çš„å•çº¿æˆ–å¤šçº¿å¤„ç†å—</p><p>ä¸»è¦æ˜¯ä¸€ä¸ªç½‘ç»œçš„ISPæ¥å…¥æƒ…å†µï¼Œå•çº¿æŒ‡çš„æ˜¯ä¸€ä¸ªç½‘ç»œåªä½¿ç”¨ä¸€æ¡çº¿è·¯æˆ–ä¸€ä¸ªISPæˆªå›¾ï¼Œç®€å•ç›´æ¥ï¼Œä½†æ˜¯ä¼šå‡ºç°å•ç‚¹æ•…éšœé—®é¢˜ã€‚</p><p>å¤šçº¿å¤„ç†ä¹Ÿè¢«ç§°ä¸ºBGPå¤šå®¿ä¸»ï¼ŒæŒ‡çš„æ˜¯é€šè¿‡å¤šä¸ªISPæ¥å…¥äº’è”ç½‘å“ªè¿‡ï¼Œé€šè¿‡BGPæ¥ç®¡ç†ä¼˜åŒ–è¿™äº›è¿æ¥ã€‚</p><p>å¤šä¸ªISPæ¯ä¸ªéœ€è¦æœ‰ç‹¬ç«‹çš„ASå·ï¼Œæ¯ä¸ªISPä¹‹é—´éœ€è¦å»ºç«‹eBGPå¯¹ç­‰ä½“å…³ç³»ï¼Œé…ç½®å‡ºå£ç­–ç•¥å’Œå…¥å£ç­–ç•¥ç­‰ã€‚</p></li></ol><h2 id="BGPé‚»å±…å»ºç«‹è¿‡ç¨‹">BGPé‚»å±…å»ºç«‹è¿‡ç¨‹</h2><p>è¾“å…¥peer ip as_num as_numæŒ‡ä»¤åä¸€èˆ¬ä¼šæ¥å—è¿™äº›</p><ol><li>å»ºç«‹TCPè¿æ¥ï¼Œé¦–å…ˆè¦åœ¨ä¸¤ä¸ªè·¯ç”±å™¨çš„179ç«¯å£å·ä¸Šå»ºç«‹TCPè¿æ¥ï¼Œå»ºç«‹æˆåŠŸä¹‹åå¯ä»¥åˆå§‹åŒ–BGPå¯¹è¯</li><li>äº¤æ¢Openæ¶ˆæ¯ï¼Œä¸»è¦åŒ…æ‹¬åŒæ–¹çš„ASå·ï¼Œä¿æŒæ—¶é—´ï¼ŒBGPæ ‡è¯†ç¬¦ï¼ˆé€šå¸¸æ˜¯IPåœ°å€ï¼‰</li><li>å‚æ•°åå•†ï¼Œä¸»è¦æ˜¯åˆ¤æ–­Openæ¶ˆæ¯çš„å‚æ•°æ˜¯å¦æ­£ç¡®ï¼Œæ­£ç¡®å°±è¿›å…¥EstablishedçŠ¶æ€</li><li>EstablishedçŠ¶æ€è¦å®šæœŸå‘é€Keepaliveæ¶ˆæ¯æ¥ä¿æ´»</li><li>ç„¶åå°±å¯ä»¥å‘é€Updateæ¶ˆæ¯äº†</li></ol>]]></content>
    
    
    <summary type="html">è®©æˆ‘ä»¬æ¥å›å¿†ä¸€ä¸‹BGPéƒ½æœ‰å“ªäº›å†…å®¹å§ï¼</summary>
    
    
    
    <category term="é¢è¯•" scheme="https://www.karlyn.xyz/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="é¡¹ç›®ä»‹ç»" scheme="https://www.karlyn.xyz/tags/%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/"/>
    
    <category term="å®ä¹ " scheme="https://www.karlyn.xyz/tags/%E5%AE%9E%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>é¡¹ç›®ä»‹ç»</title>
    <link href="https://www.karlyn.xyz/posts/project_introduce.html"/>
    <id>https://www.karlyn.xyz/posts/project_introduce.html</id>
    <published>2025-03-18T11:30:44.000Z</published>
    <updated>2025-03-18T12:41:18.737Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="06b561f5d4d4b33d7e56ad635036990402ec2713029d3295d8376cf46cf02a53">a8b0df52fc69ea18510492bd532eeda59897709f31906e07cd42719165d58a20076af797e96049cbf0fe5aa619a8a7514e4254db6a4d13e596f84f3a74c645f47b2b1f93dc2e6f9c413496fe89cb38abd72057ad5fb77fb9902f07d2efd335a9da90ce965cbd987372f08215338effbef10ed5b89fdc9d1f24a9f8b34e65f894648fe975aaed73bb19bddb943fa375c142143525dafeb27eb0e2e9972463e85e6d0ee39177694db6bc005ca4733f995ae09e6ea2a0833fa50aca4ed9f3d912bcf3d52053619b69064bb721870f9812fc87f515a63053cfdac4882f3421eae8fea5f5d033d17ee766631231adc518013b4322e1a3c4e51bedb48d317d899fc4e9df55295e97988e471f487bfb696c557c12671749dbd729ee86c3809d2e428736fed1634938ef836fb367c41cb0dae33612bf27412a032507d223137e59755755f35769dac05c3536bde4254ee8ea645e4429813be4880a4d62850b0bb5f39a4817b3c75b6f762d752aa8f4d3fdc5dc499227c16a551443fa08ef009f320d09eced941a933744b5cc7df1aef46f965bba5742bf57ce9f359eca871093b3e9f8ac068b8fb188507a246baa153caa0d63a3e96cbdb7ceec075e6c9f03b85d1e221bb9d431bbbcad0ae06bea37af4bc519ac5b4055ab3e01384f0962c7e8e6d7b7b02adf5e23d71ea0ac176b72cc568482f3ac053274bd2b7400d70f2c0962f84fd0a848a84dcbf66dba2e533b99cc8f960402756a048be4084bdfd309e94fb893eade6a49b437218253cea067fa230c5092da05d481ce76de989cfcef88201230a8838bf84f6faed999cfd2fe54f9053170f33fd4b2d2a022e031d5c09dfced661cde6d3b2cb904bd1a61568cec82eda4600c15d3940025fab3c9c98e1db8ec667baf9bb5c6d9a43b3159761b5c61f10c5d9059753312c4f867df15fea8ae82da0e91ed974049a43ac298ad53d99e1932057ec66f8511bbc71e99655784aea0f4a98d12666161e8b4c5878defeae55e98533bb125871f8624fe1faba9f8c95481a8282665d081ced3f978ec2de69898ebeabf2b8e490d0c650940a86bb40c9bdbd17d6c06331936283757feebbc2ad0cb7d59335adaac57c5b747bedc2083255a503b1eb1ce258b2f4861054b3ef7fe366ea4fb3d7a02fd431566150fa3e86f9590ed1ff3292f3dadbd1712ae4e8132f896da19b2f22080c4db1db6d85cd278852291616ae4524285bfbb75c55fe93c07bcea3c341a54781c90c6c4af185ad50d54a6b3d57e9695a3e84d4d8f6fd3c6194fdb368d1e4e3f5461bae8036771d32d1bacc212586b27de2e2b3ffe5a0a20c3701389cafa335b6c430c0cae07660636fbca1771fc2f51bebbbdc47f155d62d0ece66ba6e02ad4225b99f53fbaa5ed7a3e1a2d327dba93e486a81f29dee5d3b10d59dbd76e64d88b0fa9dd9d4216f5b9c049b95deb6fc33d5ca65b2cfadbc16b115512e18222769b7e17b734cae42405fc5397ad4aa3121f8d14a1ddf0ea12d6e0f4b68f0fce8b8c9fd1f73d07a2ff5f56fe97e7d3d6f9fcc26d187cc71c72c746fd3b2c5f82980c6e211a096fdda3635762fda9914be1513706f2739eaf3f18821654ffe3728354f2b491cb1a74651e774d628c3834e192aa6358dd6cc64f83fda4fd01c1e8a7bf4320bb552f478750846948a3b63e2b05e548e15dc25f81a822c2cf5c03ebe1ed2f194bd45bc9494771da29adef8efa3f62ed3972c6338a61c4095682a8086082c8d5ff3af820c3d3a18a8c7993bd2f1a056546b72acb214aa2062c807b09fef4458fd0a05c5600d7ec81d561da2348468dd7852ef2c574705ebdffe01afde810950e50ffc152a20ee6cf4d608c4176fb19a75e9546caeb42230dc76de5c33c36b6273a98a63b4188acef6439b460e10ceb5479b86d5d81166c0d882b6b656de7748bb566a9cb0bb030266ed0e1b5209bf98e9d65dab96f350c00ae6743b8b2db923beef6048e1ed59ae69a8e1f58a1b3f54d24fdb5ca6ca679031373ec677134e669f5581bdab23a50fdddf14e094329a9b226075c27afb6e99393476e4705a6c320951da3b8f02f9a6e4157c1ec386f558dc8c0014927765179212e678996826d91c5da98f366d2e91c585247873ac22046260cec4a99ef641c0c5d946172b1eaf29ffa20d3aa8828a23cbd3a98741461b815d392e3343cb2a63ebd6a6e7133a9496c3bd77d640b3cd2d52aa6e9284f7e026b2e7c5d3bce8a200bccaf909137cad2e9aca61b7dc23a438d2141aef837f3a78c7d202dd703c81fc567e1f9504fdd351726d952424d024c9e276ff661a232cfb2a18d6a8a692ccff8cd235eadd61ee6b414c2bb4025c1d391b4bf6a7ec3715a0f3edf4d0027fb6e69ba1c7782be13030888175324c6b3ee0f0264cb3fb89b52c59c0c1a4b38552cacd8e9c89da53ddd799122e36c2f3c66b873e73cb4dac51c8eb209618b5c9e55a80987e5a01313d63e80eb6bd5f5644c5a9b0f0154fa379add8367553c4a590cefc242018bcd290a54de3b68d7435de3e987c8f38fa8463cb18505906b3c270837cf2d309e15632c3bbd3c312fe2ad132f9913e2a87c3aeb4e7dcc091562442e59b2d7f4538780480f646791b1f7b9815a2c03ab9b797d7a71c0742d52fa46d120c71900f96587157e499c807e8f2721cc9a5f4deabc9c943aa8656c177a457bda879a0f952442d53b0553ec64b4f6e84d3d4af8e870d5397adcec8975e941495de566da3f922bf13465d89a9c4d262a2c02a98aff759dc1e6e193ca105f0bf6be7fcd3aeb9c3bcae74842e2456f8d252d475832c2ad1452bd17eef92bcdf3f76ba10fda2df445dff2766e96730d61a660890bb94da3913ee5147604d07f63edfc95206b59449cc0971981247056a649a07f59c147e0b707d7af4c35c960f413a2e1fdb6f4dce3f2b75429bb03388759e68720bb732ee8c35c583f63eb4425ba22a1f7652b108a44d4bdc5e714f5edbe3a6a6a19580150d701a02147be930c61fee97d69ac0d56ec76bec510dbc43717899fad60b3d57ff30e792145e73744b5226c7fdda157575c5a7eaff28a8df503b9f8fb6fbb73d7b44437d4d7b523f74908c26a733e52c8d343699efaa5a082f6c11e470673223deeded2c2976d4246891dd6187c0911409558e35da1b702fd36aa055cdd0dac6d6cffec3679292ec6103b243a5967fd72a3c62dcab75c9cc6b69dd910997cde82e9b62c43f11e115fe6c39287d3fe5448cde1bcedd4ddda0ae9f5db8bdfeefda995253cb20178f642b9c76ecbc5b9ff075de94683f0467133717073c209f6f1656f70afd2729eb696db5ae08110677de1aae201e35f3f1eb0d62332b763077a0e7521c0f676a39e88e94f55cdd8b17b5454f40dbe904569878d0e8a0fc6a2592f53fad5a9b920f82e2cc4c8c14042faa14c91ab225cf9cfdcaa0f21ab76a836e7993b581bfb0f1486deb4e2b626f2d725f90a67e683de741d1d76f8e5677de44390256fac0c97599f7f61b669de5c8efb28236c421c462e3fcbd6c9678bbb7b03a742da0c8d152630ec5f6a5796dd3ad62621fc46a9a760ade2a92c7f1dfa09f2008ed6dee1032fd4748e5d4bd0dff876b604d49da2dad4e7c08790c20507054882c0e404ca98593e9009f2e4efbaeb81b5e911c42e6f57a81aae82dec2ef603cd5440bd0adff218f0edae8da2c7767625660218c05550add7df58aeb9e29ac9f8d2797a9268d5433aae5633d65d6fc73e8d9c495e28014257da569cd776dc1f9e32c5a37f65a9daf669eea34683956f504a067da3512213439a24d6fa17d6ceb5ec1ce0459a9faddc6fe0ab26070c3f38bbd90c3f24192cac625d7da5ae4d58af5f9ad611def0b8ec141ce86bfae2f8b854cc3d9bfad17d5a4d905ffb054035b6184e85ac92ffb527f4ce0d30dbc9c9efede591b2261c6a0d9c7ddff69693516df2ff52d7dcc53ce724ea2fb96f28f76eecf0df8a0aaebad66c11e5f42657d2d3715ea5c5d3fbe49333568505f8f494592865a22aa8c4c42f704b378cbcfb9acbc91790ebcd2cb2f4f1a84868ae1ec838caf0b241f6d72d790f029004bd0476b365c52b55165b5ae736d76a4984a61c5c16a200c3946d67fe83366ac71a0218a1f5369e631b7e105e4000b2c2c89339356c9c60de767d9d561ba4ec327cbb48dd756c0bfa688b82c8ec8be8ff37fab33e0f2f15b08c465a23061e7a6903f856cc5ab1edb20ede41e3e3e57f81ba20c343a338db9ce72a2a2a30936d4b17f9bfe712a93b5af730a01a21b626fb9ecbe4118c1a61de7c47b77dde7982a5052e7c1da77e6483bc3c6df0c3dbb32872cd31925f134c1c0015278b2386eb801787d3d976e1f0dd84cc16c9e91ba8beaa87e575379cfdfebb3c1ac59e6460f73b698c802209c37063151d6b7a39a906c7d3fc2a40ea62f4c8db17fea7fa162f9e24485248ed02d2e36c1004829344b165380abb8d1db27b510956e5dd075cedf3bf0ee106844833f2450a649a0a14610b361131b3dd8789795f6700680d9aa9b5bc9551d5d03889aacaa68ed1335db95312bcdf1f5caa593ca92f159c43c055f82d045f572c431d6da9d8c0477a89734c87037031ce499d8cfbfb7bfbda58c5372ea44a0c7ecf3b041f9b2e1edf76348e9bc11808dfb707b986cb2a1b73201cfd75e746414c3b8e4035b02fde2f127e0c84813f2588fbd1256d695c5ebc66e0881abfbfa8bee6fed56fa1b61367f03bc716bc75b0884b227201dd0db63c576d86bc88215206e851bc82e338a460df66de1469bbb2cb6c8e724a96940bfa86130fb0cd83492acff5c35e6ade8d0be3f0e27d58e486197ee4f0b1ad26f85fc052e9a554175820b80e709ac3854d34b85be2915d254fe437559ac4a4b54c93e3c0b16e4dab97475e84abe2dd13dd09f4ca37a4b014c57a7e662055a78bc2f5908521814aef22430d18df2ac60276fb0ef53cfb80691b6c1b37085b834f8f6b555c398be97054a8ad250e26c23911ace5b231e560ba6a7bd6c2aad821ed6ac4af9bcd7782bda51da4d2007a0a71c6f0cd0fabcce87f62d4843d66b8d47496e9271741414845b075cb0075a226641a36f8390aceb85a943b8ef879e0593f511d2fd0157b81a16a95e72081794f617db65d8ddc183092ecc7d7e0a38f286f0a19e3e7c9929e92e57bd9e8672af6ed01f1f999df5885540e4995ed0617d3b7a3c15bfb9cbf7303b40be4694816abe2fa153f6c39cc348bba98f554eccae2fc1c0d815aafeda9fa005624af14984d3eb3b38d041b3859f6eeb96e7c8da81aa93cfee03fbf504c74ecbe89b1c2e5db74901eab045ac9940d921a9fefc5530e3f6b3983335bf2906aa974645ac23ba93f0b865924fae98ea67a09ce1120c348361563e3af8424fa5c861ecc5af863f3fc4181133202571e3b3aabcad8813e6c1aaece85f23fb0e1aabd08f9c04acfc866c5ba1c70d1c27ea2d2e4e199d14eb83a2891a6c09d8c0e1e41556bb8b4b9a9df16b86fdd71d25e3d205a4a4f098f5434c8c3707555d5c893f4a7d7a55c2fb8c48eabf3c884c0003e57fe53d7c0ec59b93cf2773079d70a24284d5918654ac4d5772e974f5d36bc03286c8a30d081fe85fca7b87056f09023d2d6dae806dc0bf2650e00a68f220f431f249fb5d783b89129579456bcc614a391348b5b5c7968d55db6bcd44ea8c76c941bb6f1dc8ac89dd0b153cd9b1a862f8e64c7da308c5bfb3dd9b82bdb53a9c854fb2f15cfbb3404e5cc38dc274aee3e8dedae5bd7b1bc3f7c9325058ba86d0e8413fb4c3e39ffbc0ba11c3bddc931afb4f6f7ae37a03d7aad12617d0eb21edd08547d426698c5288100b214198ceec2a8729894187a073f6e5195efa38f115a7f0b529277dfad1c8f1712f7dc3e22b9172d84650983a03277571c5a50d4cb75576908dd4956497d30889c4bc2420cc7607ffa8f1f05bbaf796310455834c6edb049633e3aa5679e653e084c29847fe066e3cf80a51a71749e16d25eb50c256361c57a5ffb63a8e5a396907c2ff8f434ed2219c4912bf0ddbb26bab37776e99df1fa9968cba24cf1c71528e6efce2944277780b108710aa0ade77f403b536ce3f347057fa7ee7f6b9f4e43fd9dc33db37662622c2085feec5fbeb8543aded1507c06d0c6f80eae27a68a9468f6b49c3b7b5cf5a4889715be876f601ac7baaf283649a6222aa9c2b913bdb96ea80e2616bfb89514c1e3d64f6751ee45f619c4f3c4d98c5d77247b94a2ced8837e92dd8cbe54f18cb2ef0241f2be3d65331b306056a0c248682b4ca0eaeb37cccd4b3b40d6683895519b3aef415ca4a88d7fea256e77a3f55381166ee307e992bf31c35cee8ff3707294d0eb6f7bc13bf902eb5686f122ab4b699a0dc322e05e379ea9e86b0fa4a805ecd45872c472f96275d8b1507e452f68f86f68f6334489aca445811abc2e41b82a585586d082e3efcd75bd40f7432ee94fe9ea503d6378950dad5c8c60028d36149218c84479f80bc5c806f714e894341c298e2a8d29b442e0c686861c98e7de88e39cb548d834d80f756fd2f28ce9454f5d43eb8d2817d9e5d97f14916d621096e2ffa7b4cab14f553f682d191f61c62b039b91fe4f2e153e1a9f8b34135247fc4811ce74ffe0fb4170b5aa99d1a70577c1d32c3e0374936ef80f2a1a3d782e04c35f620c2e9b72843691fe69530d9ba2d194a3c06fd11d367f7eff7e48240133b537e7e55438ccf51b9559304ac6fee1fc7991908f7d6813a7e711227c93c55396423b9817ef0a218a3628887c68bc9f2b976034b4d98984d042aa4431ceb31f13e12f1dfa020459606be1332b96a6cf3a5aaa0a37842c7a62330e9ca949f2c04e58eb9e5a4b4a1df39af00979c6039d60bef376b47fb1b475859aa93df4b58a49c0580817e8554100c87720d253ebf69c5919869955a06c2dba4da957992fc2ec2e8387e07c8d5aa416f5975e1e0bcfc36f5c188396dfb7c13813225ecffc5717d4eab411645361ad8cbe9229b98e2e683b0597c81c9014febbf94c2da38e56461a4b476f5def2b17bc563553f9143a7c404ba97e4309466b73cc60160eb873b9b50331ec574c212ec94ca02554f35f5bef5d2023a27f129fae2bfc9b287f1063d98e0258dd6bf29d7738264ac08e0f4815d83f4a34d544158975662733913b10302e6af26bb9e94df5404f4d7ec040a341e0f792b60a587be46b45ddf12f64adba4ae1cafaf3d23713cfc5363ce1f9c40b9f12a67ee9f032b6103b01fe541afe709379bd70e213f1cb0918f5249c978a97113ed3ef69a29893d48bc3a2f6d95cccbdadd092475477c26052d31720fee49d5fdbc661cbffb08ca211641ad396f0fb1ed487d1dc44c9dbbb52df652a236ea9fc373c54840a5bb090b505c8fbb306deee971b13e8177eaaef487df755c3f02684804941ca4151e88179711f0e2a4530a7a56fe1de1be460092f37794a2b74b2e9285acddf986bbe758ae1edfd97c58d1b2e04eb7bccc3230d0fb77b541e958a7fc74df2c7071a1a4dc085290227d011ba4df2efcfb6a4f4cd1ce49b194ffe57b5df775165a3ceccbc452b815b0601e73a1b42f2281066216148af315481583a3edd3f159de48b012cf3079c5ae609a3d8a3d2608dfbd42d7f8ec3621128965af753ad4f8a9d6368c921da198c5bdc11f5f7961f73276464d2449d498bd9aa8f1b6b4a31a0168831aa22f0d9aa3c3f9948748012a149ee902ed9089575345d691cf689d77035e0df2089eb878dd4ee3f672c6ca18e534aa73c2d9fdae366b7e774178e36c8b4e5b7bdb137c96386da6ec3e8e968c300f71f2035ef55cebce9e2a0a6c96aa113e12c9cb149d9b30493cd90d45f755e6ee3606c82375eca06ac4419685d5ea94108aa7b4086f4de389cda97e50ee3914272821cda39f80e1463f9fdcc6cda974c6d581cb6213aa5a13e32e164ad5122f12ae83dea6f974a310d614d121f9045ba9b8fe290994427f63e752eb33dcb8b8019325051cd06f1926842a8a5043d85666054a774c63d47c06ed7898b7b337e330b7229f5905dc2028a9654a2c1b6dde521c0df960f6198ad6439ecfe7925f5572e8324788d5d28746fe8a5be7fe4188723178e747f7a6f520d6bcf3b024a7ebb13fa1aaea237ee613ab7c3c53c62c050fcee6b6b6dbf31eeafc53b725afc13d37e8ee8788901e04b3f5</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-xray">      <input class="hbe hbe-input-field hbe-input-field-xray" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-xray" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-xray">Hey, password is required here.</span>      </label>      <svg class="hbe hbe-graphic hbe-graphic-xray" width="300%" height="100%" viewBox="0 0 1200 60" preserveAspectRatio="none">        <path d="M0,56.5c0,0,298.666,0,399.333,0C448.336,56.5,513.994,46,597,46c77.327,0,135,10.5,200.999,10.5c95.996,0,402.001,0,402.001,0"></path>        <path d="M0,2.5c0,0,298.666,0,399.333,0C448.336,2.5,513.994,13,597,13c77.327,0,135-10.5,200.999-10.5c95.996,0,402.001,0,402.001,0"></path>      </svg>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">ä¸»è¦æ˜¯æ•´ç†ä¸€ä¸‹æ€ä¹ˆä»‹ç»æˆ‘çš„ä¸€äº›é¡¹ç›®</summary>
    
    
    
    <category term="é¢è¯•" scheme="https://www.karlyn.xyz/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="é¡¹ç›®ä»‹ç»" scheme="https://www.karlyn.xyz/tags/%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/"/>
    
    <category term="Java" scheme="https://www.karlyn.xyz/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Kä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨</title>
    <link href="https://www.karlyn.xyz/posts/reverse-nodes-in-k-group.html"/>
    <id>https://www.karlyn.xyz/posts/reverse-nodes-in-k-group.html</id>
    <published>2025-03-18T08:42:03.000Z</published>
    <updated>2025-03-18T08:42:03.000Z</updated>
    
    <content type="html"><![CDATA[<h1>Kä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨</h1><p><a href="https://leetcode.cn/problems/reverse-nodes-in-k-group/description/?envType=study-plan-v2&amp;envId=top-100-liked">LeetCodeåŸé¢˜é“¾æ¥</a></p><h2 id="é¢˜ç›®æè¿°">é¢˜ç›®æè¿°</h2><p>ç»™ä½ é“¾è¡¨çš„å¤´èŠ‚ç‚¹ <code>head</code> ï¼Œæ¯ <code>k</code> ä¸ªèŠ‚ç‚¹ä¸€ç»„è¿›è¡Œç¿»è½¬ï¼Œè¯·ä½ è¿”å›ä¿®æ”¹åçš„é“¾è¡¨ã€‚</p><p><code>k</code> æ˜¯ä¸€ä¸ªæ­£æ•´æ•°ï¼Œå®ƒçš„å€¼å°äºæˆ–ç­‰äºé“¾è¡¨çš„é•¿åº¦ã€‚å¦‚æœèŠ‚ç‚¹æ€»æ•°ä¸æ˜¯ <code>k</code> çš„æ•´æ•°å€ï¼Œé‚£ä¹ˆè¯·å°†æœ€åå‰©ä½™çš„èŠ‚ç‚¹ä¿æŒåŸæœ‰é¡ºåºã€‚</p><p>ä½ ä¸èƒ½åªæ˜¯å•çº¯çš„æ”¹å˜èŠ‚ç‚¹å†…éƒ¨çš„å€¼ï¼Œè€Œæ˜¯éœ€è¦å®é™…è¿›è¡ŒèŠ‚ç‚¹äº¤æ¢ã€‚</p><p><strong>ç¤ºä¾‹1</strong></p><p><img src="https://assets.leetcode.com/uploads/2020/10/03/reverse_ex1.jpg" alt="ç¤ºä¾‹1"></p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šhead = <span class="string">[1,2,3,4,5]</span>, k = <span class="number">2</span></span><br><span class="line">è¾“å‡ºï¼š<span class="string">[2,1,4,3,5]</span></span><br></pre></td></tr></table></figure><p><strong>ç¤ºä¾‹2</strong></p><p><img src="https://assets.leetcode.com/uploads/2020/10/03/reverse_ex2.jpg" alt="ç¤ºä¾‹2"></p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šhead = <span class="string">[1,2,3,4,5]</span>, k = <span class="number">3</span></span><br><span class="line">è¾“å‡ºï¼š<span class="string">[3,2,1,4,5]</span></span><br></pre></td></tr></table></figure><p><strong>æç¤ºï¼š</strong></p><ul><li>é“¾è¡¨ä¸­çš„èŠ‚ç‚¹æ•°ç›®ä¸º <code>n</code></li><li><code>1 &lt;= k &lt;= n &lt;= 5000</code></li><li><code>0 &lt;= Node.val &lt;= 1000</code></li></ul><p>**è¿›é˜¶ï¼š**ä½ å¯ä»¥è®¾è®¡ä¸€ä¸ªåªç”¨ <code>O(1)</code> é¢å¤–å†…å­˜ç©ºé—´çš„ç®—æ³•è§£å†³æ­¤é—®é¢˜å—ï¼Ÿ</p><h2 id="é¢˜ç›®åˆ†æ">é¢˜ç›®åˆ†æ</h2><p>è¿™é¢˜éš¾åº¦è¢«åˆ’å½’ä¸ºå›°éš¾ï¼Œå…¶å®æ˜¾ç„¶æ˜¯ä¸èƒ½è¾¾åˆ°å›°éš¾é¢˜çš„éš¾åº¦çš„ï¼Œåªä¸è¿‡å¦‚æœä¸ä¹ æƒ¯å°è£…ç¼–ç¨‹ï¼Œå•ç‹¬å°†åè½¬é“¾è¡¨çš„æ–¹æ³•å•ç‹¬å†™çš„è¯å¯èƒ½ä¼šæœ‰ä¸€äº›è¾¹ç•Œç±»å‹çš„é—®é¢˜å‡ºç°ã€‚ä¸è¿‡æåˆ°äº†éœ€è¦ä½¿ç”¨ <code>O(1)</code> é¢å¤–å†…å­˜ç©ºé—´ï¼Œå‰ç½®é¢˜ç›®ä¸ºåè½¬é“¾è¡¨ï¼Œé¢˜ç›®é“¾æ¥ä¸ºï¼š<a href="https://leetcode.cn/problems/reverse-linked-list/description/?envType=study-plan-v2&amp;envId=top-100-liked">åè½¬é“¾è¡¨</a>ï¼Œåªä¸è¿‡åè½¬é“¾è¡¨æåˆ°å¯ä»¥ä½¿ç”¨é€’å½’æˆ–è€…è¿­ä»£çš„æ–¹å¼ï¼Œä½†æ˜¯é€’å½’çš„æ–¹å¼æ˜¾ç„¶éœ€è¦ä½¿ç”¨ç³»ç»Ÿæ ˆï¼Œæ— æ³•å®ç°é¢å¤–å†…å­˜ç©ºé—´éœ€æ±‚ï¼Œæ‰€ä»¥è¿™é¢˜å‡ ä¹å·²ç»é”å®šä½¿ç”¨è¿­ä»£çš„æ–¹å¼è¿›è¡Œåè½¬ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬å…ˆå°è¯•åšä¸€ä¸‹åè½¬é“¾è¡¨è¿™é“é¢˜ç›®</p><h3 id="åè½¬é“¾è¡¨">åè½¬é“¾è¡¨</h3><p>ç»™ä½ å•é“¾è¡¨çš„å¤´èŠ‚ç‚¹ <code>head</code> ï¼Œè¯·ä½ åè½¬é“¾è¡¨ï¼Œå¹¶è¿”å›åè½¬åçš„é“¾è¡¨ã€‚</p><p><img src="https://assets.leetcode.com/uploads/2021/02/19/rev1ex1.jpg" alt="ç¤ºä¾‹1"></p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šhead = <span class="string">[1,2,3,4,5]</span></span><br><span class="line">è¾“å‡ºï¼š<span class="string">[5,4,3,2,1]</span></span><br></pre></td></tr></table></figure><p>å®˜æ–¹å®šä¹‰çš„é“¾è¡¨ç»“æ„è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæ²¡æœ‰è¦ç”¨æˆ·è‡ªå·±å®šä¹‰é“¾è¡¨ï¼Œæœ‰äº›ä¼ä¸šçš„é¢è¯•é¢˜æ˜¯éœ€è¦è‡ªå·±å®šä¹‰çš„å˜›ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿç®€å•è‡ªå·±å®šä¹‰ä¸€ä¸‹ï¼Œé˜²æ‚£æœªç„¶äº†å±äºæ˜¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*å®šä¹‰é“¾è¡¨</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ListNode</span>&#123;</span><br><span class="line"><span class="type">int</span> val;</span><br><span class="line">ListNode next;</span><br><span class="line"><span class="comment">//ç©ºå‚æ„é€ æ–¹æ³•</span></span><br><span class="line">ListNode()&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">ListNode(<span class="type">int</span> val)&#123;</span><br><span class="line"><span class="built_in">this</span>.val=val;</span><br><span class="line">&#125;</span><br><span class="line">ListNode(<span class="type">int</span> val,ListNode next)&#123;</span><br><span class="line"><span class="built_in">this</span>.val=val;</span><br><span class="line"><span class="built_in">this</span>.next=next;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å®ç°ä»»åŠ¡ä¹‹å‰ï¼Œå…ˆç®€å•å®ç°ä¸€ä¸ªè¾“å…¥è·å–å’Œç»“æœæ‰“å°çš„æ–¹æ³•ï¼Œä¾¿äºæœ¬åœ°è‡ªè¡Œæµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ListNode <span class="title function_">readDate</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">    String[] vals = sc.nextLine().replaceAll(<span class="string">&quot;^\\[*|\\]*$&quot;</span>, <span class="string">&quot;&quot;</span>).split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">    <span class="type">ListNode</span> <span class="variable">head</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListNode</span>();</span><br><span class="line">    <span class="type">ListNode</span> <span class="variable">pre</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="keyword">for</span>(String val:vals)&#123;</span><br><span class="line">        pre.next = <span class="keyword">new</span> <span class="title class_">ListNode</span>(Integer.valueOf(val));</span><br><span class="line">        pre = pre.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> head.next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printListNode</span><span class="params">(ListNode head)</span>&#123;</span><br><span class="line">    <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">null</span> != head)&#123;</span><br><span class="line">        sb.append(head.val).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        head = head.next;</span><br><span class="line">    &#125;</span><br><span class="line">    sb.deleteCharAt(sb.length()-<span class="number">1</span>);</span><br><span class="line">    System.out.println(sb.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯æ­£å¸¸å®ç°äº†ï¼Œæˆ‘ä»¬åˆ†ä¸ºä¸¤ç§æ–¹å¼å®ç°å§ï¼Œé¦–å…ˆæ˜¯æ¯”è¾ƒç®€å•çš„é€’å½’çš„æ–¹å¼å®ç°ï¼Œé€’å½’çš„æ–¹å¼å°±æ˜¯ä¸æ–­æŠŠååŠæ®µåè½¬ç„¶åä½œä¸ºå‰åŠæ®µçš„å¤´éƒ¨åˆ†ã€‚</p><p>æˆ‘çš„ä»£ç å¯èƒ½æœ‰ä¸€ç‚¹å”æ°ï¼Œè®²å¾—ä¹Ÿæ²¡æœ‰å®˜æ–¹çš„å¥½ï¼Œæ‰€ä»¥æˆ‘è´´åœ¨è¿™é‡Œï¼Œç®€å•ä»‹ç»ä¸€ä¸‹ï¼Œä¸€äº›æ³¨é‡ŠåŸºæœ¬ä»£è¡¨äº†æˆ‘çš„æƒ³æ³•ï¼Œéœ€è¦æ³¨æ„çš„åªæœ‰ä¸€ç‚¹ï¼Œå°±æ˜¯éœ€è¦å…ˆç¿»è½¬åé¢çš„èŠ‚ç‚¹ï¼Œç„¶åå†å’Œå‰é¢çš„èŠ‚ç‚¹æ‹¼æ¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åè½¬é“¾è¡¨çš„é€’å½’å®ç°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> head åé¢éœ€è¦åè½¬çš„é“¾è¡¨çš„å¤´èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pre å·²ç»å®Œæˆåè½¬çš„å‰åŠéƒ¨åˆ†çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> åè½¬å®Œä¹‹åé“¾è¡¨çš„å¤´èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ListNode <span class="title function_">reverseListDFS</span><span class="params">(ListNode head,ListNode pre)</span>&#123;</span><br><span class="line">  <span class="comment">//åˆ¤ç©º</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == head) <span class="keyword">return</span> head;</span><br><span class="line">    <span class="comment">//å®šä¹‰é€’å½’ç»ˆç‚¹ï¼Œä¹Ÿå°±æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œç›´æ¥æŠŠå®ƒå’Œå®ƒå‰é¢çš„é‚£ä¸ªèŠ‚ç‚¹æ‹¼èµ·æ¥ç„¶åè¿”å›</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == head.next)&#123;</span><br><span class="line">      head.next=pre;</span><br><span class="line">      <span class="keyword">return</span> head;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//å¦‚æœä¸æ˜¯é€’å½’ç»ˆç‚¹ï¼Œè¿™éƒ¨åˆ†å°±éœ€è¦ç†è§£ä¸€ä¸‹</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//é¦–å…ˆæ˜¯å°†åé¢éƒ¨åˆ†ç¿»è½¬ï¼</span></span><br><span class="line">        <span class="type">ListNode</span> <span class="variable">res</span> <span class="operator">=</span> reverseListDFS(head.next, head);</span><br><span class="line">      <span class="comment">//ç„¶åå°†æ”¹èŠ‚ç‚¹çš„nextæ”¹ä¸ºpreï¼Œæ‹¼æ¥èµ·æ¥ï¼Œé¡ºåºä¸€å®šä¸èƒ½é”™</span></span><br><span class="line">        head.next = pre;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> ListNode <span class="title function_">reverseList</span><span class="params">(ListNode head)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> reverseListDFS(head,<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åè®©æˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹è¿­ä»£çš„æ–¹å¼ï¼Œè¿­ä»£ä¸»è¦è¿˜æ˜¯åŒæŒ‡é’ˆçš„æ€è·¯ï¼Œå…¶å®ç›¸å¯¹è€Œè¨€æ€è·¯æ¯”é€’å½’æ›´å®¹æ˜“ç†è§£ä¸€äº›ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åè½¬é“¾è¡¨è¿­ä»£å®ç°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> head å¤´æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> åè½¬å®Œä¹‹åé“¾è¡¨çš„å¤´èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ListNode <span class="title function_">reverseListIter</span><span class="params">(ListNode head)</span> &#123;</span><br><span class="line">    <span class="comment">//åˆ¤ç©º</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == head) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">//å®šä¹‰åŒæŒ‡é’ˆï¼Œè¿™ä¸ªå®šä¹‰æ˜¯æœ‰æŠ€å·§çš„ï¼Œå› ä¸ºå¤´èŠ‚ç‚¹çš„nextè¦æ˜¯null</span></span><br><span class="line">    <span class="type">ListNode</span> <span class="variable">lst</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">ListNode</span> <span class="variable">pre</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="comment">//ä¾æ¬¡è®¾ç½®å‰æŒ‡é’ˆçš„nextä¸ºåæŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">null</span> != pre)&#123;</span><br><span class="line">        ListNode tmp=pre.next;</span><br><span class="line">        pre.next = lst;</span><br><span class="line">        lst = pre;</span><br><span class="line">        pre = tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å½“å‰æŒ‡é’ˆä¸ºç©ºæ—¶ï¼ŒåæŒ‡é’ˆæ‰€æŒ‡ç€çš„ä½ç½®å°±æ˜¯æœ€åä¸€ä¸ªNodeï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„head</span></span><br><span class="line">    <span class="keyword">return</span> lst;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååè½¬é“¾è¡¨éƒ¨åˆ†æˆ‘ä»¬å°±åŸºæœ¬è®²å®Œäº†ï¼Œä½†æ˜¯è¿­ä»£è¿™ä¸ªéƒ¨åˆ†çš„ä»£ç åœ¨åé¢æˆ‘ä»¬è¿˜éœ€è¦è¿›è¡Œä¸€ç‚¹å°å°çš„ä¿®æ”¹ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Œå› ä¸ºKä¸ªä¸€ç»„åè½¬é“¾è¡¨ï¼Œé“¾è¡¨çš„ç»ˆç‚¹ä¸æ˜¯nullï¼Œè€Œæ˜¯æˆ‘ä»¬éœ€è¦çš„ç»ˆç‚¹æ˜¯ç¬¬Kä¸ªèŠ‚ç‚¹ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯Kä¸ªä¸€ç»„åè½¬é“¾è¡¨çš„ä»»åŠ¡ï¼Œç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠä»»åŠ¡æ‹†æˆKä¸ªåè½¬é“¾è¡¨çš„å­ä»»åŠ¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">reverseSubList</span><span class="params">(ListNode head, ListNode last)</span> &#123;</span><br><span class="line">    <span class="comment">//åˆ¤ç©º</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == head) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">//å®šä¹‰åŒæŒ‡é’ˆ</span></span><br><span class="line">    <span class="type">ListNode</span> <span class="variable">lst</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">ListNode</span> <span class="variable">pre</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="comment">//ä¾æ¬¡è®¾ç½®å‰æŒ‡é’ˆçš„nextä¸ºåæŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">while</span>(last != lst)&#123;</span><br><span class="line">        <span class="type">ListNode</span> <span class="variable">tmp</span> <span class="operator">=</span> pre.next;</span><br><span class="line">        pre.next = lst;</span><br><span class="line">        lst = pre;</span><br><span class="line">        pre = tmp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> ListNode <span class="title function_">reverseKGroup</span><span class="params">(ListNode head, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">    <span class="comment">//å½“k=1çš„æ—¶å€™ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">1</span> == k) <span class="keyword">return</span> head;</span><br><span class="line">    <span class="comment">//ä¸ºäº†ç»Ÿä¸€ä»¥åŠä¾¿äºæ‰¾åˆ°å¤´ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªä¼ªå¤´éƒ¨ï¼Œå…¶å®è¿™æ˜¯å¾ˆå¸¸ç”¨çš„æ–¹æ³•</span></span><br><span class="line">    <span class="type">ListNode</span> <span class="variable">fake_head</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListNode</span>();</span><br><span class="line">    fake_head.next=head;</span><br><span class="line">    <span class="comment">//å¦‚æœkä¸ç­‰äº1ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±éœ€è¦å®šä¹‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹æ‰€éœ€è¦åšçš„äº‹æƒ…å°±æ˜¯æ‰¾åˆ°æ¯ç»„çš„ç¬¬Kä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">ListNode</span> <span class="variable">findK</span> <span class="operator">=</span> fake_head;</span><br><span class="line">    <span class="type">ListNode</span> <span class="variable">lst_one</span> <span class="operator">=</span> fake_head;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//è¿™é‡Œåªéœ€è¦åˆ¤æ–­findKæ˜¯ä¸æ˜¯ç©ºï¼Œå› ä¸ºå®ƒä¸€ç›´èµ°åœ¨å…¶ä½™ä¸¤ä¸ªäº¤æ¢ä½ç½®çš„æŒ‡é’ˆçš„å‰é¢</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">null</span>!=findK)&#123;</span><br><span class="line">        <span class="comment">//å¦‚æœä¸æ˜¯ç¬¬Kä¸ªï¼Œç›´æ¥åç§»ï¼Œä¸åšå¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span>(count!=k)&#123;</span><br><span class="line">            count++;</span><br><span class="line">            findK=findK.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯ç¬¬Kä¸ª</span></span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//é‡ç½®å¯»æ‰¾å¾ªç¯</span></span><br><span class="line">            count=<span class="number">0</span>;</span><br><span class="line">            <span class="comment">//é¦–å…ˆæ˜¯è·å¾—å­æ®µçš„å¤´ï¼Œå­æ®µçš„å°¾å°±æ˜¯findK</span></span><br><span class="line">            ListNode child_head=lst_one.next;</span><br><span class="line">            ListNode K_next=findK.next;</span><br><span class="line">            <span class="comment">//ç„¶åè¿›è¡Œå­æ®µåè½¬ï¼Œè¿™é‡Œä¼šæŠŠå®ƒçš„å¤´å°¾éƒ½æ–­å¼€ï¼Œæ‰€ä»¥ä¹‹åå°±éœ€è¦é‡æ–°æ‹¼æ¥</span></span><br><span class="line">            reverseSubList(child_head,findK);</span><br><span class="line">            <span class="comment">//ç„¶åå°†å‰é¢çš„å­æ®µå’Œå°¾èŠ‚ç‚¹æ‹¼æ¥</span></span><br><span class="line">            lst_one.next=findK;</span><br><span class="line">            <span class="comment">//å°†å¤´èŠ‚ç‚¹å’Œåé¢çš„èŠ‚ç‚¹æ‹¼æ¥</span></span><br><span class="line">            child_head.next=K_next;</span><br><span class="line">            <span class="comment">//é‡ç½®last_oneå’ŒfindK</span></span><br><span class="line">            lst_one = child_head;</span><br><span class="line">            findK = child_head;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fake_head.next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘åªèƒ½è¯´ï¼Œå¾ˆä¼˜é›…ï¼Œä½†æ˜¯è¿˜æ˜¯å»ºè®®å¤§å®¶çœ‹çœ‹å®˜è§£ï¼Œæˆ‘å†™çš„å¾ˆç®€é™‹ã€‚</p>]]></content>
    
    
    <summary type="html">çœ‹æ‡‚è¿™ç¯‡ï¼Œåè½¬é“¾è¡¨ç³»åˆ—å°±éƒ½èƒ½çœ‹æ‡‚å•¦ï¼</summary>
    
    
    
    <category term="åˆ·é¢˜" scheme="https://www.karlyn.xyz/categories/%E5%88%B7%E9%A2%98/"/>
    
    
    <category term="Java" scheme="https://www.karlyn.xyz/tags/Java/"/>
    
    <category term="Hot100" scheme="https://www.karlyn.xyz/tags/Hot100/"/>
    
  </entry>
  
</feed>
